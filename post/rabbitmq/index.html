<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='RabbitMQ介绍和使用'>
<title>RabbitMQ</title>

<link rel='canonical' href='https://cheneycqg.github.io/post/rabbitmq/'>

<link rel="stylesheet" href="/scss/style.min.83fdf04f357d6c514ee15e600463b045549e8b40c428f14454adecaa742b352f.css"><meta property='og:title' content='RabbitMQ'>
<meta property='og:description' content='RabbitMQ介绍和使用'>
<meta property='og:url' content='https://cheneycqg.github.io/post/rabbitmq/'>
<meta property='og:site_name' content='Cheney Site'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='RabbitMQ' /><meta property='article:tag' content='中间件' /><meta property='article:published_time' content='2023-09-08T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2023-09-08T00:00:00&#43;00:00'/><meta property='og:image' content='https://cheneycqg.github.io/post/rabbitmq/1.jpg' />
<meta name="twitter:title" content="RabbitMQ">
<meta name="twitter:description" content="RabbitMQ介绍和使用"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://cheneycqg.github.io/post/rabbitmq/1.jpg' />
    <link rel="shortcut icon" href="/img/avatar.jpg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu8558358a36cd5b5f5be6e79535866837_28999_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Cheney Site</a></h1>
            <h2 class="site-description">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://cheneycqg.github.io/zh-cn/" >中文</option>
                        
                            <option value="https://cheneycqg.github.io/ar/" >عربي</option>
                        
                            <option value="https://cheneycqg.github.io/" selected></option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#rabbitmq">RabbitMQ</a></li>
    <li><a href="#一-mq介绍">一 MQ介绍</a>
      <ul>
        <li><a href="#1什么是mq">1.什么是MQ</a></li>
      </ul>
    </li>
    <li><a href="#2mq的作用">2.MQ的作用</a>
      <ul>
        <li><a href="#21-流量消峰">2.1 流量==消峰==</a></li>
        <li><a href="#22-应用解耦">2.2 应用==解耦==</a></li>
        <li><a href="#23-异步提升效率">2.3 ==异步==提升效率</a></li>
      </ul>
    </li>
    <li><a href="#3mq的分类">3.MQ的分类</a></li>
    <li><a href="#4mq的选择">4.MQ的选择</a></li>
    <li><a href="#二rabbitmq的基本架构">二.RabbitMQ的基本架构</a>
      <ul>
        <li><a href="#1四大核心概念类似于快递站">1.四大核心概念[类似于快递站]</a></li>
        <li><a href="#2rabbitmq架构">2.RabbitMQ架构</a></li>
        <li><a href="#3安装rabbit">3.安装Rabbit</a></li>
        <li><a href="#5再次利用-admin-用户登录">5.再次利用 admin 用户登录</a></li>
        <li><a href="#6重置命令">6.重置命令</a></li>
      </ul>
    </li>
    <li><a href="#三rabbitmq入门">三.RabbitMQ入门</a>
      <ul>
        <li><a href="#31-环境准备">3.1 环境准备</a></li>
        <li><a href="#32-消息生产者">3.2 消息生产者</a></li>
        <li><a href="#33-消息消费者">3.3 消息消费者</a></li>
        <li><a href="#34-消息应答面试题如何保证消费者消息不丢失">==3.4 消息应答(面试题:如何保证消费者消息不丢失)==</a></li>
        <li><a href="#35-消息自动重新入队">3.5 消息自动重新入队</a></li>
        <li><a href="#36-消息手动应答代码">3.6 消息手动应答代码</a></li>
        <li><a href="#37-rabbitmq-持久化">3.7 RabbitMQ 持久化</a></li>
        <li><a href="#38-生产者消息发布确认">3.8 生产者消息发布确认</a></li>
        <li><a href="#39--交换机">3.9  交换机</a></li>
      </ul>
    </li>
    <li><a href="#四-rabbitmq其他">四 RabbitMQ其他</a>
      <ul>
        <li><a href="#41-死信的概念">4.1 死信的概念</a></li>
        <li><a href="#42-延迟队列正常交换机ttl模拟出来的">4.2 延迟队列(正常交换机+TTL模拟出来的)</a></li>
        <li><a href="#43-整合-springboot">4.3 整合 springboot</a></li>
        <li><a href="#44-幂等性">4.4 幂等性</a></li>
      </ul>
    </li>
    <li><a href="#五-rabbitmq-集群">五 RabbitMQ 集群</a>
      <ul>
        <li><a href="#51-使用集群的原因">5.1 使用集群的原因</a></li>
        <li><a href="#52-普通集群搭建步骤">5.2 普通集群搭建步骤</a></li>
        <li><a href="#53-搭建镜像集群">5.3 搭建镜像集群</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/post/rabbitmq/">
                <img src="/post/rabbitmq/1_hu66dae819074df657122ccf810f7b95ce_166227_800x0_resize_q75_box.jpg"
                        srcset="/post/rabbitmq/1_hu66dae819074df657122ccf810f7b95ce_166227_800x0_resize_q75_box.jpg 800w, /post/rabbitmq/1_hu66dae819074df657122ccf810f7b95ce_166227_1600x0_resize_q75_box.jpg 1600w"
                        width="800" 
                        height="340" 
                        loading="lazy"
                        alt="Featured image of post RabbitMQ" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/rabbitmq/" >
                RabbitMQ
            </a>
        
            <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" >
                中间件
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/rabbitmq/">RabbitMQ</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            RabbitMQ介绍和使用
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 08, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    11 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>RabbitMQ介绍和使用</p>
<h2 id="rabbitmq">RabbitMQ</h2>
<h2 id="一-mq介绍">一 MQ介绍</h2>
<h3 id="1什么是mq">1.什么是MQ</h3>
<p>MQ(message queue)，从字面意思上看，本质是个队列，FIFO  先入先出，只不过队列中存放的内容是 message 而已，还是一种跨进程的通信机制，用于上下游传递消息。在互联网架构中，MQ 是一种非常常  见的上下游「逻辑解耦 + 物理解耦」的消息通信服务。使用了 MQ 之后，消息发送上游只需要依赖 MQ，不用依赖其他服务。</p>
<p><img src="/post/rabbitmq/assets/1682473534176.png"
	width="1383"
	height="716"
	srcset="/post/rabbitmq/assets/1682473534176_hu3408f0f13048723355eb1f835f38c53a_33218_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682473534176_hu3408f0f13048723355eb1f835f38c53a_33218_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682473534176"
	
	
		class="gallery-image" 
		data-flex-grow="193"
		data-flex-basis="463px"
	
></p>
<h2 id="2mq的作用">2.MQ的作用</h2>
<h3 id="21-流量消峰">2.1 流量==消峰==</h3>
<p>举个例子，如果订单系统最多能处理一万次订单，这个处理能力应付正常时段的下单时绰绰有余，正常时段我们下单一秒后就能返回结果。但是在高峰期，如果有两万次下单操作系统是处理不了的，只能限制订单超过一万后不允许用户下单。使用消息队列做缓冲，我们可以取消这个限制，把一秒内下的订单分  散成一段时间来处理，这时有些用户可能在下单十几秒后才能收到下单成功的操作，但是比不能下单的体验要好。</p>
<h3 id="22-应用解耦">2.2 应用==解耦==</h3>
<p>以电商应用为例，应用中有订单系统、库存系统、物流系统、支付系统。用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障，都会造成下单操作异常。当转变成基于消息队列的方式后，系统间调用的问题会减少很多，比如物流系统因为发生故障，需要几分钟来修复。在这几分钟的时间里，物流系统要处理的内存被缓存在消息队列中，用户的下单操作可以正常完成。当物流系统恢复后，继续处理订单信息即可，中单用户感受不到物流系统的故障，提升系统的可用性。</p>
<p><img src="/post/rabbitmq/assets/1682382912449.png"
	width="1121"
	height="336"
	srcset="/post/rabbitmq/assets/1682382912449_hu8662e74affdec10e0cb61c25446b676e_124647_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682382912449_hu8662e74affdec10e0cb61c25446b676e_124647_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682382912449"
	
	
		class="gallery-image" 
		data-flex-grow="333"
		data-flex-basis="800px"
	
></p>
<h3 id="23-异步提升效率">2.3 ==异步==提升效率</h3>
<p>场景说明：用户需发送短信验证码时，点击发送短信，第三方平台发送短信至用户手机成功，执行倒计时60秒。传统的做法有两种 1.串行的方式;2.并行方式：</p>
<h2 id="3mq的分类">3.MQ的分类</h2>
<ul>
<li>
<p><strong>ActiveMQ</strong></p>
<p>优点：单机吞吐量万级，时效性 ms 级，可用性高，基于主从架构实现高可用性，消息可靠性较 低的概率丢失数据</p>
<p>缺点：官方社区现在对 ActiveMQ 5.x 维护越来越少，高吞吐量场景较少使用</p>
</li>
<li>
<p><strong>Kafka</strong></p>
<p>大数据的杀手锏，谈到大数据领域内的消息传输，则绕不开  Kafka，这款为大数据而生的消息中间件，以其百万级 TPS  的吞吐量名声大噪，迅速成为大数据领域的宠儿，在数据采集、传输、存储的过程中发挥着举足轻重的作用。目前已经被  LinkedIn，Uber，Twitter，Netflix 等大公司所采纳。</p>
<p>优点: 性能卓越，单机写入 TPS  约在百万条/秒，最大的优点，就是吞吐量高。时效性 ms 级可用性非常高，kafka  是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用,消费者采用 Pull  方式获取消息，消息有序，通过控制能够保证所有消息被消费且仅被消费一次；有优秀的第三方Kafka Web 管理界面  Kafka-Manager；在日志领域比较成熟，被多家公司和多个开源项目使用；功能支持：功能 较为简单，主要支持简单的 MQ  功能，在大数据领域的实时计算以及日志采集被大规模使用</p>
<p>缺点：Kafka 单机超过 64 个队列/分区，Load 会发生明显的飙高现象，队列越多，load 越高，发送消息响应时间变长，使用短轮询方式，实时性取决于轮询间隔时间，消费失败不支持重试；支持消息顺序，但是一台代理宕机后，就会产生消息乱序，社区更新较慢</p>
</li>
<li>
<p><strong>RocketMQ</strong></p>
<p>RocketMQ 出自阿里巴巴的开源产品，用 Java 语言实现，在设计时参考了 Kafka，并做出了自己的一些改进。被阿里巴巴广泛应用在订单，交易，充值，流计算，消息推送，日志流式处理，binglog 分发等场景。</p>
<p>优点：单机吞吐量十万级，可用性非常高，分布式架构,消息可以做到 0 丢失,MQ 功能较为完善，还是分布式的，扩展性好,支持 10 亿级别的消息堆积，不会因为堆积导致性能下降，源码是 java 我们可以自己阅读源码，定制自己公司的 MQ</p>
<p>缺点：支持的客户端语言不多，目前是 java 及 c++，其中 c++ 不成熟；社区活跃度一般,没有在 MQ 核心中去实现 JMS 等接口,有些系统要迁移需要修改大量代码</p>
</li>
<li>
<p><strong>RabbitMQ</strong></p>
<p>2007 年发布，是一个在AMQP(高级消息队列协议)基础上完成的，可复用的企业消息系统，是当前最主流的消息中间件之一。</p>
<p>优点：由于  erlang 语言的高并发特性，性能较好；吞吐量到万级，MQ 功能比较完备,健壮、稳定、易用、跨平台、支持多种语言  如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP 等，支持 AJAX  文档齐全；开源提供的管理界面非常棒，用起来很好用,社区活跃度高；更新频率相当高</p>
<p>缺点：贵</p>
</li>
</ul>
<h2 id="4mq的选择">4.MQ的选择</h2>
<ul>
<li>
<p>**Kafka **</p>
<p>Kafka 主要特点是基于 Pull 的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集和传输，适合产生大量数据的互联网服务的数据收集业务。大型公司建议可以选用，如果有日志采集功能，肯定是首选 kafka 了。</p>
</li>
<li>
<p><strong>RocketMQ</strong></p>
<p>天生为金融互联网领域而生，对于可靠性要求很高的场景，尤其是电商里面的订单扣款，以及业务削峰，在大量交易涌入时，后端可能无法及时处理的情况。RoketMQ  在稳定性上可能更值得信赖，这些业务场景在阿里双 11 已经经历了多次考验，如果你的业务有上述并发场景，建议可以选择 RocketMQ。</p>
</li>
<li>
<p><strong>RabbitMQ</strong></p>
<p>结合 erlang 语言本身的并发优势，性能好时效性微秒级，社区活跃度也比较高，管理界面用起来十分 方便，如果你的数据量没有那么大，中小型公司优先选择功能比较完备的 RabbitMQ。</p>
</li>
</ul>
<h2 id="二rabbitmq的基本架构">二.RabbitMQ的基本架构</h2>
<h3 id="1四大核心概念类似于快递站">1.四大核心概念[类似于快递站]</h3>
<ul>
<li>
<p>生产者
产生数据发送消息的程序是生产者</p>
</li>
<li>
<p>交换机
交换机是 RabbitMQ 非常重要的一个部件，一方面它接收来自生产者的消息，另一方面它将消息推送到队列中。交换机必须确切知道如何处理它接收到的消息，是将这些消息推送到特定队列还是推
送到多个队列，亦或者是把消息丢弃，这个得有交换机类型决定</p>
</li>
<li>
<p>队列</p>
<p>队列是 RabbitMQ 内部使用的一种数据结构，尽管消息流经 RabbitMQ 和应用程序，但它们只能存储在队列中。队列仅受主机的内存和磁盘限制的约束，本质上是一个大的消息缓冲区。许多生产者可以将消息发送到一个队列，许多消费者可以尝试从一个队列接收数据。这就是我们使用队列的方式</p>
</li>
<li>
<p>消费者
消费与接收具有相似的含义。消费者大多时候是一个等待接收消息的程序。请注意生产者，消费
者和消息中间件很多时候并不在同一机器上。同一个应用程序既可以是生产者又是可以是消费者。</p>
<p><img src="/post/rabbitmq/assets/1682475976581.png"
	width="1096"
	height="495"
	srcset="/post/rabbitmq/assets/1682475976581_hu31afd1df4a0b48f80a91ca8db3060f6e_15140_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682475976581_hu31afd1df4a0b48f80a91ca8db3060f6e_15140_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682475976581"
	
	
		class="gallery-image" 
		data-flex-grow="221"
		data-flex-basis="531px"
	
></p>
</li>
</ul>
<h3 id="2rabbitmq架构">2.RabbitMQ架构</h3>
<p><img src="/post/rabbitmq/assets/1682383843615.png"
	width="1296"
	height="672"
	srcset="/post/rabbitmq/assets/1682383843615_hu22444a6ce21de7b110b80fc37082ea76_231852_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682383843615_hu22444a6ce21de7b110b80fc37082ea76_231852_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682383843615"
	
	
		class="gallery-image" 
		data-flex-grow="192"
		data-flex-basis="462px"
	
></p>
<p><code>Broker</code>：接收和分发消息的应用，RabbitMQ Server 就是 Message Broker</p>
<p><code>Virtual host</code>：出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似 于网络中的 namespace 概念。当多个不同的用户使用同一个 RabbitMQ server 提供的服务时，可以划分出 多个 vhost，每个用户在自己的 vhost 创建 exchange／queue 等</p>
<p><code>Connection</code>：publisher／consumer 和 broker 之间的 TCP 连接</p>
<p><code>Channel</code>：如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection 的开销将是巨大的，效率也较低。Channel 是在 connection 内部建立的逻辑连接，如果应用程 序支持多线程，通常每个 thread 创建单独的 channel 进行通讯，AMQP method 包含了 channel id 帮助客 户端和 message broker 识别 channel，所以 channel 之间是完全隔离的。Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP connection 的开销</p>
<p><code>Exchange</code>：message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing key，分发 消息到 queue 中去。常用的类型有：direct (point-to-point), topic (publish-subscribe) and fanout (multicast)</p>
<p><code>Queue</code>：消息最终被送到这里等待 consumer 取走</p>
<p><code>Binding</code>：exchange 和 queue 之间的虚拟连接，binding 中可以包含 routingkey，Binding 信息被保存到 exchange 中的查询表中，用于 message 的分发依据</p>
<h3 id="3安装rabbit">3.安装Rabbit</h3>
<p>1.官网地址</p>
<p><code>https://www.rabbitmq.com/download.html </code></p>
<p>2.文件上传</p>
<p><code>上传到/usr/local/app 目录下(如果没有 software 需要自己创建) </code></p>
<p>3.安装文件(分别按照以下顺序安装)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>rpm <span style="color:#f92672">-</span>ivh erlang<span style="color:#f92672">-</span><span style="color:#ae81ff">21.3</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1.</span>el7<span style="color:#f92672">.</span><span style="color:#a6e22e">x86_64</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rpm</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>yum install socat <span style="color:#f92672">-</span>y 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rpm <span style="color:#f92672">-</span>ivh rabbitmq<span style="color:#f92672">-</span>server<span style="color:#f92672">-</span><span style="color:#ae81ff">3.8.8</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1.</span>el7<span style="color:#f92672">.</span><span style="color:#a6e22e">noarch</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rpm</span> 
</span></span></code></pre></div><p>4.常用命令(按照以下顺序执行)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">添加开机启动</span> RabbitMQ <span style="color:#960050;background-color:#1e0010">服务</span> 
</span></span><span style="display:flex;"><span>chkconfig rabbitmq<span style="color:#f92672">-</span>server on 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">启动服务</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>sbin<span style="color:#f92672">/</span>service rabbitmq<span style="color:#f92672">-</span>server start  
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">查看服务状态</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>sbin<span style="color:#f92672">/</span>service rabbitmq<span style="color:#f92672">-</span>server status 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">停止服务</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">选择执行</span><span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>sbin<span style="color:#f92672">/</span>service rabbitmq<span style="color:#f92672">-</span>server stop 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">开启</span> web <span style="color:#960050;background-color:#1e0010">管理插件</span> 
</span></span><span style="display:flex;"><span>rabbitmq<span style="color:#f92672">-</span>plugins enable rabbitmq_management 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">用默认账号密码</span><span style="color:#f92672">(</span>guest<span style="color:#f92672">)</span><span style="color:#960050;background-color:#1e0010">访问地址</span> 
</span></span><span style="display:flex;"><span>http:<span style="color:#75715e">//RabbitMQ运行的机器的IP:15672/
</span></span></span></code></pre></div><p><img src="/post/rabbitmq/assets/1682392854308.png"
	width="1186"
	height="605"
	srcset="/post/rabbitmq/assets/1682392854308_hu2c9a4676fed220084d7a5e7612f29737_60559_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682392854308_hu2c9a4676fed220084d7a5e7612f29737_60559_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682392854308"
	
	
		class="gallery-image" 
		data-flex-grow="196"
		data-flex-basis="470px"
	
></p>
<p>4.添加一个新的用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">创建账号</span> 
</span></span><span style="display:flex;"><span>rabbitmqctl add_user admin admin 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">设置用户角色</span> 
</span></span><span style="display:flex;"><span>rabbitmqctl set_user_tags admin administrator 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">设置用户权限</span> 
</span></span><span style="display:flex;"><span>set_permissions <span style="color:#f92672">[-</span>p <span style="color:#f92672">&lt;</span>vhostpath<span style="color:#f92672">&gt;]</span> <span style="color:#f92672">&lt;</span>user<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span>conf<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span>write<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span>read<span style="color:#f92672">&gt;</span> 
</span></span><span style="display:flex;"><span>rabbitmqctl set_permissions <span style="color:#f92672">-</span>p <span style="color:#e6db74">&#34;/&#34;</span> admin <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span> <span style="color:#e6db74">&#34;.*&#34;</span> 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">用户</span> user_admin <span style="color:#960050;background-color:#1e0010">具有</span><span style="color:#f92672">/</span>vhost1 <span style="color:#960050;background-color:#1e0010">这个</span> virtual host <span style="color:#960050;background-color:#1e0010">中所有资源的配置、写、读权限</span> 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">当前用户和角色</span> 
</span></span><span style="display:flex;"><span>rabbitmqctl list_users 
</span></span></code></pre></div><h3 id="5再次利用-admin-用户登录">5.再次利用 admin 用户登录</h3>
<p><img src="/post/rabbitmq/assets/1682393025178.png"
	width="1070"
	height="218"
	srcset="/post/rabbitmq/assets/1682393025178_hu48363e5b3551445181e3e5847367b723_88179_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682393025178_hu48363e5b3551445181e3e5847367b723_88179_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682393025178"
	
	
		class="gallery-image" 
		data-flex-grow="490"
		data-flex-basis="1177px"
	
></p>
<h3 id="6重置命令">6.重置命令</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">关闭应用的命令为</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rabbitmqctl stop_app 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">清除的命令为</span>rabbitmqctl reset 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">重新启动命令为</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rabbitmqctl start_app
</span></span></code></pre></div><h2 id="三rabbitmq入门">三.RabbitMQ入门</h2>
<p><img src="/post/rabbitmq/assets/1682393096528.png"
	width="850"
	height="201"
	srcset="/post/rabbitmq/assets/1682393096528_hu668ccca82db932edc6d31336c13c6b1b_55655_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682393096528_hu668ccca82db932edc6d31336c13c6b1b_55655_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682393096528"
	
	
		class="gallery-image" 
		data-flex-grow="422"
		data-flex-basis="1014px"
	
></p>
<h3 id="31-环境准备">3.1 环境准备</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!--指定 jdk 编译版本--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;build&gt;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;plugins&gt;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugin&gt;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color:#f92672">&lt;/groupId&gt;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>maven-compiler-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;configuration&gt;</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;source&gt;</span>8<span style="color:#f92672">&lt;/source&gt;</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;target&gt;</span>8<span style="color:#f92672">&lt;/target&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/build&gt;</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">&lt;!--rabbitmq 依赖客户端--&gt;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>com.rabbitmq<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>amqp-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>5.14.2<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#75715e">&lt;!--IO 工具包--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span> 
</span></span><span style="display:flex;"><span>    	<span style="color:#f92672">&lt;groupId&gt;</span>commons-io<span style="color:#f92672">&lt;/groupId&gt;</span> 
</span></span><span style="display:flex;"><span>    	<span style="color:#f92672">&lt;artifactId&gt;</span>commons-io<span style="color:#f92672">&lt;/artifactId&gt;</span> 
</span></span><span style="display:flex;"><span>    	<span style="color:#f92672">&lt;version&gt;</span>2.6<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h3 id="32-消息生产者">3.2 消息生产者</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.zhyp.rabbitmq<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Channel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Connection<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.ConnectionFactory<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Producer</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">static</span> String QUEUE_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//创建一个连接工厂
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ConnectionFactory factory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConnectionFactory<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setHost</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;182.92.234.71&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setUsername</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setPassword</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;123&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setPort</span><span style="color:#f92672">(</span><span style="color:#ae81ff">5672</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//channel 实现了自动 close 接口 自动关闭 不需要显示关闭
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">(</span>Connection connection <span style="color:#f92672">=</span> factory<span style="color:#f92672">.</span><span style="color:#a6e22e">newConnection</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>             Channel channel <span style="color:#f92672">=</span> connection<span style="color:#f92672">.</span><span style="color:#a6e22e">createChannel</span><span style="color:#f92672">()){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 生成一个队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 1.队列名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 2.队列里面的消息是否持久化 默认消息存储在内存中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 3.该队列是否只供一个消费者进行消费 是否进行共享 true 可以多个消费者消费
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 4.是否自动删除 最后一个消费者端开连接以后 该队列是否自动删除 true 自动删除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 5.其他参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             */</span>
</span></span><span style="display:flex;"><span>            channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span>QUEUE_NAME<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            String message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello world&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 发送一个消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 1.发送到那个交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 2.路由的 key 是哪个
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 3.其他的参数信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 4.发送消息的消息体
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             */</span>
</span></span><span style="display:flex;"><span>            channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicPublish</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> QUEUE_NAME<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> message<span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;消息发送完毕&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="33-消息消费者">3.3 消息消费者</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Consumer</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">static</span> String QUEUE_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ConnectionFactory factory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConnectionFactory<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setHost</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;182.92.234.71&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setUsername</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setPassword</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;123&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setPort</span><span style="color:#f92672">(</span><span style="color:#ae81ff">5672</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Connection connection <span style="color:#f92672">=</span> factory<span style="color:#f92672">.</span><span style="color:#a6e22e">newConnection</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Channel channel <span style="color:#f92672">=</span> connection<span style="color:#f92672">.</span><span style="color:#a6e22e">createChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;等待接收消息.........&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//推送的消息如何进行消费的接口回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        DeliverCallback deliverCallback <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>consumerTag<span style="color:#f92672">,</span> delivery<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            String message <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>delivery<span style="color:#f92672">.</span><span style="color:#a6e22e">getBody</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>message<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//取消消费的一个回调接口 如在消费的时候队列被删除掉了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        CancelCallback cancelCallback <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>consumerTag<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;消息消费被中断&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 消费者消费消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 1.消费哪个队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 2.消费成功之后是否要自动应答 true 代表自动应答 false 手动应答
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 3.消费者收到MQ消息的回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 4.消费者未成功消费的回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicConsume</span><span style="color:#f92672">(</span>QUEUE_NAME<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> deliverCallback<span style="color:#f92672">,</span> cancelCallback<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>抽取工具类</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RabbitUtils</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> channel <span style="color:#a6e22e">getChannel</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        ConnectionFactory factory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConnectionFactory<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setHost</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;182.92.234.71&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setUsername</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setPassword</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;123&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#f92672">.</span><span style="color:#a6e22e">setPort</span><span style="color:#f92672">(</span><span style="color:#ae81ff">5672</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Connection connection <span style="color:#f92672">=</span> factory<span style="color:#f92672">.</span><span style="color:#a6e22e">newConnection</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Channel channel <span style="color:#f92672">=</span> connection<span style="color:#f92672">.</span><span style="color:#a6e22e">createChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> channel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="34-消息应答面试题如何保证消费者消息不丢失">==3.4 消息应答(面试题:如何保证消费者消息不丢失)==</h3>
<p><code>RabbitMQ 一旦向消费者传递了一条消息，便立即将该消 息标记为删除。</code>在这种情况下，突然有个消费者挂掉了，我们将丢失正在处理的消息。以及后续 发送给该消费这的消息，因为它无法接收到。 为了保证消息在发送过程中不丢失，rabbitmq 引入消息应答机制，消息应答就是:消费者在接收 到消息并且处理该消息之后，告诉 rabbitmq 它已经处理了，rabbitmq 可以把该消息删除了。</p>
<p><strong>自动应答</strong></p>
<p>消息发送后立即被认为已经传送成功，这种模式需要在高吞吐量和数据传输安全性方面做权 衡,因为这种模式如果消息在接收到之前，消费者那边出现连接或者 channel 关闭，那么消息就丢失 了,当然另一方面这种模式消费者那边可以传递过载的消息，没有对传递的消息数量进行限制，当 然这样有可能使得消费者这边由于接收太多还来不及处理的消息，导致这些消息的积压，最终使 得内存耗尽，最终这些消费者线程被操作系统杀死，所以这种模式仅适用在消费者可以高效并以 某种速率能够处理这些消息的情况下使用。</p>
<p><strong>手动消息应答的方法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ae81ff">1.</span>channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicAck</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">用于肯定确认</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span> RabbitMQ <span style="color:#960050;background-color:#1e0010">已知道该消息并且成功的处理消息，可以将其丢弃了</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2.</span>channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicNack</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">用于否定确认</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3.</span>channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicReject</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">用于否定确认</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">与</span> channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicNack</span> <span style="color:#960050;background-color:#1e0010">相比少一个参数</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">批量应答</span><span style="color:#f92672">)</span> <span style="color:#960050;background-color:#1e0010">不处理该消息了直接拒绝，可以将其丢弃了</span> 
</span></span></code></pre></div><p><strong>Multiple 手动应答</strong></p>
<p>​	手动应答的好处是可以批量应答并且减少网络拥堵</p>
<p><img src="/post/rabbitmq/assets/1682394301757.png"
	width="1545"
	height="314"
	srcset="/post/rabbitmq/assets/1682394301757_hu32d5cf12e6ce3a71e9ac9bf5828e014b_275840_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682394301757_hu32d5cf12e6ce3a71e9ac9bf5828e014b_275840_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682394301757"
	
	
		class="gallery-image" 
		data-flex-grow="492"
		data-flex-basis="1180px"
	
></p>
<ul>
<li>
<p>multiple 的 true 和 false 代表不同意思</p>
<ul>
<li>
<p>true 代表批量应答 channel 上未应答的消息</p>
<pre><code>比如说 channel 上有传送 tag 的消息 5,6,7,8 当前 tag 是8 那么此时 5-8 的这些还未应答的消息都会被确认收到消息应答 
</code></pre>
</li>
</ul>
</li>
<li>
<ul>
<li>false 同上面相比</li>
</ul>
</li>
</ul>
<p>​		 只会应答 tag=8 的消息 5,6,7 这三个消息依然不会被确认收到消息应答</p>
<p><img src="/post/rabbitmq/assets/1682394422798.png"
	width="1191"
	height="427"
	srcset="/post/rabbitmq/assets/1682394422798_hub043f53f7085fcbe185e4b5e710aaf3a_66300_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682394422798_hub043f53f7085fcbe185e4b5e710aaf3a_66300_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682394422798"
	
	
		class="gallery-image" 
		data-flex-grow="278"
		data-flex-basis="669px"
	
></p>
<p><img src="/post/rabbitmq/assets/1682394435473.png"
	width="1188"
	height="463"
	srcset="/post/rabbitmq/assets/1682394435473_hu3899bb4f26daca339bf085272246f0d0_85504_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682394435473_hu3899bb4f26daca339bf085272246f0d0_85504_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682394435473"
	
	
		class="gallery-image" 
		data-flex-grow="256"
		data-flex-basis="615px"
	
></p>
<p><img src="/post/rabbitmq/assets/1682394448939.png"
	width="1195"
	height="468"
	srcset="/post/rabbitmq/assets/1682394448939_hu5c187d320077591c8428afe24be48940_85630_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682394448939_hu5c187d320077591c8428afe24be48940_85630_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682394448939"
	
	
		class="gallery-image" 
		data-flex-grow="255"
		data-flex-basis="612px"
	
></p>
<h3 id="35-消息自动重新入队">3.5 消息自动重新入队</h3>
<p>如果消费者由于某些原因失去连接(其通道已关闭，连接已关闭或 TCP 连接丢失)，导致消息 未发送 ACK 确认，RabbitMQ 将了解到消息未完全处理，并将对其重新排队。如果此时其他消费者 可以处理，它将很快将其重新分发给另一个消费者。这样，即使某个消费者偶尔死亡，也可以确 保不会丢失任何消息</p>
<p><img src="/post/rabbitmq/assets/1682395939273.png"
	width="1495"
	height="644"
	srcset="/post/rabbitmq/assets/1682395939273_huc13478a89d3b245f7e549a30897be1ee_189222_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682395939273_huc13478a89d3b245f7e549a30897be1ee_189222_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682395939273"
	
	
		class="gallery-image" 
		data-flex-grow="232"
		data-flex-basis="557px"
	
></p>
<h3 id="36-消息手动应答代码">3.6 消息手动应答代码</h3>
<p>默认消息采用的是自动应答，所以我们要想实现消息消费过程中不丢失，需要把自动应答改</p>
<p>为手动应答，消费者在上面代码的基础上增加下面画红色部分代码。</p>
<p><img src="/post/rabbitmq/assets/1682396032934.png"
	width="1526"
	height="538"
	srcset="/post/rabbitmq/assets/1682396032934_hu6ee3022a2628804c106df487d12f8243_843420_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682396032934_hu6ee3022a2628804c106df487d12f8243_843420_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682396032934"
	
	
		class="gallery-image" 
		data-flex-grow="283"
		data-flex-basis="680px"
	
></p>
<p><strong>消息生产者</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.rabbitmq.quickstart.consumer_ack<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Channel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.quickstart.utils.RabbitUtils<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * MQ消息生产者
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Publisher</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.使用工具类获取channel对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Channel channel <span style="color:#f92672">=</span> RabbitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.发送信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//2.1 创建队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * String queue,  队列名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * boolean durable, true 队列持久化 false 队列在broker重启删除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * boolean exclusive,  该队列是否为某个消费者专用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * boolean autoDelete, 当没有消费者连接这个队列时 是否自动删除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * Map&lt;String, Object&gt; arguments  其他配置参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;queue_name&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.2 发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicPublish</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;queue_name&#34;</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,(</span><span style="color:#e6db74">&#34;Hello Rabbit!&#34;</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">).</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;发消息成功...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>消息消费者</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.rabbitmq.quickstart.consumer_ack<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.CancelCallback<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Channel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.DeliverCallback<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.quickstart.utils.RabbitUtils<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 消息消费者
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Consumer</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">long</span> start <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.使用工具类获取channel对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Channel channel <span style="color:#f92672">=</span> RabbitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.读取mq中消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        DeliverCallback deliverCallback <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>consumerTag<span style="color:#f92672">,</span>message<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;取到消息了: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>message<span style="color:#f92672">.</span><span style="color:#a6e22e">getBody</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//4.消费完毕后必须手动应答,采用的单个消息应答
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            		channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicAck</span><span style="color:#f92672">(</span>message<span style="color:#f92672">.</span><span style="color:#a6e22e">getEnvelope</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDeliveryTag</span><span style="color:#f92672">(),</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            count<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">long</span> end <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;耗时:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>end<span style="color:#f92672">-</span>start<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>        CancelCallback cancelCallback <span style="color:#f92672">=</span> consumerTag <span style="color:#f92672">-&gt;</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;消息取消了: &#34;</span> <span style="color:#f92672">+</span> consumerTag<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//3.把自动应答改为手动应答
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        start <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicConsume</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;queue_name&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> deliverCallback<span style="color:#f92672">,</span> cancelCallback<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="37-rabbitmq-持久化">3.7 RabbitMQ 持久化</h3>
<h4 id="371-概念">3.7.1 概念</h4>
<p>刚刚我们已经看到了如何处理任务不丢失的情况，但是如何保障当 RabbitMQ 服务停掉以后消 息生产者发送过来的消息不丢失。默认情况下 RabbitMQ 退出或由于某种原因崩溃时，它忽视队列 和消息，除非告知它不要这样做。确保消息不会丢失需要做两件事：我们需要将队列和消息都标 记为持久化。</p>
<h4 id="372-队列如何实现持久化">3.7.2 队列如何实现持久化</h4>
<p>之前我们创建的队列都是非持久化的，rabbitmq 如果重启的化，该队列就会被删除掉，如果 要队列实现持久化 需要在声明队列的时候把 durable 参数设置为持久化</p>
<p><img src="/post/rabbitmq/assets/1682396218835.png"
	width="1521"
	height="90"
	srcset="/post/rabbitmq/assets/1682396218835_hu637a713675c06e28240bc71aca69867d_129121_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682396218835_hu637a713675c06e28240bc71aca69867d_129121_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682396218835"
	
	
		class="gallery-image" 
		data-flex-grow="1690"
		data-flex-basis="4056px"
	
></p>
<p>但是需要<strong>注意</strong>的就是如果之前声明的队列不是持久化的，需要把原先队列先删除，或者重新</p>
<p>创建一个持久化的队列，不然就会出现错误 .</p>
<p><img src="/post/rabbitmq/assets/1682396285121.png"
	width="1513"
	height="52"
	srcset="/post/rabbitmq/assets/1682396285121_hua049ad4104e54eeb2796ac0dbad7cee2_29479_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682396285121_hua049ad4104e54eeb2796ac0dbad7cee2_29479_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682396285121"
	
	
		class="gallery-image" 
		data-flex-grow="2909"
		data-flex-basis="6983px"
	
></p>
<p>这个时候即使重启 rabbitmq 队列也依然存在</p>
<p><img src="/post/rabbitmq/assets/1682396294506.png"
	width="1516"
	height="365"
	srcset="/post/rabbitmq/assets/1682396294506_hu96a1bcb81d6e5a4c68796fc1bb898344_141804_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682396294506_hu96a1bcb81d6e5a4c68796fc1bb898344_141804_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682396294506"
	
	
		class="gallery-image" 
		data-flex-grow="415"
		data-flex-basis="996px"
	
></p>
<h4 id="373-消息实现持久化">3.7.3 消息实现持久化</h4>
<p>要想让消息实现持久化需要在消息生产者修改代码，MessageProperties.PERSISTENT_TEXT_PLAIN 添 加这个属性。</p>
<p><img src="/post/rabbitmq/assets/1682396362572.png"
	width="1800"
	height="212"
	srcset="/post/rabbitmq/assets/1682396362572_hu639edfbf8603e9d62e83e29868b1ded8_321239_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682396362572_hu639edfbf8603e9d62e83e29868b1ded8_321239_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682396362572"
	
	
		class="gallery-image" 
		data-flex-grow="849"
		data-flex-basis="2037px"
	
></p>
<h3 id="38-生产者消息发布确认">3.8 生产者消息发布确认</h3>
<h4 id="381-开启发布确认的方法--单条">3.8.1 开启发布确认的方法  (单条)</h4>
<p>发布确认默认是没有开启的，如果要开启需要调用方法 confirmSelect，每当你要想使用发布确认，都需要在 channel 上调用该方法</p>
<p><img src="/post/rabbitmq/assets/1682396494539.png"
	width="1001"
	height="118"
	srcset="/post/rabbitmq/assets/1682396494539_hu598a03653bf69cbc731a852e1e57c636_67801_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682396494539_hu598a03653bf69cbc731a852e1e57c636_67801_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682396494539"
	
	
		class="gallery-image" 
		data-flex-grow="848"
		data-flex-basis="2035px"
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">publishMessageIndividually</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">(</span>Channel channel <span style="color:#f92672">=</span> RabbitMqUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        String queueName <span style="color:#f92672">=</span> UUID<span style="color:#f92672">.</span><span style="color:#a6e22e">randomUUID</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span>queueName<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//开启发布确认
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">confirmSelect</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> begin <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> MESSAGE_COUNT<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            String message <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicPublish</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> queueName<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> message<span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//服务端返回 false 或超时时间内未返回，生产者可以消息重发
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> flag <span style="color:#f92672">=</span> channel<span style="color:#f92672">.</span><span style="color:#a6e22e">waitForConfirms</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flag<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;消息发送成功&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> end <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;发布&#34;</span> <span style="color:#f92672">+</span> MESSAGE_COUNT <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;个单独确认消息,耗时&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>end <span style="color:#f92672">-</span> begin<span style="color:#f92672">)</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                           <span style="color:#e6db74">&#34;ms&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="382-开启发布确认的方法--批量">3.8.2 开启发布确认的方法  (批量)</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * MQ消息生产者
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Publisher</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.使用工具类获取channel对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Channel channel <span style="color:#f92672">=</span> RabbitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//开启发布确认
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">confirmSelect</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.发送信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//2.1 创建队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * String queue,  队列名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * boolean durable, true 队列持久化 false 队列在broker重启删除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * boolean exclusive,  该队列是否为某个消费者专用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * boolean autoDelete, 当没有消费者连接这个队列时 是否自动删除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * Map&lt;String, Object&gt; arguments  其他配置参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;queue_name&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.2 发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">long</span> start <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicPublish</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;queue_name&#34;</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,(</span><span style="color:#e6db74">&#34;Hello Rabbit!&#34;</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">).</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.3 接收broker的发布确认
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">boolean</span> b <span style="color:#f92672">=</span> channel<span style="color:#f92672">.</span><span style="color:#a6e22e">waitForConfirms</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> end <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>b<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;批量发消息成功...&#34;</span><span style="color:#f92672">+(</span>end<span style="color:#f92672">-</span>start<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="39--交换机">3.9  交换机</h3>
<p>RabbitMQ 消息传递模型的核心思想是: 生产者生产的消息从不会直接发送到队列。实际上，通常生产者甚至都不知道这些消息传递传递到了哪些队列中。 相反，生产者只能将消息发送到<strong>交换机(exchange)</strong></p>
<p><img src="/post/rabbitmq/assets/1682397400218.png"
	width="928"
	height="368"
	srcset="/post/rabbitmq/assets/1682397400218_huefd370e44086d87467542a90b054e6cc_85832_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682397400218_huefd370e44086d87467542a90b054e6cc_85832_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682397400218"
	
	
		class="gallery-image" 
		data-flex-grow="252"
		data-flex-basis="605px"
	
></p>
<h4 id="390-绑定bindings">3.9.0 绑定(bindings)</h4>
<p><strong>binding</strong> 其实是 exchange 和 queue 之间的桥梁，它告诉我们 exchange 和那个队 列进行了绑定关系。比如说下面这张图告诉我们的就是 X 与 Q1 和 Q2 进行了绑定</p>
<p><img src="/post/rabbitmq/assets/1682397615821.png"
	width="771"
	height="403"
	srcset="/post/rabbitmq/assets/1682397615821_hue1c97816a7d7edaeb7fffafab95acd03_90514_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682397615821_hue1c97816a7d7edaeb7fffafab95acd03_90514_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682397615821"
	
	
		class="gallery-image" 
		data-flex-grow="191"
		data-flex-basis="459px"
	
></p>
<h4 id="391-exchanges-的类型">3.9.1 Exchanges 的类型</h4>
<p><strong>总共有以下类型：</strong></p>
<p>​	直接(direct), 主题(topic) ,扇出(fanout), 标题(headers)</p>
<h4 id="392-fanout-exchange-扇出交换机">3.9.2 Fanout exchange 扇出交换机</h4>
<p>Fanout 这种类型非常简单。正如从名称中猜到的那样，它是将接收到的所有消息广播到它知道的 所有队列中。系统中默认有些 exchange 类型</p>
<p><img src="/post/rabbitmq/assets/1682397784720.png"
	width="1014"
	height="612"
	srcset="/post/rabbitmq/assets/1682397784720_hudb0d831617650b302b6e92b6ab75c24e_115321_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682397784720_hudb0d831617650b302b6e92b6ab75c24e_115321_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682397784720"
	
	
		class="gallery-image" 
		data-flex-grow="165"
		data-flex-basis="397px"
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>channel<span style="color:#f92672">.</span><span style="color:#a6e22e">exchangeDeclare</span><span style="color:#f92672">(</span>EXCHANGE_NAME<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;fanout&#34;</span><span style="color:#f92672">);</span> <span style="color:#75715e">//声明交换机为fanout
</span></span></span></code></pre></div><p><strong>生产者</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Channel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.quickstart.utils.RabbitUtils<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Publisher</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.使用工具类获取channel对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Channel channel <span style="color:#f92672">=</span> RabbitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.发送信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicPublish</span><span style="color:#f92672">(</span>Consumer01<span style="color:#f92672">.</span><span style="color:#a6e22e">exchange_name</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;Hello Rabbit!&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;UtF-8&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>       System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;发消息成功...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>消费者</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.BuiltinExchangeType<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Channel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.DeliverCallback<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.quickstart.utils.RabbitUtils<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Consumer01</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String exchange_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fanout_exchange&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String queue_name1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;queue_one&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String queue_name2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;queue_two&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.获取Channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Channel channel <span style="color:#f92672">=</span> RabbitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.创建交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">exchangeDeclare</span><span style="color:#f92672">(</span>exchange_name<span style="color:#f92672">,</span> BuiltinExchangeType<span style="color:#f92672">.</span><span style="color:#a6e22e">FANOUT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//3.创建队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span>queue_name1<span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span>queue_name2<span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//4.绑定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueBind</span><span style="color:#f92672">(</span>queue_name1<span style="color:#f92672">,</span>exchange_name<span style="color:#f92672">,</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueBind</span><span style="color:#f92672">(</span>queue_name2<span style="color:#f92672">,</span>exchange_name<span style="color:#f92672">,</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//5.消费
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        DeliverCallback okCallBack <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>consumerTag<span style="color:#f92672">,</span> message<span style="color:#f92672">)-&gt;{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;接受到消息：&#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>message<span style="color:#f92672">.</span><span style="color:#a6e22e">getBody</span><span style="color:#f92672">(),</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicConsume</span><span style="color:#f92672">(</span>queue_name1<span style="color:#f92672">,</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>okCallBack<span style="color:#f92672">,(</span>consumerTag<span style="color:#f92672">)-&gt;{});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="393-direct-exchange-direct交换机">3.9.3 Direct exchange Direct交换机</h4>
<p>Direct交换机只会将发送到指定的 routingKey 队列中去.</p>
<p><img src="/post/rabbitmq/assets/1682398063758.png"
	width="1135"
	height="401"
	srcset="/post/rabbitmq/assets/1682398063758_huc4d79e30573d0f53a91c1ba66e05f340_145712_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682398063758_huc4d79e30573d0f53a91c1ba66e05f340_145712_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682398063758"
	
	
		class="gallery-image" 
		data-flex-grow="283"
		data-flex-basis="679px"
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Publisher</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.使用工具类获取channel对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Channel channel <span style="color:#f92672">=</span> RabbitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.发送信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicPublish</span><span style="color:#f92672">(</span>Consumer1<span style="color:#f92672">.</span><span style="color:#a6e22e">exchange_name</span><span style="color:#f92672">,</span>Consumer1<span style="color:#f92672">.</span><span style="color:#a6e22e">routing_key_1</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;给路由Orange发送的信息&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicPublish</span><span style="color:#f92672">(</span>Consumer1<span style="color:#f92672">.</span><span style="color:#a6e22e">exchange_name</span><span style="color:#f92672">,</span>Consumer1<span style="color:#f92672">.</span><span style="color:#a6e22e">routing_key_2</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;给路由black发送的信息&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicPublish</span><span style="color:#f92672">(</span>Consumer1<span style="color:#f92672">.</span><span style="color:#a6e22e">exchange_name</span><span style="color:#f92672">,</span>Consumer1<span style="color:#f92672">.</span><span style="color:#a6e22e">routing_key_3</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;给路由green发送的信息&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;发消息成功...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.rabbitmq.quickstart.exchange_direct<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.BuiltinExchangeType<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Channel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.DeliverCallback<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Delivery<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.quickstart.utils.RabbitUtils<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Consumer1</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String exchange_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String queue_name1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Q1&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String queue_name2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Q2&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String routing_key_1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;orange&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String routing_key_2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;black&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String routing_key_3 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;green&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.获取Channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Channel channel <span style="color:#f92672">=</span> RabbitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.创建交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">exchangeDeclare</span><span style="color:#f92672">(</span>exchange_name<span style="color:#f92672">,</span> BuiltinExchangeType<span style="color:#f92672">.</span><span style="color:#a6e22e">DIRECT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//3.创建队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span>queue_name1<span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span>queue_name2<span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//4.绑定队列和交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueBind</span><span style="color:#f92672">(</span>queue_name1<span style="color:#f92672">,</span>exchange_name<span style="color:#f92672">,</span>routing_key_1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueBind</span><span style="color:#f92672">(</span>queue_name2<span style="color:#f92672">,</span>exchange_name<span style="color:#f92672">,</span>routing_key_2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueBind</span><span style="color:#f92672">(</span>queue_name2<span style="color:#f92672">,</span>exchange_name<span style="color:#f92672">,</span>routing_key_3<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//5.消费消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        DeliverCallback okCallBack <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>consumerTag<span style="color:#f92672">,</span> message<span style="color:#f92672">)-&gt;{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;接受到消息：&#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>message<span style="color:#f92672">.</span><span style="color:#a6e22e">getBody</span><span style="color:#f92672">(),</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//消费者1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicConsume</span><span style="color:#f92672">(</span>queue_name1<span style="color:#f92672">,</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>okCallBack<span style="color:#f92672">,(</span>consumerTag<span style="color:#f92672">)-&gt;{});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//消费者2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//channel.basicConsume(queue_name2,true,okCallBack,(consumerTag)-&gt;{});
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="394-topic-主题交换机">3.9.4 Topic 主题交换机</h4>
<p><strong>Topic 的要求</strong></p>
<p>发送到类型是 topic 交换机的消息的 routing_key 不能随意写，必须满足一定的要求，它必须是一个单词列表，以<strong>点号</strong>分隔开。这些单词可以是任意单词，比如说：&ldquo;stock.usd.nyse&rdquo;, &ldquo;nyse.vmw&rdquo;, &ldquo;quick.orange.rabbit&rdquo;.这种类型的。当然这个单词列表最多不能超过 255 个字节。</p>
<p>在这个规则列表中，其中有两个替换符是大家需要注意的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">*(</span><span style="color:#960050;background-color:#1e0010">星号</span><span style="color:#f92672">)</span><span style="color:#960050;background-color:#1e0010">可以代替一个单词</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">井号</span><span style="color:#f92672">)</span><span style="color:#960050;background-color:#1e0010">可以替代零个或多个单词</span>
</span></span></code></pre></div><p><strong>Topic 匹配案例</strong></p>
<p>下图绑定关系如下</p>
<p>Q1&ndash;&gt;绑定的是</p>
<p>​	中间带 orange 带 3 个单词的字符串(<em>.orange.</em>)</p>
<p>Q2&ndash;&gt;绑定的是</p>
<p>​	最后一个单词是 rabbit 的 3 个单词(<em>.</em>.rabbit)</p>
<p>​	第一个单词是 lazy 的多个单词(lazy.#)</p>
<p><img src="/post/rabbitmq/assets/1682398342481.png"
	width="1348"
	height="456"
	srcset="/post/rabbitmq/assets/1682398342481_hu47aae37ca5704f4dc3ae1ef15f8e2562_200375_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682398342481_hu47aae37ca5704f4dc3ae1ef15f8e2562_200375_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682398342481"
	
	
		class="gallery-image" 
		data-flex-grow="295"
		data-flex-basis="709px"
	
></p>
<p><strong>上图是一个队列绑定关系图，我们来看看他们之间数据接收情况是怎么样的</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>quick<span style="color:#f92672">.</span><span style="color:#a6e22e">orange</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rabbit</span> <span style="color:#960050;background-color:#1e0010">被队列</span> Q1Q2 <span style="color:#960050;background-color:#1e0010">接收到</span> 
</span></span><span style="display:flex;"><span>lazy<span style="color:#f92672">.</span><span style="color:#a6e22e">orange</span><span style="color:#f92672">.</span><span style="color:#a6e22e">elephant</span> <span style="color:#960050;background-color:#1e0010">被队列</span> Q1Q2 <span style="color:#960050;background-color:#1e0010">接收到</span>
</span></span><span style="display:flex;"><span>quick<span style="color:#f92672">.</span><span style="color:#a6e22e">orange</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fox</span> <span style="color:#960050;background-color:#1e0010">被队列</span> Q1 <span style="color:#960050;background-color:#1e0010">接收到</span>
</span></span><span style="display:flex;"><span>lazy<span style="color:#f92672">.</span><span style="color:#a6e22e">brown</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fox</span> <span style="color:#960050;background-color:#1e0010">被队列</span> Q2 <span style="color:#960050;background-color:#1e0010">接收到</span>
</span></span><span style="display:flex;"><span>lazy<span style="color:#f92672">.</span><span style="color:#a6e22e">pink</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rabbit</span> <span style="color:#960050;background-color:#1e0010">虽然满足两个绑定但只被队列</span> Q2 <span style="color:#960050;background-color:#1e0010">接收一次</span>
</span></span><span style="display:flex;"><span>quick<span style="color:#f92672">.</span><span style="color:#a6e22e">brown</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fox</span> <span style="color:#960050;background-color:#1e0010">不匹配任何绑定不会被任何队列接收到会被丢弃</span>
</span></span><span style="display:flex;"><span>quick<span style="color:#f92672">.</span><span style="color:#a6e22e">orange</span><span style="color:#f92672">.</span><span style="color:#a6e22e">male</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rabbit</span> <span style="color:#960050;background-color:#1e0010">是四个单词不匹配任何绑定会被丢弃</span>
</span></span><span style="display:flex;"><span>lazy<span style="color:#f92672">.</span><span style="color:#a6e22e">orange</span><span style="color:#f92672">.</span><span style="color:#a6e22e">male</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rabbit</span> <span style="color:#960050;background-color:#1e0010">是四个单词但匹配</span> Q2
</span></span></code></pre></div><p><strong>当队列绑定关系是下列这种情况时需要引起注意</strong></p>
<p>当一个队列绑定键是#,那么这个队列将接收所有数据，就有点像 fanout 了</p>
<p>如果队列绑定键当中没有#和*出现，那么该队列绑定类型就是 direct 了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.rabbitmq.quickstart.exchange_topic<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Channel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.quickstart.exchange_direct.Consumer1<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.quickstart.utils.RabbitUtils<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.HashMap<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Map<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Publisher</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.使用工具类获取channel对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Channel channel <span style="color:#f92672">=</span> RabbitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.发送信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;quick.orange.rabbit&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;被队列 Q1Q2 接收到&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;lazy.orange.elephant&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;被队列 Q1Q2 接收到&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;quick.orange.fox&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;被队列 Q1 接收到&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;lazy.brown.fox&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;被队列 Q2 接收到&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;lazy.pink.rabbit&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;虽然满足两个绑定但只被队列 Q2 接收一次&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;quick.brown.fox&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;不匹配任何绑定不会被任何队列接收到会被丢弃&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;quick.orange.male.rabbit&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;是四个单词不匹配任何绑定会被丢弃&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;lazy.orange.male.rabbit&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;是四个单词但匹配 Q2&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> map<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            String routing_key <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            String body <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicPublish</span><span style="color:#f92672">(</span>ConsumerOne<span style="color:#f92672">.</span><span style="color:#a6e22e">exchange_name</span><span style="color:#f92672">,</span> routing_key<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> body<span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;发消息成功...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.rabbitmq.quickstart.exchange_topic<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.BuiltinExchangeType<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Channel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.DeliverCallback<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.quickstart.utils.RabbitUtils<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumerOne</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String exchange_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String queue_name1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Q1&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String queue_name2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Q2&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String routing_key_1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*.orange.*&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String routing_key_2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*.*.rabbit&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String routing_key_3 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lazy.#&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.获取Channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Channel channel <span style="color:#f92672">=</span> RabbitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.创建交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">exchangeDeclare</span><span style="color:#f92672">(</span>exchange_name<span style="color:#f92672">,</span> BuiltinExchangeType<span style="color:#f92672">.</span><span style="color:#a6e22e">TOPIC</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//3.创建队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span>queue_name1<span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span>queue_name2<span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//4.绑定队列和交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueBind</span><span style="color:#f92672">(</span>queue_name1<span style="color:#f92672">,</span>exchange_name<span style="color:#f92672">,</span>routing_key_1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueBind</span><span style="color:#f92672">(</span>queue_name2<span style="color:#f92672">,</span>exchange_name<span style="color:#f92672">,</span>routing_key_2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueBind</span><span style="color:#f92672">(</span>queue_name2<span style="color:#f92672">,</span>exchange_name<span style="color:#f92672">,</span>routing_key_3<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//5.消费消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        DeliverCallback okCallBack <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>consumerTag<span style="color:#f92672">,</span> message<span style="color:#f92672">)-&gt;{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>message<span style="color:#f92672">.</span><span style="color:#a6e22e">getBody</span><span style="color:#f92672">(),</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//消费者1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicConsume</span><span style="color:#f92672">(</span>queue_name1<span style="color:#f92672">,</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>okCallBack<span style="color:#f92672">,(</span>consumerTag<span style="color:#f92672">)-&gt;{});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//消费者2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//channel.basicConsume(queue_name2,true,okCallBack,(consumerTag)-&gt;{});
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="四-rabbitmq其他">四 RabbitMQ其他</h2>
<h3 id="41-死信的概念">4.1 死信的概念</h3>
<p><strong>死信</strong></p>
<p>顾名思义就是无法被消费的消息，字面意思可以这样理 解，一般来说，producer 将消息投递到 broker 或者直接到queue 里了，consumer 从 queue 取出消息 进行消费，但某些时候由于特定的原因导致 queue 中的某些消息无法被消费</p>
<p><strong>应用场景:</strong></p>
<p>为了保证订单业务的消息数据不丢失，需要使用到 RabbitMQ 的死信队列机制，当消息 消费发生异常时，将消息投入死信队列中.还有比如说: 用户在商城下单成功并点击去支付后在指定时 间未支付时自动失效</p>
<p><strong>死信消息的来源</strong></p>
<p>消息 TTL 过期</p>
<p>队列达到最大长度(队列满了，无法再添加数据到 mq 中)</p>
<p>消息被拒绝</p>
<p><strong>死信实战</strong></p>
<p><img src="/post/rabbitmq/assets/1682398773088.png"
	width="1349"
	height="635"
	srcset="/post/rabbitmq/assets/1682398773088_hu3ff6465a37095e97f5ded271b1b1f879_98351_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682398773088_hu3ff6465a37095e97f5ded271b1b1f879_98351_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682398773088"
	
	
		class="gallery-image" 
		data-flex-grow="212"
		data-flex-basis="509px"
	
></p>
<p><strong>生产者</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Channel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.quickstart.utils.RabbitUtils<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Publisher</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.使用工具类获取channel对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Channel channel <span style="color:#f92672">=</span> RabbitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.发信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">20</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1000</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicPublish</span><span style="color:#f92672">(</span>Consumer1<span style="color:#f92672">.</span><span style="color:#a6e22e">normal_exchange_name</span><span style="color:#f92672">,</span> Consumer1<span style="color:#f92672">.</span><span style="color:#a6e22e">normal_routing_key</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;info...&#34;</span><span style="color:#f92672">+</span>i<span style="color:#f92672">).</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>消费者</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.rabbitmq.quickstart.dead_letter<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.BuiltinExchangeType<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Channel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.DeliverCallback<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.client.Delivery<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.rabbitmq.quickstart.utils.RabbitUtils<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.HashMap<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Map<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Consumer1</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String normal_exchange_name <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;normal_exchange&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String normal_queue_name <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;normal_queue&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String dead_exchange_name <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dead_exchange&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String dead_queue_name <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dead_queue&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String normal_routing_key <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zhangsan&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String dead_routing_key <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;lisi&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.获取Channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Channel channel <span style="color:#f92672">=</span> RabbitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.创建正常的交换机和队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">exchangeDeclare</span><span style="color:#f92672">(</span>normal_exchange_name<span style="color:#f92672">,</span> BuiltinExchangeType<span style="color:#f92672">.</span><span style="color:#a6e22e">DIRECT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 我们要告知正常队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 1.过期时间  什么时候需要把信息变成死信
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 2.死信要发给哪个死信交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 3.设置发送给死信交换机时指定的routing key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;x-message-ttl&#34;</span><span style="color:#f92672">,</span><span style="color:#ae81ff">10000</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;x-dead-letter-exchange&#34;</span><span style="color:#f92672">,</span>dead_exchange_name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;x-dead-letter-routing-key&#34;</span><span style="color:#f92672">,</span>dead_routing_key<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span>normal_queue_name<span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span>map<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//3.创建死信交换机和队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">exchangeDeclare</span><span style="color:#f92672">(</span>dead_exchange_name<span style="color:#f92672">,</span> BuiltinExchangeType<span style="color:#f92672">.</span><span style="color:#a6e22e">DIRECT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueDeclare</span><span style="color:#f92672">(</span>dead_queue_name<span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//4.绑定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueBind</span><span style="color:#f92672">(</span>normal_queue_name<span style="color:#f92672">,</span>normal_exchange_name<span style="color:#f92672">,</span>normal_routing_key<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">queueBind</span><span style="color:#f92672">(</span>dead_queue_name<span style="color:#f92672">,</span>dead_exchange_name<span style="color:#f92672">,</span>dead_routing_key<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//5.消费死信队列的数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        channel<span style="color:#f92672">.</span><span style="color:#a6e22e">basicConsume</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            dead_queue_name<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">(</span>String consumerTag<span style="color:#f92672">,</span> Delivery message<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>message<span style="color:#f92672">.</span><span style="color:#a6e22e">getBody</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">},</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">(</span>consumerTag<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="42-延迟队列正常交换机ttl模拟出来的">4.2 延迟队列(正常交换机+TTL模拟出来的)</h3>
<p>延时队列,队列内部是有序的，最重要的特性就体现在它的延时属性上，延时队列中的元素是希望 在指定时间到了以后或之前取出和处理，简单来说，延时队列就是用来存放需要指定时间被处理的元素的队列。</p>
<p><strong>延迟队列使用场景</strong></p>
<p>1.订单在十分钟之内未支付则自动取消</p>
<p>2.新创建的店铺，如果在十天内都没有上传过商品，则自动发送消息提醒。</p>
<p>3.用户注册成功后，如果三天内没有登陆则进行短信提醒。</p>
<p>4.用户发起退款，如果三天内没有得到处理则通知相关运营人员。</p>
<p>5.预定会议后，需要在预定的时间点前十分钟通知各个与会人员参加会议</p>
<p>这些场景都有一个特点，需要在某个事件发生之后或者之前的指定时间点完成某一项任务，如： 发生订单生成事件，在十分钟之后检查该订单支付状态，然后将未支付的订单进行关闭；看起来似乎</p>
<p>使用定时任务，一直轮询数据，每秒查一次，取出需要被处理的数据，然后处理不就完事了吗？如果 数据量比较少，确实可以这样做，比如：对于“如果账单一周内未支付则进行自动结算”这样的需求，</p>
<p>如果对于时间不是严格限制，而是宽松意义上的一周，那么每天晚上跑个定时任务检查一下所有未支 付的账单，确实也是一个可行的方案。但对于数据量比较大，并且时效性较强的场景，如：“订单十 分钟内未支付则关闭“，短期内未支付的订单数据可能会有很多，活动期间甚至会达到百万甚至千万 级别，对这么庞大的数据量仍旧使用轮询的方式显然是不可取的，很可能在一秒内无法完成所有订单 的检查，同时会给数据库带来很大压力，无法满足业务要求而且性能低下</p>
<h3 id="43-整合-springboot">4.3 整合 springboot</h3>
<p><strong>引入依赖</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--RabbitMQ 依赖--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>fastjson<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>1.2.47<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.projectlombok<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>lombok<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--RabbitMQ 测试依赖--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.amqp<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-rabbit-test<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p><strong>修改Yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">spring.rabbitmq.host=182.92.234.71</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">spring.rabbitmq.port=5672</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">spring.rabbitmq.username=admin</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">spring.rabbitmq.password=123</span>
</span></span></code></pre></div><p><strong>配置类</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TtlQueueConfig</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String X_EXCHANGE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String QUEUE_A <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;QA&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String QUEUE_B <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;QB&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String Y_DEAD_LETTER_EXCHANGE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Y&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String DEAD_LETTER_QUEUE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;QD&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// 声明 xExchange
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#a6e22e">@Bean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;xExchange&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> DirectExchange <span style="color:#a6e22e">xExchange</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DirectExchange<span style="color:#f92672">(</span>X_EXCHANGE<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// 声明 xExchange
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#a6e22e">@Bean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;yExchange&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> DirectExchange <span style="color:#a6e22e">yExchange</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DirectExchange<span style="color:#f92672">(</span>Y_DEAD_LETTER_EXCHANGE<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">//声明队列 A ttl 为 10s 并绑定到对应的死信交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#a6e22e">@Bean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;queueA&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> Queue <span style="color:#a6e22e">queueA</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>     Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> args <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//声明当前队列绑定的死信交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     args<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;x-dead-letter-exchange&#34;</span><span style="color:#f92672">,</span> Y_DEAD_LETTER_EXCHANGE<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//声明当前队列的死信路由 key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     args<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;x-dead-letter-routing-key&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;YD&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//声明队列的 TTL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     args<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;x-message-ttl&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">10000</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> QueueBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">durable</span><span style="color:#f92672">(</span>QUEUE_A<span style="color:#f92672">).</span><span style="color:#a6e22e">withArguments</span><span style="color:#f92672">(</span>args<span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// 声明队列 A 绑定 X 交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> Binding <span style="color:#a6e22e">queueaBindingX</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Qualifier</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;queueA&#34;</span><span style="color:#f92672">)</span> Queue queueA<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#a6e22e">@Qualifier</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;xExchange&#34;</span><span style="color:#f92672">)</span> DirectExchange xExchange<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#66d9ef">return</span> BindingBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span>queueA<span style="color:#f92672">).</span><span style="color:#a6e22e">to</span><span style="color:#f92672">(</span>xExchange<span style="color:#f92672">).</span><span style="color:#a6e22e">with</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;XA&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">//声明队列 B ttl 为 40s 并绑定到对应的死信交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#a6e22e">@Bean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;queueB&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> Queue <span style="color:#a6e22e">queueB</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>     Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> args <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//声明当前队列绑定的死信交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     args<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;x-dead-letter-exchange&#34;</span><span style="color:#f92672">,</span> Y_DEAD_LETTER_EXCHANGE<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//声明当前队列的死信路由 key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     args<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;x-dead-letter-routing-key&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;YD&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//声明队列的 TTL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     args<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;x-message-ttl&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">40000</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#66d9ef">return</span> QueueBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">durable</span><span style="color:#f92672">(</span>QUEUE_B<span style="color:#f92672">).</span><span style="color:#a6e22e">withArguments</span><span style="color:#f92672">(</span>args<span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">//声明队列 B 绑定 X 交换机
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> Binding <span style="color:#a6e22e">queuebBindingX</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">@Qualifier</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;queueB&#34;</span><span style="color:#f92672">)</span> Queue queue1B<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#a6e22e">@Qualifier</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;xExchange&#34;</span><span style="color:#f92672">)</span> DirectExchange xExchange<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#66d9ef">return</span> BindingBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span>queue1B<span style="color:#f92672">).</span><span style="color:#a6e22e">to</span><span style="color:#f92672">(</span>xExchange<span style="color:#f92672">).</span><span style="color:#a6e22e">with</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;XB&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">//声明死信队列 QD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#a6e22e">@Bean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;queueD&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> Queue <span style="color:#a6e22e">queueD</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Queue<span style="color:#f92672">(</span>DEAD_LETTER_QUEUE<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">//声明死信队列 QD 绑定关系
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> Binding <span style="color:#a6e22e">deadLetterBindingQAD</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Qualifier</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;queueD&#34;</span><span style="color:#f92672">)</span> Queue queueD<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#a6e22e">@Qualifier</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;yExchange&#34;</span><span style="color:#f92672">)</span> DirectExchange yExchange<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#66d9ef">return</span> BindingBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span>queueD<span style="color:#f92672">).</span><span style="color:#a6e22e">to</span><span style="color:#f92672">(</span>yExchange<span style="color:#f92672">).</span><span style="color:#a6e22e">with</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;YD&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>生产者</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ttl&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SendMsgController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> RabbitTemplate rabbitTemplate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;sendMsg/{message}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sendMsg</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span> String message<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;当前时间：{},发送一条信息给两个 TTL 队列:{}&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">(),</span> message<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        rabbitTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">convertAndSend</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;XA&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;消息来自 ttl 为 10S 的队列: &#34;</span> <span style="color:#f92672">+</span> message<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        rabbitTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">convertAndSend</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;XB&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;消息来自 ttl 为 40S 的队列: &#34;</span> <span style="color:#f92672">+</span> message<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>消费者</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeadLetterQueueConsumer</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RabbitListener</span><span style="color:#f92672">(</span>queues <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;QD&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">receiveD</span><span style="color:#f92672">(</span>Message message<span style="color:#f92672">,</span> Channel channel<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        String msg <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>message<span style="color:#f92672">.</span><span style="color:#a6e22e">getBody</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;当前时间：{},收到死信队列信息{}&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">().</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> msg<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">发起一个请求</span> http<span style="color:#f92672">:</span><span style="color:#75715e">//localhost:8080/ttl/sendMsg/O(∩_∩)O哈哈~
</span></span></span></code></pre></div><h3 id="44-幂等性">4.4 幂等性</h3>
<p>用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。</p>
<p>举个最简单的例子，那就是支付，用户购买商品后支付，支付扣款成功，但是返回结果的时候网络异常， 此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结果成功，用户查询余额发现多扣钱 了，流水记录也变成了两条。在以前的单应用系统中，我们只需要把数据操作放入事务中即可，发生错误 立即回滚，但是再响应客户端的时候也有可能出现网络中断或者异常等等</p>
<h4 id="441-消息重复消费">4.4.1 消息重复消费</h4>
<p>消费者在消费 MQ 中的消息时，MQ 已把消息发送给消费者，消费者在给MQ 返回 ack 时网络中断，</p>
<p>故 MQ 未收到确认信息，该条消息会重新发给其他的消费者，或者在网络重连后再次发送给该消费者，但实际上该消费者已成功消费了该条消息，造成消费者消费了重复的消息。</p>
<h4 id="442-解决思路">4.4.2 解决思路</h4>
<p>MQ 消费者的幂等性的解决一般使用全局 ID 或者写个唯一标识比如时间戳 或者 UUID 或者订单消费</p>
<p>者消费 MQ 中的消息也可利用 MQ 的该 id 来判断，或者可按自己的规则生成一个全局唯一 id，每次消费消 息时用该 id 先判断该消息是否已消费过。</p>
<h4 id="443-消费端的幂等性保障">4.4.3 消费端的幂等性保障</h4>
<p>在海量订单生成的业务高峰期，生产端有可能就会重复发生了消息，这时候消费端就要实现幂等性，</p>
<p>这就意味着我们的消息永远不会被消费多次，即使我们收到了一样的消息。业界主流的幂等性有两种操作:a.</p>
<p>唯一 ID+指纹码机制,利用数据库主键去重, b.利用 redis 的原子性去实现</p>
<h2 id="五-rabbitmq-集群">五 RabbitMQ 集群</h2>
<h3 id="51-使用集群的原因">5.1 使用集群的原因</h3>
<p>最开始我们介绍了如何安装及运行 RabbitMQ 服务，不过这些是单机版的，无法满足目前真实应用的 要求。如果 RabbitMQ 服务器遇到内存崩溃、机器掉电或者主板故障等情况，该怎么办？单台 RabbitMQ</p>
<p>服务器可以满足每秒 1000 条消息的吞吐量，那么如果应用需要 RabbitMQ 服务满足每秒 10 万条消息的吞吐量呢？购买昂贵的服务器来增强单机 RabbitMQ 务的性能显得捉襟见肘，搭建一个 RabbitMQ 集群才是 解决实际问题的关键.</p>
<h5 id="511-集群的两种模式">5.1.1 集群的两种模式</h5>
<p>说到集群，小伙伴们可能第一个问题是，如果我有一个 RabbitMQ 集群，那么是不是我的消息集群中的每一个实例都保存一份呢？</p>
<p>这其实就涉及到 RabbitMQ 集群的两种模式：</p>
<ul>
<li>
<p><strong>普通集群</strong></p>
<p>普通集群模式，就是将 RabbitMQ 部署到多台服务器上，每个服务器启动一个 RabbitMQ 实例，多个实例之间进行消息通信。</p>
<p>此时我们创建的队列 Queue，它的元数据（主要就是 Queue 的一些配置信息）会在所有的 RabbitMQ 实例中进行同步，但是队列中的消息只会存在于一个 RabbitMQ 实例上，而不会同步到其他队列。</p>
<p><img src="/post/rabbitmq/assets/d8cb4fc480d21184afa8285abcb2511d.png"
	width="1382"
	height="774"
	srcset="/post/rabbitmq/assets/d8cb4fc480d21184afa8285abcb2511d_hu0fad735597a74182e4a9ce677f11d2bb_91474_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/d8cb4fc480d21184afa8285abcb2511d_hu0fad735597a74182e4a9ce677f11d2bb_91474_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="178"
		data-flex-basis="428px"
	
></p>
</li>
<li>
<p><strong>镜像集群</strong></p>
</li>
</ul>
<p>它和普通集群最大的区别在于 消息数据和Queue原数据不再是单独存储在一台机器上，而是同时存储在多台机器上。</p>
<p><img src="/post/rabbitmq/assets/640f79d7e9c47aac744e995757ae22bf.png"
	width="1622"
	height="776"
	srcset="/post/rabbitmq/assets/640f79d7e9c47aac744e995757ae22bf_hu3db573ed4ea6724b803778ec213b96b1_74208_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/640f79d7e9c47aac744e995757ae22bf_hu3db573ed4ea6724b803778ec213b96b1_74208_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="209"
		data-flex-basis="501px"
	
></p>
<h3 id="52-普通集群搭建步骤">5.2 普通集群搭建步骤</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>1.修改 3 台机器的主机名称
</span></span><span style="display:flex;"><span>vim /etc/hostname
</span></span><span style="display:flex;"><span>2.配置各个节点的 hosts 文件，让各个节点都能互相识别对方
</span></span><span style="display:flex;"><span>vim /etc/hosts
</span></span><span style="display:flex;"><span>10.211.55.74 node1
</span></span><span style="display:flex;"><span>10.211.55.75 node2
</span></span><span style="display:flex;"><span>10.211.55.76 node3
</span></span><span style="display:flex;"><span>3.以确保各个节点的 cookie 文件使用的是同一个值
</span></span><span style="display:flex;"><span>在 node1 上执行远程操作命令
</span></span><span style="display:flex;"><span>scp /var/lib/rabbitmq/.erlang.cookie root@node2:/var/lib/rabbitmq/.erlang.cookie
</span></span><span style="display:flex;"><span>scp /var/lib/rabbitmq/.erlang.cookie root@node3:/var/lib/rabbitmq/.erlang.cookie
</span></span><span style="display:flex;"><span>================================================
</span></span><span style="display:flex;"><span>4.启动 RabbitMQ 服务,顺带启动 Erlang 虚拟机和 RbbitMQ 应用服务(在三台节点上分别执行以
</span></span><span style="display:flex;"><span>下命令)
</span></span><span style="display:flex;"><span>rabbitmq-server -detached
</span></span><span style="display:flex;"><span>5.在节点 2 执行
</span></span><span style="display:flex;"><span>rabbitmqctl stop_app
</span></span><span style="display:flex;"><span>(rabbitmqctl stop 会将Erlang 虚拟机关闭，rabbitmqctl stop_app 只关闭 RabbitMQ 服务)
</span></span><span style="display:flex;"><span>rabbitmqctl reset
</span></span><span style="display:flex;"><span>rabbitmqctl join_cluster rabbit@node1
</span></span><span style="display:flex;"><span>rabbitmqctl start_app(只启动应用服务)
</span></span><span style="display:flex;"><span>6.在节点 3 执行
</span></span><span style="display:flex;"><span>rabbitmqctl stop_app
</span></span><span style="display:flex;"><span>rabbitmqctl reset
</span></span><span style="display:flex;"><span>rabbitmqctl join_cluster rabbit@node2
</span></span><span style="display:flex;"><span>rabbitmqctl start_app
</span></span><span style="display:flex;"><span>7.集群状态
</span></span><span style="display:flex;"><span>rabbitmqctl cluster_status
</span></span><span style="display:flex;"><span>8.需要重新设置用户
</span></span><span style="display:flex;"><span>创建账号
</span></span><span style="display:flex;"><span>rabbitmqctl add_user admin 123
</span></span><span style="display:flex;"><span>设置用户角色
</span></span><span style="display:flex;"><span>rabbitmqctl set_user_tags admin administrator
</span></span><span style="display:flex;"><span>设置用户权限
</span></span><span style="display:flex;"><span>rabbitmqctl set_permissions -p &#34;/&#34; admin &#34;.*&#34; &#34;.*&#34; &#34;.*&#34;
</span></span><span style="display:flex;"><span>9.解除集群节点(node2 和 node3 机器分别执行)
</span></span><span style="display:flex;"><span>rabbitmqctl stop_app
</span></span><span style="display:flex;"><span>rabbitmqctl reset
</span></span><span style="display:flex;"><span>rabbitmqctl start_app
</span></span><span style="display:flex;"><span>rabbitmqctl cluster_status
</span></span><span style="display:flex;"><span>rabbitmqctl forget_cluster_node rabbit@node2(node1 机器上执行)
</span></span></code></pre></div><h3 id="53-搭建镜像集群">5.3 搭建镜像集群</h3>
<p>所谓的镜像集群模式并不需要额外搭建，只需要我们将队列配置为镜像队列即可。</p>
<p>镜像队列(Mirror Queue)的机制，可以将队列<strong>镜像</strong>到集群中的其他 Broker 节点之上，如果集群中 的一个节点失效了，队列能自动地切换到镜像中的另一个节点上以保证服务的可用性</p>
<p><strong>搭建步骤</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>1.启动三台集群节点
</span></span><span style="display:flex;"><span>2.随便找一个节点添加 policy
</span></span></code></pre></div><p><img src="/post/rabbitmq/assets/1682399882754.png"
	width="1459"
	height="792"
	srcset="/post/rabbitmq/assets/1682399882754_hua8d0a897e2f6dd8f48a5797d75a0d038_251981_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682399882754_hua8d0a897e2f6dd8f48a5797d75a0d038_251981_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682399882754"
	
	
		class="gallery-image" 
		data-flex-grow="184"
		data-flex-basis="442px"
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>3.在 node1 上创建一个队列发送一条消息，队列存在镜像队列
</span></span></code></pre></div><p><img src="/post/rabbitmq/assets/1682399911404.png"
	width="726"
	height="516"
	srcset="/post/rabbitmq/assets/1682399911404_hu9497032c4acded63cbcc5eea8285a3fd_95665_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682399911404_hu9497032c4acded63cbcc5eea8285a3fd_95665_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682399911404"
	
	
		class="gallery-image" 
		data-flex-grow="140"
		data-flex-basis="337px"
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>4.停掉 node1 之后发现 node2 成为镜像队列
</span></span></code></pre></div><p><img src="/post/rabbitmq/assets/1682399938056.png"
	width="841"
	height="594"
	srcset="/post/rabbitmq/assets/1682399938056_hu5c6098303cf9b5af48969d06b16fc5ee_132222_480x0_resize_box_3.png 480w, /post/rabbitmq/assets/1682399938056_hu5c6098303cf9b5af48969d06b16fc5ee_132222_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682399938056"
	
	
		class="gallery-image" 
		data-flex-grow="141"
		data-flex-basis="339px"
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>5.就算整个集群只剩下一台机器了 依然能消费队列里面的消息
</span></span><span style="display:flex;"><span>说明队列里面的消息被镜像队列传递到相应机器里面了
</span></span></code></pre></div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/rabbitmq/">RabbitMQ</a>
        
            <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

     
    
        
    <div class="disqus-container">
    
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2023 Cheney Site
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.17.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/ribbon.min.js"
    integrity="sha384-UEK8ZiP3VgFNP8KnKMKDmd4pAUAOJ59Y2Jo3ED2Z5qKQf6HLHovMxq7Beb9CLPUe"
    crossorigin="anonymous"
    size="300"
    alpha="0.6"
    zindex="-1"
    defer
></script>

<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/nprogress.min.js"
    integrity="sha384-bHDlAEUFxsRI7JfULv3DTpL2IXbbgn4JHQJibgo5iiXSK6Iu8muwqHANhun74Cqg"
    crossorigin="anonymous"
></script>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/css/nprogress.css"
    integrity="sha384-KJyhr2syt5+4M9Pz5dipCvTrtvOmLk/olWVdfhAp858UCa64Ia5GFpTN7+G4BWpE"
    crossorigin="anonymous"
/>
<script>
    NProgress.start();
    document.addEventListener("readystatechange", () => {
        if (document.readyState === "interactive") NProgress.inc(0.8);
        if (document.readyState === "complete") NProgress.done();
    });
</script>
    </body>
</html>
