<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='学习目标
掌握RestTemplate的使用 知道什么是SpringCloud 掌握搭建Eureka注册中心 了解Ribbon的负载均衡 理解Hystrix的熔断原理 系统架构演变 ​	随着互联网的发展，网站应用的规模不断扩大。需求的激增，带来的是技术上的压力。系统架构也因此也不断的演进、升级、迭代。从单一应用，到垂直拆分，到分布式服务，到SOA，以及现在火热的微服务架构，还有Google带领下来势汹涌的Service Mesh。我们到底是该乘坐微服务的船只驶向远方，还是偏安一隅得过且过？ ​	其实生活不止眼前的苟且，还有诗和远方。所以我们今天就回顾历史，看一看系统架构演变的历程；把握现在，学习现在最火的技术架构；展望未来，争取成为一名优秀的Java工程师。
1.1 单体架构 ​	当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。单体架构就是将所有的功能、数据库、文件都部署在一台机器上，俗称All-In-One
1.2 单体集群 单体集群,就是将单体架构复制几份
1.3 分布式服务 分布式,是指将整个系统按照功能拆分,部署到不同的服务器上,这样即适合为某个功能做集群,又合适重复功能的复用
1.4 服务治理架构（SOA） SOA,全称Service-Oriented Architecture,面向服务的架构. 它把项目拆成独立的服务,对外提供.服务的提供方和消费方由企业总线统一管理
以前出现了什么问题？
服务越来越多，需要管理每个服务的地址 调用关系错综复杂，难以理清依赖关系 服务过多，服务状态难以管理，无法根据服务情况动态管理 服务治理要做什么？
服务注册中心，实现服务自动注册和发现，无需人为记录服务地址 服务自动订阅，服务列表自动推送，服务调用透明化，无需关心依赖关系 动态监控服务状态监控报告，人为控制服务状态 缺点：
服务间会有依赖关系，一旦某个环节出错会影响较大 服务关系复杂，运维、测试部署困难 1.5 微服务 微服务架构,是SOA的升华,在SOA的基础上更加细粒度的服务化,组件化.
因此两者非常容易混淆，但其实有一些差别： 微服务的特点：
单一职责：微服务中每一个服务都对应唯一的业务能力，做到单一职责 微：微服务的服务拆分粒度很小，例如一个用户管理就可以作为一个服务。每个服务虽小，但“五脏俱全”。 面向服务：面向服务是说每个服务都要对外暴露Rest风格服务HTTP接口API。并不关心服务的技术实现，做到与平台和语言无关，也不限定用什么技术实现，只要提供Rest的HTTP接口即可。 自治：自治是说服务间互相独立，互不干扰 团队独立：每个服务都是一个独立的开发团队，人数不能过多。 技术独立：因为是面向服务，提供Rest接口，使用什么技术没有别人干涉 前后端分离：采用前后端分离开发，提供统一Rest接口，后端不用再为PC、移动段开发不同接口 数据库分离：每个服务都使用自己的数据源 部署独立，服务间虽然有调用，但要做到服务重启不影响其它服务。有利于持续集成和持续交付。每个服务都是独立的组件，可复用，可替换，降低耦合，易维护 服务调用方式 2.1 RPC和HTTP 无论是微服务还是SOA，都面临着服务间的远程调用。那么服务间的远程调用方式有哪些呢？ 常见的远程调用方式有以下2种：
RPC： Remote Produce Call远程过程调用，类似的还有RMI（remote method invoke）。自定义数据格式，基于原生TCP通信，速度快，效率高。早期的webservice，现在热门的dubbo，都是RPC的典型代表。 Http： http其实是一种网络传输协议，基于TCP，规定了数据传输的格式。 现在客户端浏览器与服务端通信基本都是采用Http协议，也可以用来进行远程服务调用。缺点是消息封装臃肿，优势是对服务的提供和调用方没有任何技术限定，自由灵活，更符合微服务理念。现在热门的Rest风格，就可以通过http协议来实现。 如果你们公司全部采用Java技术栈，那么使用Dubbo作为微服务架构是一个不错的选择。 相反，如果公司的技术栈多样化，而且你更青睐Spring家族，那么SpringCloud搭建微服务是不二之选。在我们的项目中，我们会选择SpringCloud套件，因此我们会使用Http方式来实现服务间调用。
2.2 Http客户端工具 既然微服务选择了Http，那么我们就需要考虑自己来实现对请求和响应的处理。不过开源世界已经有很 多的http客户端工具，能够帮助我们做这些事情，例如：'>
<title></title>

<link rel='canonical' href='https://cheneycqg.github.io/post/springcloudalibaba/'>

<link rel="stylesheet" href="/scss/style.min.83fdf04f357d6c514ee15e600463b045549e8b40c428f14454adecaa742b352f.css"><meta property='og:title' content=''>
<meta property='og:description' content='学习目标
掌握RestTemplate的使用 知道什么是SpringCloud 掌握搭建Eureka注册中心 了解Ribbon的负载均衡 理解Hystrix的熔断原理 系统架构演变 ​	随着互联网的发展，网站应用的规模不断扩大。需求的激增，带来的是技术上的压力。系统架构也因此也不断的演进、升级、迭代。从单一应用，到垂直拆分，到分布式服务，到SOA，以及现在火热的微服务架构，还有Google带领下来势汹涌的Service Mesh。我们到底是该乘坐微服务的船只驶向远方，还是偏安一隅得过且过？ ​	其实生活不止眼前的苟且，还有诗和远方。所以我们今天就回顾历史，看一看系统架构演变的历程；把握现在，学习现在最火的技术架构；展望未来，争取成为一名优秀的Java工程师。
1.1 单体架构 ​	当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。单体架构就是将所有的功能、数据库、文件都部署在一台机器上，俗称All-In-One
1.2 单体集群 单体集群,就是将单体架构复制几份
1.3 分布式服务 分布式,是指将整个系统按照功能拆分,部署到不同的服务器上,这样即适合为某个功能做集群,又合适重复功能的复用
1.4 服务治理架构（SOA） SOA,全称Service-Oriented Architecture,面向服务的架构. 它把项目拆成独立的服务,对外提供.服务的提供方和消费方由企业总线统一管理
以前出现了什么问题？
服务越来越多，需要管理每个服务的地址 调用关系错综复杂，难以理清依赖关系 服务过多，服务状态难以管理，无法根据服务情况动态管理 服务治理要做什么？
服务注册中心，实现服务自动注册和发现，无需人为记录服务地址 服务自动订阅，服务列表自动推送，服务调用透明化，无需关心依赖关系 动态监控服务状态监控报告，人为控制服务状态 缺点：
服务间会有依赖关系，一旦某个环节出错会影响较大 服务关系复杂，运维、测试部署困难 1.5 微服务 微服务架构,是SOA的升华,在SOA的基础上更加细粒度的服务化,组件化.
因此两者非常容易混淆，但其实有一些差别： 微服务的特点：
单一职责：微服务中每一个服务都对应唯一的业务能力，做到单一职责 微：微服务的服务拆分粒度很小，例如一个用户管理就可以作为一个服务。每个服务虽小，但“五脏俱全”。 面向服务：面向服务是说每个服务都要对外暴露Rest风格服务HTTP接口API。并不关心服务的技术实现，做到与平台和语言无关，也不限定用什么技术实现，只要提供Rest的HTTP接口即可。 自治：自治是说服务间互相独立，互不干扰 团队独立：每个服务都是一个独立的开发团队，人数不能过多。 技术独立：因为是面向服务，提供Rest接口，使用什么技术没有别人干涉 前后端分离：采用前后端分离开发，提供统一Rest接口，后端不用再为PC、移动段开发不同接口 数据库分离：每个服务都使用自己的数据源 部署独立，服务间虽然有调用，但要做到服务重启不影响其它服务。有利于持续集成和持续交付。每个服务都是独立的组件，可复用，可替换，降低耦合，易维护 服务调用方式 2.1 RPC和HTTP 无论是微服务还是SOA，都面临着服务间的远程调用。那么服务间的远程调用方式有哪些呢？ 常见的远程调用方式有以下2种：
RPC： Remote Produce Call远程过程调用，类似的还有RMI（remote method invoke）。自定义数据格式，基于原生TCP通信，速度快，效率高。早期的webservice，现在热门的dubbo，都是RPC的典型代表。 Http： http其实是一种网络传输协议，基于TCP，规定了数据传输的格式。 现在客户端浏览器与服务端通信基本都是采用Http协议，也可以用来进行远程服务调用。缺点是消息封装臃肿，优势是对服务的提供和调用方没有任何技术限定，自由灵活，更符合微服务理念。现在热门的Rest风格，就可以通过http协议来实现。 如果你们公司全部采用Java技术栈，那么使用Dubbo作为微服务架构是一个不错的选择。 相反，如果公司的技术栈多样化，而且你更青睐Spring家族，那么SpringCloud搭建微服务是不二之选。在我们的项目中，我们会选择SpringCloud套件，因此我们会使用Http方式来实现服务间调用。
2.2 Http客户端工具 既然微服务选择了Http，那么我们就需要考虑自己来实现对请求和响应的处理。不过开源世界已经有很 多的http客户端工具，能够帮助我们做这些事情，例如：'>
<meta property='og:url' content='https://cheneycqg.github.io/post/springcloudalibaba/'>
<meta property='og:site_name' content='Cheney Site'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' />
<meta name="twitter:title" content="">
<meta name="twitter:description" content="学习目标
掌握RestTemplate的使用 知道什么是SpringCloud 掌握搭建Eureka注册中心 了解Ribbon的负载均衡 理解Hystrix的熔断原理 系统架构演变 ​	随着互联网的发展，网站应用的规模不断扩大。需求的激增，带来的是技术上的压力。系统架构也因此也不断的演进、升级、迭代。从单一应用，到垂直拆分，到分布式服务，到SOA，以及现在火热的微服务架构，还有Google带领下来势汹涌的Service Mesh。我们到底是该乘坐微服务的船只驶向远方，还是偏安一隅得过且过？ ​	其实生活不止眼前的苟且，还有诗和远方。所以我们今天就回顾历史，看一看系统架构演变的历程；把握现在，学习现在最火的技术架构；展望未来，争取成为一名优秀的Java工程师。
1.1 单体架构 ​	当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。单体架构就是将所有的功能、数据库、文件都部署在一台机器上，俗称All-In-One
1.2 单体集群 单体集群,就是将单体架构复制几份
1.3 分布式服务 分布式,是指将整个系统按照功能拆分,部署到不同的服务器上,这样即适合为某个功能做集群,又合适重复功能的复用
1.4 服务治理架构（SOA） SOA,全称Service-Oriented Architecture,面向服务的架构. 它把项目拆成独立的服务,对外提供.服务的提供方和消费方由企业总线统一管理
以前出现了什么问题？
服务越来越多，需要管理每个服务的地址 调用关系错综复杂，难以理清依赖关系 服务过多，服务状态难以管理，无法根据服务情况动态管理 服务治理要做什么？
服务注册中心，实现服务自动注册和发现，无需人为记录服务地址 服务自动订阅，服务列表自动推送，服务调用透明化，无需关心依赖关系 动态监控服务状态监控报告，人为控制服务状态 缺点：
服务间会有依赖关系，一旦某个环节出错会影响较大 服务关系复杂，运维、测试部署困难 1.5 微服务 微服务架构,是SOA的升华,在SOA的基础上更加细粒度的服务化,组件化.
因此两者非常容易混淆，但其实有一些差别： 微服务的特点：
单一职责：微服务中每一个服务都对应唯一的业务能力，做到单一职责 微：微服务的服务拆分粒度很小，例如一个用户管理就可以作为一个服务。每个服务虽小，但“五脏俱全”。 面向服务：面向服务是说每个服务都要对外暴露Rest风格服务HTTP接口API。并不关心服务的技术实现，做到与平台和语言无关，也不限定用什么技术实现，只要提供Rest的HTTP接口即可。 自治：自治是说服务间互相独立，互不干扰 团队独立：每个服务都是一个独立的开发团队，人数不能过多。 技术独立：因为是面向服务，提供Rest接口，使用什么技术没有别人干涉 前后端分离：采用前后端分离开发，提供统一Rest接口，后端不用再为PC、移动段开发不同接口 数据库分离：每个服务都使用自己的数据源 部署独立，服务间虽然有调用，但要做到服务重启不影响其它服务。有利于持续集成和持续交付。每个服务都是独立的组件，可复用，可替换，降低耦合，易维护 服务调用方式 2.1 RPC和HTTP 无论是微服务还是SOA，都面临着服务间的远程调用。那么服务间的远程调用方式有哪些呢？ 常见的远程调用方式有以下2种：
RPC： Remote Produce Call远程过程调用，类似的还有RMI（remote method invoke）。自定义数据格式，基于原生TCP通信，速度快，效率高。早期的webservice，现在热门的dubbo，都是RPC的典型代表。 Http： http其实是一种网络传输协议，基于TCP，规定了数据传输的格式。 现在客户端浏览器与服务端通信基本都是采用Http协议，也可以用来进行远程服务调用。缺点是消息封装臃肿，优势是对服务的提供和调用方没有任何技术限定，自由灵活，更符合微服务理念。现在热门的Rest风格，就可以通过http协议来实现。 如果你们公司全部采用Java技术栈，那么使用Dubbo作为微服务架构是一个不错的选择。 相反，如果公司的技术栈多样化，而且你更青睐Spring家族，那么SpringCloud搭建微服务是不二之选。在我们的项目中，我们会选择SpringCloud套件，因此我们会使用Http方式来实现服务间调用。
2.2 Http客户端工具 既然微服务选择了Http，那么我们就需要考虑自己来实现对请求和响应的处理。不过开源世界已经有很 多的http客户端工具，能够帮助我们做这些事情，例如：">
    <link rel="shortcut icon" href="/img/avatar.jpg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu8558358a36cd5b5f5be6e79535866837_28999_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Cheney Site</a></h1>
            <h2 class="site-description">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://cheneycqg.github.io/zh-cn/" >中文</option>
                        
                            <option value="https://cheneycqg.github.io/ar/" >عربي</option>
                        
                            <option value="https://cheneycqg.github.io/" selected></option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#11-单体架构">1.1 单体架构</a></li>
    <li><a href="#12-单体集群">1.2 单体集群</a></li>
    <li><a href="#13-分布式服务">1.3 分布式服务</a></li>
    <li><a href="#14-服务治理架构soa">1.4 服务治理架构（SOA）</a></li>
    <li><a href="#15-微服务">1.5 微服务</a></li>
  </ul>

  <ul>
    <li><a href="#21-rpc和http">2.1 RPC和HTTP</a></li>
    <li><a href="#22-http客户端工具">2.2 Http客户端工具</a></li>
  </ul>

  <ul>
    <li><a href="#31-搭建父工程">3.1 搭建父工程</a></li>
    <li><a href="#32-搭建服务提供者">3.2 搭建服务提供者</a></li>
    <li><a href="#33-搭建服务消费者">3.3 搭建服务消费者</a></li>
    <li><a href="#34-微服务调用问题">3.4 微服务调用问题</a></li>
  </ul>

  <ul>
    <li><a href="#41-简介">4.1 简介</a></li>
    <li><a href="#42-版本说明">4.2 版本说明</a></li>
  </ul>

  <ul>
    <li><a href="#51-认识eureka">5.1 认识Eureka</a></li>
    <li><a href="#52-基本架构">5.2 基本架构</a></li>
    <li><a href="#53-快速入门">5.3 快速入门</a>
      <ul>
        <li><a href="#531-搭建服务注册中心">5.3.1 搭建服务注册中心</a></li>
        <li><a href="#532-服务注册">5.3.2 服务注册</a></li>
        <li><a href="#533-服务发现与消费">5.3.3 服务发现与消费</a></li>
      </ul>
    </li>
    <li><a href="#54-eureka详解">5.4 Eureka详解</a>
      <ul>
        <li><a href="#541-基础架构">5.4.1 基础架构</a></li>
        <li><a href="#543-eureka属性配置了解">5.4.3 Eureka属性配置(了解)</a></li>
      </ul>
    </li>
    <li><a href="#55-搭建高可用的eureka-server集群">5.5 搭建高可用的Eureka Server集群</a>
      <ul>
        <li><a href="#551-服务同步">5.5.1 服务同步</a></li>
        <li><a href="#552-搭建高可用的eureka-server">5.5.2 搭建高可用的Eureka Server</a></li>
        <li><a href="#554启动三台eureka-server">5.5.4.启动三台Eureka Server</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#61-启动两个服务实例">6.1 启动两个服务实例</a></li>
    <li><a href="#62-开启负载均衡">6.2 开启负载均衡</a></li>
    <li><a href="#63-负载均衡原理">6.3 负载均衡原理</a></li>
    <li><a href="#64-切换负载均衡策略">6.4 切换负载均衡策略</a></li>
    <li><a href="#65-ribbon的饥饿加载和懒加载">6.5 Ribbon的饥饿加载和懒加载</a></li>
  </ul>

  <ul>
    <li><a href="#1nacos-概述">1.Nacos 概述</a></li>
    <li><a href="#2nacosa安装">2.Nacosa安装</a></li>
    <li><a href="#3nacos-快速入门">3.Nacos 快速入门</a></li>
    <li><a href="#4nacos与eureka的区别">4.Nacos与Eureka的区别</a></li>
    <li><a href="#5nacos多级服务存储模型">5.Nacos多级服务存储模型</a>
      <ul>
        <li><a href="#1多级服务存储模型介绍">1.多级服务存储模型介绍</a></li>
        <li><a href="#2集群优先负载均衡策略">2.集群优先负载均衡策略</a></li>
      </ul>
    </li>
    <li><a href="#6服务实例的权重设置">6.服务实例的权重设置</a></li>
    <li><a href="#7nacos多环境隔离-namespace">7.Nacos多环境隔离-namespace</a></li>
  </ul>

  <ul>
    <li><a href="#1快速入门">1.快速入门</a></li>
    <li><a href="#2配置动态刷新">2.配置动态刷新</a></li>
    <li><a href="#3多环境配置与共享">3.多环境配置与共享</a></li>
  </ul>

  <ul>
    <li><a href="#1nacos集群架构">1.Nacos集群架构</a></li>
    <li><a href="#2nacos集群搭建步骤">2.Nacos集群搭建步骤</a>
      <ul>
        <li><a href="#21-第一步设置集群">2.1 第一步设置集群</a></li>
        <li><a href="#22-第二步配置集群配置文件">2.2 第二步配置集群配置文件</a></li>
        <li><a href="#23-第三步初始化-nacos的数据库为mysql数据库">2.3 第三步初始化 nacos的数据库为mysql数据库</a></li>
        <li><a href="#24-第四步集群模式部署启动">2.4 第四步集群模式部署启动</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#1-简介">1 简介</a></li>
    <li><a href="#2-快速入门-重点">2 快速入门 (重点)</a></li>
    <li><a href="#3openfeign的自定义配置">3.OpenFeign的自定义配置</a>
      <ul>
        <li><a href="#1超时控制">1.超时控制</a></li>
        <li><a href="#2日志配置">2.日志配置</a></li>
      </ul>
    </li>
    <li><a href="#4openfeign优化实战">4.OpenFeign优化实战</a>
      <ul>
        <li><a href="#超时优化">超时优化</a></li>
        <li><a href="#请求连接优化">请求连接优化</a></li>
        <li><a href="#数据压缩优化">数据压缩优化</a></li>
        <li><a href="#负载均衡优化">负载均衡优化</a></li>
        <li><a href="#日志级别优化">日志级别优化</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#1-gateway网关-概述">1 Gateway网关-概述</a></li>
    <li><a href="#2-gateway-快速入门">2 Gateway-快速入门</a></li>
    <li><a href="#3路由断言工厂predicatefactory">3.路由断言工厂PredicateFactory</a></li>
    <li><a href="#4过滤器工厂filter-factory">4.过滤器工厂Filter Factory</a>
      <ul>
        <li><a href="#41-过滤器-概述">4.1 过滤器-概述</a></li>
        <li><a href="#42-局部过滤器gatewayfilter">4.2-局部过滤器GatewayFilter</a></li>
        <li><a href="#43-全局过滤器globalfilter">4.3-全局过滤器GlobalFilter</a></li>
        <li><a href="#44-全局过滤器案例">4.4 全局过滤器案例</a></li>
      </ul>
    </li>
    <li><a href="#5过滤器-限流实战">5.过滤器-限流实战</a>
      <ul>
        <li><a href="#51-限流介绍">5.1 限流介绍</a></li>
        <li><a href="#52-gateway限流和自定义限流">5.2 Gateway限流和自定义限流</a></li>
      </ul>
    </li>
    <li><a href="#6gateway跨域配置">6.GateWay跨域配置</a>
      <ul>
        <li><a href="#61-跨域理解">6.1 跨域理解</a></li>
        <li><a href="#62-gateway的跨域配置">6.2 GateWay的跨域配置</a></li>
      </ul>
    </li>
    <li><a href="#7-gateway-静态路由">7. Gateway-静态路由</a></li>
    <li><a href="#8-gateway-动态路由">8. Gateway-动态路由</a></li>
  </ul>

  <ul>
    <li><a href="#11雪崩问题及解决方案">1.1.雪崩问题及解决方案</a>
      <ul>
        <li><a href="#111雪崩问题">1.1.1.雪崩问题</a></li>
        <li><a href="#112超时处理">1.1.2.超时处理</a></li>
        <li><a href="#113仓壁模式">1.1.3.仓壁模式</a></li>
        <li><a href="#114断路器">1.1.4.断路器</a></li>
        <li><a href="#115限流">1.1.5.限流</a></li>
        <li><a href="#116总结">1.1.6.总结</a></li>
      </ul>
    </li>
    <li><a href="#12服务保护技术对比">1.2.服务保护技术对比</a></li>
    <li><a href="#13sentinel介绍和安装">1.3.Sentinel介绍和安装</a>
      <ul>
        <li><a href="#131初识sentinel">1.3.1.初识Sentinel</a></li>
        <li><a href="#132安装sentinel">1.3.2.安装Sentinel</a></li>
      </ul>
    </li>
    <li><a href="#14微服务整合sentinel">1.4.微服务整合Sentinel</a></li>
  </ul>

  <ul>
    <li><a href="#21簇点链路">2.1.簇点链路</a></li>
    <li><a href="#21快速入门">2.1.快速入门</a>
      <ul>
        <li><a href="#211示例">2.1.1.示例</a></li>
        <li><a href="#212练习">2.1.2.练习：</a></li>
      </ul>
    </li>
    <li><a href="#22流控模式">2.2.流控模式</a>
      <ul>
        <li><a href="#221关联模式">2.2.1.关联模式</a></li>
        <li><a href="#222链路模式">2.2.2.链路模式</a></li>
        <li><a href="#223总结">2.2.3.总结</a></li>
      </ul>
    </li>
    <li><a href="#23流控效果">2.3.流控效果</a>
      <ul>
        <li><a href="#231warm-up">2.3.1.warm up</a></li>
        <li><a href="#232排队等待">2.3.2.排队等待</a></li>
        <li><a href="#233总结">2.3.3.总结</a></li>
      </ul>
    </li>
    <li><a href="#24热点参数限流">2.4.热点参数限流</a>
      <ul>
        <li><a href="#241全局参数限流">2.4.1.全局参数限流</a></li>
        <li><a href="#242热点参数限流">2.4.2.热点参数限流</a></li>
        <li><a href="#244案例">2.4.4.案例</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#31feignclient整合sentinel">3.1.FeignClient整合Sentinel</a>
      <ul>
        <li><a href="#311修改配置开启sentinel功能">3.1.1.修改配置，开启sentinel功能</a></li>
        <li><a href="#312编写失败降级逻辑">3.1.2.编写失败降级逻辑</a></li>
        <li><a href="#313总结">3.1.3.总结</a></li>
      </ul>
    </li>
    <li><a href="#32线程隔离舱壁模式">3.2.线程隔离（舱壁模式）</a>
      <ul>
        <li><a href="#321线程隔离的实现方式">3.2.1.线程隔离的实现方式</a></li>
        <li><a href="#322sentinel的线程隔离">3.2.2.sentinel的线程隔离</a></li>
        <li><a href="#323总结">3.2.3.总结</a></li>
      </ul>
    </li>
    <li><a href="#33熔断降级">3.3.熔断降级</a>
      <ul>
        <li><a href="#331慢调用">3.3.1.慢调用</a></li>
        <li><a href="#332异常比例异常数">3.3.2.异常比例、异常数</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#41授权规则">4.1.授权规则</a>
      <ul>
        <li><a href="#411基本规则">4.1.1.基本规则</a></li>
        <li><a href="#412如何获取origin">4.1.2.如何获取origin</a></li>
        <li><a href="#413给网关添加请求头">4.1.3.给网关添加请求头</a></li>
        <li><a href="#414配置授权规则">4.1.4.配置授权规则</a></li>
      </ul>
    </li>
    <li><a href="#42自定义异常结果">4.2.自定义异常结果</a>
      <ul>
        <li><a href="#421异常类型">4.2.1.异常类型</a></li>
        <li><a href="#422自定义异常处理">4.2.2.自定义异常处理</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#51规则管理模式">5.1.规则管理模式</a>
      <ul>
        <li><a href="#511pull模式">5.1.1.pull模式</a></li>
        <li><a href="#512push模式">5.1.2.push模式</a></li>
      </ul>
    </li>
    <li><a href="#52实现push模式">5.2.实现push模式</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/springcloudalibaba/"></a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    18 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p><strong>学习目标</strong></p>
<ul>
<li>掌握RestTemplate的使用</li>
<li>知道什么是SpringCloud</li>
<li>掌握搭建Eureka注册中心</li>
<li>了解Ribbon的负载均衡</li>
<li>理解Hystrix的熔断原理</li>
</ul>
<h1 id="系统架构演变">系统架构演变</h1>
<p>​	随着互联网的发展，网站应用的规模不断扩大。需求的激增，带来的是技术上的压力。系统架构也因此也不断的演进、升级、迭代。从单一应用，到垂直拆分，到分布式服务，到SOA，以及现在火热的微服务架构，还有Google带领下来势汹涌的Service Mesh。我们到底是该乘坐微服务的船只驶向远方，还是偏安一隅得过且过？
​	其实生活不止眼前的苟且，还有诗和远方。所以我们今天就回顾历史，看一看系统架构演变的历程；把握现在，学习现在最火的技术架构；展望未来，争取成为一名优秀的Java工程师。</p>
<h2 id="11-单体架构">1.1 单体架构</h2>
<p>​	当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。单体架构就是将所有的功能、数据库、文件都部署在一台机器上，俗称All-In-One</p>
<p><img src="/post/springcloudalibaba/assets/1682643185881.png"
	width="1195"
	height="396"
	srcset="/post/springcloudalibaba/assets/1682643185881_hu2eb3db1316b55fdad1df5365baeafdee_51667_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1682643185881_hu2eb3db1316b55fdad1df5365baeafdee_51667_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682643185881"
	
	
		class="gallery-image" 
		data-flex-grow="301"
		data-flex-basis="724px"
	
></p>
<h2 id="12-单体集群">1.2 单体集群</h2>
<p>单体集群,就是将单体架构复制几份</p>
<p><img src="/post/springcloudalibaba/assets/1682643241371.png"
	width="1124"
	height="546"
	srcset="/post/springcloudalibaba/assets/1682643241371_hubf3182e185ed25ec737090cd10132037_62156_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1682643241371_hubf3182e185ed25ec737090cd10132037_62156_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682643241371"
	
	
		class="gallery-image" 
		data-flex-grow="205"
		data-flex-basis="494px"
	
></p>
<h2 id="13-分布式服务">1.3 分布式服务</h2>
<p>分布式,是指将整个系统按照功能拆分,部署到不同的服务器上,这样即适合为某个功能做集群,又合适重复功能的复用</p>
<p><img src="/post/springcloudalibaba/assets/1682643296902.png"
	width="1180"
	height="547"
	srcset="/post/springcloudalibaba/assets/1682643296902_hu5051a077f35018bc8fdb95ae4991d548_66782_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1682643296902_hu5051a077f35018bc8fdb95ae4991d548_66782_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682643296902"
	
	
		class="gallery-image" 
		data-flex-grow="215"
		data-flex-basis="517px"
	
></p>
<h2 id="14-服务治理架构soa">1.4 服务治理架构（SOA）</h2>
<p>SOA,全称Service-Oriented Architecture,面向服务的架构.
它把项目拆成独立的服务,对外提供.服务的提供方和消费方由企业总线统一管理</p>
<p><img src="/post/springcloudalibaba/assets/1682643384098.png"
	width="1250"
	height="566"
	srcset="/post/springcloudalibaba/assets/1682643384098_hud1f512536169edb1cbcd8eb67f92cf9f_67450_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1682643384098_hud1f512536169edb1cbcd8eb67f92cf9f_67450_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682643384098"
	
	
		class="gallery-image" 
		data-flex-grow="220"
		data-flex-basis="530px"
	
></p>
<p>以前出现了什么问题？</p>
<ul>
<li>服务越来越多，需要管理每个服务的地址</li>
<li>调用关系错综复杂，难以理清依赖关系</li>
<li>服务过多，服务状态难以管理，无法根据服务情况动态管理</li>
</ul>
<p>服务治理要做什么？</p>
<ul>
<li>服务注册中心，实现服务自动注册和发现，无需人为记录服务地址</li>
<li>服务自动订阅，服务列表自动推送，服务调用透明化，无需关心依赖关系</li>
<li>动态监控服务状态监控报告，人为控制服务状态</li>
</ul>
<p>缺点：</p>
<ul>
<li>服务间会有依赖关系，一旦某个环节出错会影响较大</li>
<li>服务关系复杂，运维、测试部署困难</li>
</ul>
<h2 id="15-微服务">1.5 微服务</h2>
<p>微服务架构,是SOA的升华,在SOA的基础上更加细粒度的服务化,组件化.</p>
<p><img src="/post/springcloudalibaba/assets/1682643473026.png"
	width="1268"
	height="662"
	srcset="/post/springcloudalibaba/assets/1682643473026_hu585b62ac146a161158944f63eb80c47d_99184_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1682643473026_hu585b62ac146a161158944f63eb80c47d_99184_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682643473026"
	
	
		class="gallery-image" 
		data-flex-grow="191"
		data-flex-basis="459px"
	
></p>
<p>因此两者非常容易混淆，但其实有一些差别：
微服务的特点：</p>
<ul>
<li>单一职责：微服务中每一个服务都对应唯一的业务能力，做到单一职责</li>
<li>微：微服务的服务拆分粒度很小，例如一个用户管理就可以作为一个服务。每个服务虽小，但“五脏俱全”。</li>
<li>面向服务：面向服务是说每个服务都要对外暴露Rest风格服务HTTP接口API。并不关心服务的技术实现，做到与平台和语言无关，也不限定用什么技术实现，只要提供Rest的HTTP接口即可。</li>
<li>自治：自治是说服务间互相独立，互不干扰
<ul>
<li>团队独立：每个服务都是一个独立的开发团队，人数不能过多。</li>
<li>技术独立：因为是面向服务，提供Rest接口，使用什么技术没有别人干涉</li>
<li>前后端分离：采用前后端分离开发，提供统一Rest接口，后端不用再为PC、移动段开发不同接口</li>
<li>数据库分离：每个服务都使用自己的数据源</li>
<li>部署独立，服务间虽然有调用，但要做到服务重启不影响其它服务。有利于持续集成和持续交付。每个服务都是独立的组件，可复用，可替换，降低耦合，易维护</li>
</ul>
</li>
</ul>
<h1 id="服务调用方式">服务调用方式</h1>
<h2 id="21-rpc和http">2.1 RPC和HTTP</h2>
<p>无论是微服务还是SOA，都面临着服务间的<strong>远程调用</strong>。那么服务间的远程调用方式有哪些呢？
常见的远程调用方式有以下2种：</p>
<ul>
<li>RPC： Remote Produce Call远程过程调用，类似的还有RMI（remote method invoke）。自定义数据格式，基于原生TCP通信，速度快，效率高。早期的webservice，现在热门的dubbo，都是RPC的典型代表。</li>
<li>Http： http其实是一种网络传输协议，基于TCP，规定了数据传输的格式。 现在客户端浏览器与服务端通信基本都是采用Http协议，也可以用来进行远程服务调用。缺点是消息封装臃肿，优势是对服务的提供和调用方没有任何技术限定，自由灵活，更符合微服务理念。现在热门的Rest风格，就可以通过http协议来实现。</li>
</ul>
<p>如果你们公司全部采用Java技术栈，那么使用Dubbo作为微服务架构是一个不错的选择。
相反，如果公司的技术栈多样化，而且你更青睐Spring家族，那么SpringCloud搭建微服务是不二之选。在我们的项目中，我们会选择SpringCloud套件，因此我们会使用Http方式来实现服务间调用。</p>
<h2 id="22-http客户端工具">2.2 Http客户端工具</h2>
<p>既然微服务选择了Http，那么我们就需要考虑自己来实现对请求和响应的处理。不过开源世界已经有很
多的http客户端工具，能够帮助我们做这些事情，例如：</p>
<ul>
<li>HttpClient</li>
<li>OKHttp</li>
<li>URLConnection</li>
</ul>
<h1 id="resttemplate">RestTemplate</h1>
<p>RestTemplate是Spring Boot封装好的Http客户端工具。</p>
<p><img src="/post/springcloudalibaba/assets/image-20200523091717293.png"
	width="569"
	height="233"
	srcset="/post/springcloudalibaba/assets/image-20200523091717293_huea68d90599e6dcc20f51378958f73d06_19067_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200523091717293_huea68d90599e6dcc20f51378958f73d06_19067_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200523091717293"
	
	
		class="gallery-image" 
		data-flex-grow="244"
		data-flex-basis="586px"
	
></p>
<p>步骤：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span><span style="color:#66d9ef">1.</span> 添加服务提供者，提供Rest HTTP接口
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">2.</span> 添加服务调用者，通过RestTemplate访问服务提供者的接口
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">3.</span> 服务提供者和调用者都放到一个父工程中
</span></span></code></pre></div><h2 id="31-搭建父工程">3.1 搭建父工程</h2>
<p>为了方便项目管理，这里把服务提供者和服务调用者放到同一个工程中</p>
<p>新建父工程srping-cloud-parent-demo</p>
<p><img src="/post/springcloudalibaba/assets/image-20200731101824059.png"
	width="669"
	height="182"
	srcset="/post/springcloudalibaba/assets/image-20200731101824059_hu1ec7ecc27639323d6c81690a00a88566_9100_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200731101824059_hu1ec7ecc27639323d6c81690a00a88566_9100_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200731101824059"
	
	
		class="gallery-image" 
		data-flex-grow="367"
		data-flex-basis="882px"
	
></p>
<p>父工程不需要写代码，可以将src目录删除</p>
<p>添加Spring Boot依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>2.2.8.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;relativePath/&gt;</span> <span style="color:#75715e">&lt;!-- lookup parent from repository --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;java.version&gt;</span>1.8<span style="color:#f92672">&lt;/java.version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.projectlombok<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>lombok<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;optional&gt;</span>true<span style="color:#f92672">&lt;/optional&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;exclusions&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;exclusion&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;groupId&gt;</span>org.junit.vintage<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>junit-vintage-engine<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/exclusion&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/exclusions&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencies&gt;</span>	
</span></span></code></pre></div><h2 id="32-搭建服务提供者">3.2 搭建服务提供者</h2>
<p>项目结构如下：</p>
<p><img src="/post/springcloudalibaba/assets/image-20200903093502816.png"
	width="353"
	height="445"
	srcset="/post/springcloudalibaba/assets/image-20200903093502816_hua6e21b252f9696d3ba1ee6bc3797af46_20490_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200903093502816_hua6e21b252f9696d3ba1ee6bc3797af46_20490_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200903093502816"
	
	
		class="gallery-image" 
		data-flex-grow="79"
		data-flex-basis="190px"
	
></p>
<p>开发步骤：</p>
<ol>
<li>
<p>添加子模块user-service，添加web依赖</p>
<p><img src="/post/springcloudalibaba/assets/image-20200731102045743.png"
	width="1020"
	height="198"
	srcset="/post/springcloudalibaba/assets/image-20200731102045743_huc4baa792ee5d21a8ea567c1277c495de_28643_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200731102045743_huc4baa792ee5d21a8ea567c1277c495de_28643_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200731102045743"
	
	
		class="gallery-image" 
		data-flex-grow="515"
		data-flex-basis="1236px"
	
></p>
<p><img src="/post/springcloudalibaba/assets/image-20200903091209721.png"
	width="604"
	height="242"
	srcset="/post/springcloudalibaba/assets/image-20200903091209721_hu42bb2bf2ebcfa91a6724744987de882c_13416_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200903091209721_hu42bb2bf2ebcfa91a6724744987de882c_13416_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200903091209721"
	
	
		class="gallery-image" 
		data-flex-grow="249"
		data-flex-basis="599px"
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>添加配置文件application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8001</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 当前应用的服务名称（也叫服务ID）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service</span>
</span></span></code></pre></div></li>
<li>
<p>添加启动类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>UserApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>添加实体</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> lombok.AllArgsConstructor<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> lombok.Data<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> lombok.NoArgsConstructor<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Date<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@NoArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@AllArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Long id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Integer age<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Date updateTime<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>编写Controller</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 根据用户ID获取用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 接口地址: http://localhost:8001/user/1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getById</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> Long id<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        User user <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> User<span style="color:#f92672">(</span>id<span style="color:#f92672">,</span><span style="color:#e6db74">&#34;tom&#34;</span><span style="color:#f92672">,</span><span style="color:#ae81ff">18</span><span style="color:#f92672">,</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>启动项目,打开http://localhost:8001/user/1</p>
<p><img src="/post/springcloudalibaba/assets/image-20200910191933635.png"
	width="474"
	height="206"
	srcset="/post/springcloudalibaba/assets/image-20200910191933635_hued8b101900141dd23a08c7e5295dc181_6878_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910191933635_hued8b101900141dd23a08c7e5295dc181_6878_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910191933635"
	
	
		class="gallery-image" 
		data-flex-grow="230"
		data-flex-basis="552px"
	
></p>
</li>
</ol>
<h2 id="33-搭建服务消费者">3.3 搭建服务消费者</h2>
<ol>
<li>
<p>添加子模块service-consumer，添加web依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>添加配置文件application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9001</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 当前应用的服务名称（也叫服务ID）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-consumer</span>
</span></span></code></pre></div></li>
<li>
<p>添加启动类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumerApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ConsumerApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>   <span style="color:#75715e">// 将RestTemplate注册成为一个Bean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> RestTemplate <span style="color:#a6e22e">restTemplate</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RestTemplate<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>添加实体</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@NoArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@AllArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Long id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Integer age<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Date updateTime<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>编写Controller</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/consumer&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumerController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>  <span style="color:#75715e">// 注入RestTemplate模板工具
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> RestTemplate restTemplate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserById</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> Long id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 通过远程调用user-service提供的HTTP接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        String url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://110.111.11.12:8001/user/&#34;</span> <span style="color:#f92672">+</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 第一个参数是接口调用地址  第二个参数是返回的类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        User user <span style="color:#f92672">=</span> restTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">getForObject</span><span style="color:#f92672">(</span>url<span style="color:#f92672">,</span> User<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>访问http://localhost:9001/consumer/user/1</p>
<p><img src="/post/springcloudalibaba/assets/image-20200910192010174.png"
	width="531"
	height="200"
	srcset="/post/springcloudalibaba/assets/image-20200910192010174_huf681bb77770171b6cdcef940cf694afb_7636_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910192010174_huf681bb77770171b6cdcef940cf694afb_7636_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910192010174"
	
	
		class="gallery-image" 
		data-flex-grow="265"
		data-flex-basis="637px"
	
></p>
</li>
</ol>
<h2 id="34-微服务调用问题">3.4 微服务调用问题</h2>
<p>service-provider：对外提供接口服务</p>
<p>service-consumer: 通过<code>RestTemplate</code>访问 http://locahost:8081/  调用接口服务</p>
<p>存在问题：</p>
<ul>
<li>在consumer中，我们把url地址硬编码到了代码中，不方便后期维护</li>
<li>consumer需要记忆user-service的地址，如果出现变更，可能得不到通知，地址将失效</li>
<li>consumer不清楚user-service的状态，服务宕机也不知道</li>
<li>user-service只有1台服务，不具备高可用性</li>
<li>即便user-service形成集群， consumer还需自己实现负载均衡</li>
</ul>
<p>其实上面说的问题，概括一下就是分布式服务必然要面临的问题：</p>
<ul>
<li>服务管理
<ul>
<li>如何自动注册和发现服务</li>
<li>如何实现服务状态监管</li>
<li>如何实现服务动态路由</li>
</ul>
</li>
<li>服务如何实现负载均衡</li>
<li>服务如何解决容灾问题</li>
<li>服务如何实现统一配置</li>
</ul>
<p>以上的问题，我们都将在Spring Cloud中得到解决。</p>
<h1 id="spring-cloud">Spring Cloud</h1>
<h2 id="41-简介">4.1 简介</h2>
<p>Spring Cloud是一个基于 Spring Boot实现的微服务架构开发工具。它为微服务架构中涉及的配置管理、服务治理、断路器、智能路由、微代理、控制总线、全局锁、决策竞选、分布式会话和集群状态管理等操作提供了一种简单的开发方式。
Spring Cloud包含了多个子项目（针对分布式系统中涉及的多个不同开源产品，还可能会新增），如下所述。</p>
<ul>
<li>Spring Cloud Config:配置管理工具，支持使用Git存储配置内容，可以使用它实现应用配置的外部化存储，并支持客户端配置信息刷新、加密/解密配置内容等。</li>
<li>Spring Cloud Netflix:核心组件，对多个 Netflix OSS开源套件进行整合
<ul>
<li>Eureka:服务治理组件，包含服务注册中心、服务注册与发现机制的实现。</li>
<li>Ribbon:客户端负载均衡的服务调用组件。</li>
<li>Hystrix(豪猪哥):容错管理组件，实现断路器模式，帮助服务依赖中出现的延迟和为故障提供强大的容错能力。</li>
<li>Open Feign:基于 Ribbon和 Hystrix的声明式服务调用组件。</li>
<li>Gateway: 网关组件，提供智能路由、访问过滤等功能。</li>
</ul>
</li>
<li>Spring Cloud Bus: 事件、消息总线，用于传播集群中的状态变化或事件，以触发后续的处理，比如用来动态刷新配置等。</li>
</ul>
<p>官网：https://spring.io/projects/spring-cloud</p>
<h2 id="42-版本说明">4.2 版本说明</h2>
<p>Spring Cloud不像 Spring社区其他一些项目那样相对独立，它是一个拥有诸多子项目的大型综合项目，可以说是对微服务架构解决方案的综合套件组合，其包含的各个子项目也都独立进行着内容更新与迭代，各自都维护着自己的发布版本号。因此每一个Spring Cloud的版本都会包含多个不同版本的子项目b  j\  ，为了管理每个版本的子项目清单，避免 Spring Cloud的版本号与其子项目的版本号相混淆，没有采用版本号的方式，而是通过命名的方式。</p>
<p>这些版本的名字采用了伦敦地铁站的名字，根据字母表的顺序来对应版本时间顺序，比如最早的 Release版本为 Angel，第二个 Release版本为 Brixton</p>
<p>当一个版本的 Spring Cloud项目的发布内容积累到临界点或者一个严重bug解决可用后，就会发布一个“service releases”版本，简称SRX版本，其中X是一个递增的数字，所以 Brixton.SR5就是 Brixton的第5个 Release版本</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:left">Spring Cloud Version</th>
<th style="text-align:left">Spring Boot Version</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a class="link" href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2022.0-Release-Notes"  target="_blank" rel="noopener"
    >2022.0.x</a> aka Kilburn</td>
<td style="text-align:left">3.0.x</td>
</tr>
<tr>
<td style="text-align:left"><a class="link" href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2021.0-Release-Notes"  target="_blank" rel="noopener"
    >2021.0.x</a> aka Jubilee</td>
<td style="text-align:left">2.6.x, 2.7.x (Starting with 2021.0.3)</td>
</tr>
<tr>
<td style="text-align:left"><a class="link" href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2020.0-Release-Notes"  target="_blank" rel="noopener"
    >2020.0.x</a> aka Ilford</td>
<td style="text-align:left">2.4.x, 2.5.x (Starting with 2020.0.3)</td>
</tr>
<tr>
<td style="text-align:left">Hoxton</td>
<td style="text-align:left">2.2.x</td>
</tr>
<tr>
<td style="text-align:left">Greenwich</td>
<td style="text-align:left">2.1.x</td>
</tr>
<tr>
<td style="text-align:left">Finchley</td>
<td style="text-align:left">2.0.x</td>
</tr>
<tr>
<td style="text-align:left">Edgware</td>
<td style="text-align:left">1.5.x</td>
</tr>
<tr>
<td style="text-align:left">Dalston</td>
<td style="text-align:left">1.5.x</td>
</tr>
</tbody>
</table></div>
<h1 id="服务治理">服务治理</h1>
<h2 id="51-认识eureka">5.1 认识Eureka</h2>
<p>首先我们来解决第一问题，<code>服务的管理</code>。</p>
<blockquote>
<p>问题分析</p>
</blockquote>
<p>在刚才的案例中， user-service对外提供服务，需要对外暴露自己的地址。而consumer（调用者）需要
记录服务提供者的地址。将来地址出现变更，还需要及时更新。这在服务较少的时候并不觉得有什么，
但是在现在日益复杂的互联网环境，一个项目肯定会拆分出十几，甚至数十个微服务。此时如果还人为
管理地址，不仅开发困难，将来测试、发布上线都会非常麻烦。</p>
<blockquote>
<p>解决方案-网约车</p>
</blockquote>
<p>这就好比是 网约车出现以前，人们出门叫车只能叫出租车。一些私家车想做出租却没有资格，被称为黑车。而很多人想要约车，但是无奈出租车太少，不方便。私家车很多却不敢拦，而且满大街的车，谁知
道哪个才是愿意载人的。一个想要，一个愿意给，就是缺少引子，缺乏管理啊。
此时滴滴这样的网约车平台出现了，所有想载客的私家车全部到滴滴注册，记录你的车型（服务类
型），身份信息（联系方式）。这样提供服务的私家车，在滴滴那里都能找到，一目了然。
此时要叫车的人，只需要打开APP，输入你的目的地，选择车型（服务类型），滴滴自动安排一个符合
需求的车到你面前，为你服务，完美！</p>
<blockquote>
<p>Eureka能做什么？</p>
</blockquote>
<p>Eureka就好比是滴滴，负责管理、记录服务提供者的信息。服务调用者无需自己寻找服务，而是把自己
的需求告诉Eureka，然后Eureka会把符合你需求的服务告诉你。
同时，服务提供方与Eureka之间通过 “心跳” 机制进行监控，当某个服务提供方出现问题， Eureka自然
会把它从服务列表中剔除。这就实现了服务的自动注册、发现、状态监控。</p>
<h2 id="52-基本架构">5.2 基本架构</h2>
<blockquote>
<p>架构图：</p>
</blockquote>
<p><img src="/post/springcloudalibaba/assets/image-20200523223318698.png"
	width="1161"
	height="712"
	srcset="/post/springcloudalibaba/assets/image-20200523223318698_huc33175174bb53eec8eba374800296b31_209095_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200523223318698_huc33175174bb53eec8eba374800296b31_209095_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200523223318698"
	
	
		class="gallery-image" 
		data-flex-grow="163"
		data-flex-basis="391px"
	
></p>
<blockquote>
<p>基本概念</p>
</blockquote>
<ul>
<li>Eureka-Server：就是服务注册中心（可以是一个集群），对外暴露自己的地址。</li>
<li>提供者：启动后向Eureka注册自己信息（地址，服务名称等），并且定期进行服务续约</li>
<li>消费者：服务调用方，会定期去Eureka拉取服务列表，然后使用负载均衡算法选出一个服务进行调用。</li>
<li>心跳(续约)：提供者定期通过http方式向Eureka刷新自己的状态</li>
</ul>
<h2 id="53-快速入门">5.3 快速入门</h2>
<p>步骤：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span><span style="color:#66d9ef">0.</span> 在父工程中添加SpringCloud的版本依赖管理
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">1.</span> 搭建注册中心
</span></span><span style="display:flex;"><span>	a. 新建工程，添加Eureka server依赖
</span></span><span style="display:flex;"><span>	b. 配置注册中心服务地址
</span></span><span style="display:flex;"><span>	c. 添加启动类
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">2.</span> 服务提供者到注册中心注册
</span></span><span style="display:flex;"><span>	a. 添加Eureka client 依赖
</span></span><span style="display:flex;"><span>	b. 配置文件中添加注册中心地址
</span></span><span style="display:flex;"><span>	c. 在启动类上添加服务发现注解
</span></span><span style="display:flex;"><span>	d. 编写自己需要提供的接口
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">3.</span> 服务调用者到注册中心拉取注册信息
</span></span><span style="display:flex;"><span>	a. 添加Eureka client 依赖
</span></span><span style="display:flex;"><span>	b. 配置文件中添加注册中心地址
</span></span><span style="display:flex;"><span>	c. 在启动类上添加服务发现注解
</span></span><span style="display:flex;"><span>	d. 采用服务的方式调用服务提供者的接口
</span></span></code></pre></div><h3 id="531-搭建服务注册中心">5.3.1 搭建服务注册中心</h3>
<ol>
<li>在父工程pom.xml中添加Spring Cloud的依赖管理</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;spring-cloud.version&gt;</span>Hoxton.SR6<span style="color:#f92672">&lt;/spring-cloud.version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-dependencies<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;version&gt;</span>${spring-cloud.version}<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;type&gt;</span>pom<span style="color:#f92672">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;scope&gt;</span>import<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencyManagement&gt;</span>
</span></span></code></pre></div><p>2.在spring-cloud-parent-demo父项目中创建一个Spring Boot工程，命名为eureka-server，并在pom.xml中添加eureka依赖</p>
<p><img src="/post/springcloudalibaba/assets/1682857622828.png"
	width="694"
	height="185"
	srcset="/post/springcloudalibaba/assets/1682857622828_hua6414afc621f6ab34a43912c72c7dd78_12024_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1682857622828_hua6414afc621f6ab34a43912c72c7dd78_12024_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682857622828"
	
	
		class="gallery-image" 
		data-flex-grow="375"
		data-flex-basis="900px"
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>3.添加配置文件application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">1111</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-server</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://127.0.0.1:${server.port}/eureka</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注册中心的职责是维护服务实例，不需要去检索服务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fetch-registry</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 默认设置下，注册中心会将自己作为客户端来尝试注册自己，设置为false代表不向注册中心注册自己</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">register-with-eureka</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p>4.添加启动类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 启动注册中心
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">@EnableEurekaServer</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EurekaApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>EurekaApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>启动应用并访问：http://localhost:1111 可以看到Eureka界面</p>
<p><img src="/post/springcloudalibaba/assets/image-20200523225115951.png"
	width="1884"
	height="875"
	srcset="/post/springcloudalibaba/assets/image-20200523225115951_hubdb6434a43bdf72dd4c28edb32bdea0f_60734_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200523225115951_hubdb6434a43bdf72dd4c28edb32bdea0f_60734_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200523225115951"
	
	
		class="gallery-image" 
		data-flex-grow="215"
		data-flex-basis="516px"
	
></p>
<h3 id="532-服务注册">5.3.2 服务注册</h3>
<p>注册服务，就是在服务上添加Eureka的客户端依赖，客户端代码会自动把服务注册到EurekaServer中。</p>
<p>1.在user-service中添加Eureka客户端依赖：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- Eureka客户端 --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2.在启动类上 通过添加 <code>@EnableDiscoveryClient</code>来开启Eureka客户端功能</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 开启Eureka客户端发现功能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ProviderApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>3.配置文件中添加注册中心地址</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://127.0.0.1:1111/eureka</span>
</span></span></code></pre></div><p>这里spring.application.name属性指定应用名称，将来会作为服务的id使用。</p>
<p>此时再打开注册中心的地址：http://localhost:1111,可以看到服务已经注册上去了</p>
<p><img src="/post/springcloudalibaba/assets/image-20200623114627269.png"
	width="1508"
	height="191"
	srcset="/post/springcloudalibaba/assets/image-20200623114627269_hua5ec7755bcdfdec8448c6fdc41e7441a_29142_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200623114627269_hua5ec7755bcdfdec8448c6fdc41e7441a_29142_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200623114627269"
	
	
		class="gallery-image" 
		data-flex-grow="789"
		data-flex-basis="1894px"
	
></p>
<h3 id="533-服务发现与消费">5.3.3 服务发现与消费</h3>
<p>接下来我们修改service-consumer，尝试从EurekaServer获取服务。
方法与消费者类似，只需要在项目中添加EurekaClient依赖，就可以通过服务名称来获取信息了</p>
<p>1.在service-consumer中添加Eureka客户端依赖：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- Eureka客户端 --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2.在启动类上 通过添加 <code>@EnableDiscoveryClient</code>来开启Eureka客户端功能</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumerApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ConsumerApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> RestTemplate <span style="color:#a6e22e">restTemplate</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RestTemplate<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>3.配置文件中添加注册中心地址</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://127.0.0.1:1111/eureka</span>
</span></span></code></pre></div><p>4.修改代码，用DiscoveryClient类的方法，根据服务名称，获取服务实例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    动态获取服务地址:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    注意!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    注意!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    注意!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    DiscoveryClient的导包:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    import org.springframework.cloud.client.discovery.DiscoveryClient;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    注意!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    注意!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    注意!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    1. 注入DiscoveryClient
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    2. 使用DiscoveryClient 获取服务列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    3. 从服务列表中选择一个服务实例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    4. 实例中包含了调用地址及端口信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> DiscoveryClient discoveryClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserById</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> Long id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用DiscoveryClient 获取服务列表 参数为服务ID ,也就是在配置文件中定义的spring.application.name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// spring.application.name 建议使用 -  来分隔,不要使用下划线
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    List<span style="color:#f92672">&lt;</span>ServiceInstance<span style="color:#f92672">&gt;</span> instances <span style="color:#f92672">=</span> discoveryClient<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstances</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user-service&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取具体的实例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ServiceInstance instance <span style="color:#f92672">=</span> instances<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取服务的地址和端口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    String host <span style="color:#f92672">=</span> instance<span style="color:#f92672">.</span><span style="color:#a6e22e">getHost</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> port <span style="color:#f92672">=</span> instance<span style="color:#f92672">.</span><span style="color:#a6e22e">getPort</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 通过远程调用user-service提供的HTTP接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    String url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://&#34;</span> <span style="color:#f92672">+</span> host <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> port <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/user/&#34;</span> <span style="color:#f92672">+</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 第一个参数是接口调用地址  第二个参数是返回的类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    User user <span style="color:#f92672">=</span> restTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">getForObject</span><span style="color:#f92672">(</span>url<span style="color:#f92672">,</span> User<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>5.启动项目后，可以在注册中心页面看到有两个服务</p>
<p><img src="/post/springcloudalibaba/assets/image-20200910193602866.png"
	width="1441"
	height="366"
	srcset="/post/springcloudalibaba/assets/image-20200910193602866_hu9b6be45b73bb265f37cee8988c75f629_25690_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910193602866_hu9b6be45b73bb265f37cee8988c75f629_25690_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910193602866"
	
	
		class="gallery-image" 
		data-flex-grow="393"
		data-flex-basis="944px"
	
></p>
<p>6.调用消费者的页面http://localhost:9001/consumer/user/1</p>
<p><img src="/post/springcloudalibaba/assets/image-20200910193620800.png"
	width="512"
	height="212"
	srcset="/post/springcloudalibaba/assets/image-20200910193620800_hu3a4625be837d628e1344c58af3f01606_7740_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910193620800_hu3a4625be837d628e1344c58af3f01606_7740_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910193620800"
	
	
		class="gallery-image" 
		data-flex-grow="241"
		data-flex-basis="579px"
	
></p>
<h2 id="54-eureka详解">5.4 Eureka详解</h2>
<p>接下来我们详细讲解Eureka的原理及配置。</p>
<h3 id="541-基础架构">5.4.1 基础架构</h3>
<p>Eureka架构中的三个核心角色：</p>
<ul>
<li>服务注册中心
Eureka的服务端应用，提供服务<strong>注册</strong>和<strong>发现</strong>功能，就是刚刚我们建立的eureka-server</li>
<li>服务提供者
提供服务的应用，可以是Spring Boot应用，也可以是其它任意技术实现，只要对外提供的是Rest
风格服务即可。本例中就是我们实现的order-service-provider</li>
<li>服务消费者
消费应用从注册中心获取服务列表，从而得知每个服务方的信息，知道去哪里调用服务方。本例中
就是我们实现的pay-service-consumer</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/image-20200708140407596.png"
	width="692"
	height="432"
	srcset="/post/springcloudalibaba/assets/image-20200708140407596_hu2c787cd226f079c195bd21ee548ebbdb_61686_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200708140407596_hu2c787cd226f079c195bd21ee548ebbdb_61686_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200708140407596"
	
	
		class="gallery-image" 
		data-flex-grow="160"
		data-flex-basis="384px"
	
></p>
<p><strong>服务提供者</strong></p>
<p>服务提供者要向Eureka Server注册服务，并且完成服务续约等工作。</p>
<blockquote>
<p>服务注册</p>
</blockquote>
<p>服务提供者在启动时，会检测配置属性中的：</p>
<p><code>eureka.client.register-with-erueka=true</code></p>
<p>参数表示是否注册到eureka注册中心
事实上默认就是true。如果值确实为true，则会向Eureka Server发起一个Rest请求，并携带自己的元数据信息， Eureka Server会把这些信息保存到一个双层Map结构中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span>Object<span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span>Map<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;user-sercice&#34;</span><span style="color:#f92672">,</span>Map<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">主机名</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">服务名</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">端口等</span><span style="color:#f92672">,</span><span style="color:#960050;background-color:#1e0010">服务实例对象</span><span style="color:#f92672">&gt;&gt;</span>
</span></span></code></pre></div><ul>
<li>第一层Map的Key就是服务id，一般是配置中的 <code>spring.application.name</code>属性</li>
<li>第二层Map的key是服务的实例，一般host+ serviceId + port，例如： localhost:user-service:8001</li>
<li>值则是服务的实例对象，也就是说一个服务，可以同时启动多个不同实例，形成集群。</li>
</ul>
<p><strong>服务消费者</strong></p>
<blockquote>
<p>获取服务</p>
</blockquote>
<p>启动服务消费者的时候，它会发送一个REST请求给服务注册中心，来获取上面注册的服务清单。</p>
<h3 id="543-eureka属性配置了解">5.4.3 Eureka属性配置(了解)</h3>
<p><strong>服务端配置</strong></p>
<blockquote>
<p>失效剔除</p>
</blockquote>
<p>有些时候，我们的服务实例并不一定会正常下线,正常下线会给注册中心发送一个HTTP请求，告诉注册中心服务下线，可能由于内存溢出、网络故障等原因使得服务不能正常工作，而服务注册中心并未收到“服务下线”的请求。为了从服务列表中将这些无法提供服务的实例剔除， Eureka Server在启动的时候会创建一个定时任务，默认每隔一段时间（默认为60秒）将当前清单中超时（<strong>默认为90秒</strong>）没有续约的服务剔除出去。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 剔除任务执行时间，默认为60秒</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">eviction-interval-timer-in-ms</span>: <span style="color:#ae81ff">60000</span>
</span></span></code></pre></div><p>服务端的默认配置可以在<code>EurekaServerConfigBean</code>中查看</p>
<p>服务提供者正常关闭会立刻在注册中心下线</p>
<p><img src="/post/springcloudalibaba/assets/image-20200910194505294.png"
	width="383"
	height="312"
	srcset="/post/springcloudalibaba/assets/image-20200910194505294_hu9b6f476f62798ac41d2f526a47ff83f3_20592_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910194505294_hu9b6f476f62798ac41d2f526a47ff83f3_20592_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910194505294"
	
	
		class="gallery-image" 
		data-flex-grow="122"
		data-flex-basis="294px"
	
></p>
<p>接下来模拟服务提供者非正常关闭：</p>
<p><img src="/post/springcloudalibaba/assets/image-20200910194523927.png"
	width="378"
	height="315"
	srcset="/post/springcloudalibaba/assets/image-20200910194523927_hu540b3168c44c5137688df0d03b63e7a2_20426_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910194523927_hu540b3168c44c5137688df0d03b63e7a2_20426_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910194523927"
	
	
		class="gallery-image" 
		data-flex-grow="120"
		data-flex-basis="288px"
	
></p>
<p>此时发现user-service还在注册中心。</p>
<blockquote>
<p>自我保护</p>
</blockquote>
<p>当我们在本地调试基于 Eureka的程序时，基本上都会碰到这样一个问题，在服务注册中心的信息面板中出现类似下面的红色警告信息:</p>
<p><img src="/post/springcloudalibaba/assets/image-20200524151524851.png"
	width="1223"
	height="517"
	srcset="/post/springcloudalibaba/assets/image-20200524151524851_hu7037219f59ca8a4e73910606a2f3691e_48072_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524151524851_hu7037219f59ca8a4e73910606a2f3691e_48072_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524151524851"
	
	
		class="gallery-image" 
		data-flex-grow="236"
		data-flex-basis="567px"
	
></p>
<p>该警告就是触发了Eureka Server的自我保护机制。之前我们介绍过，服务注册到 Eureka Server之后，会维护一个心跳连接，告诉 Eureka Server自己还活着.Eureka Server在运行期间，会统计心跳失败的比例在15分钟之内是否低于85％，如果出现低于的情况（在单机调试的时候很容易满足，实际在生产环境上通常是由于网络不稳定导致）， Eureka Server会将当前的实例注册信息保护起来让这些实例不会过期，尽可能保护这些注册信息。但是，在这段保护期间内实例若出现问题，那么客户端很容易拿到实际已经不存在的服务实例，会出现调用失败的情况，所以客户端必须要有容错机制，比如可以使用请求重试、断路器等机制。
由于本地调试很容易触发注册中心的保护机制，这会使得注册中心维护的服务实例不那么准确。所以，我们在本地进行开发的时候，可以使用 <code>eureka.server.enable-self-preservation＝false</code>参数来关闭保护机制，以确保注册中心可以将不可用的实例正确剔除。</p>
<p>关闭自我保护机制：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注册中心提供服务的地址</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://127.0.0.1:${server.port}/eureka</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注册中心的职责是维护服务实例，不需要去检索服务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fetch-registry</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 默认设置下，注册中心会将自己作为客户端来尝试注册自己，设置为false代表不向注册中心注册自己</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">register-with-eureka</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 关闭自我保护机制</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enable-self-preservation</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p>启动后会显示自我保护机制关闭</p>
<p><img src="/post/springcloudalibaba/assets/image-20200708143545361.png"
	width="1545"
	height="625"
	srcset="/post/springcloudalibaba/assets/image-20200708143545361_hu3b2f4d069a182bd2a45cf93462703c86_69730_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200708143545361_hu3b2f4d069a182bd2a45cf93462703c86_69730_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200708143545361"
	
	
		class="gallery-image" 
		data-flex-grow="247"
		data-flex-basis="593px"
	
></p>
<p><strong>客户端属性配置</strong></p>
<blockquote>
<p>服务续约</p>
</blockquote>
<p>在注册完服务之后，服务提供者会维护一个心跳用来持续告诉 Eureka Server:“我还活着”，以防止 Eureka Server的剔除任务将该服务实例从服务列表中排除出去，我们称该操作为服务续约（Renew）
关于服务续约有两个重要属性，我们可以关注并根据需要来进行调整:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务失效的时间，默认为90秒,告知服务器器 如果90秒内都没有心跳包,可以把我踢出</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lease-expiration-duration-in-seconds</span>: <span style="color:#ae81ff">90</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务续约任务的调用间隔时间，默认为30秒,心跳包</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lease-renewal-interval-in-seconds</span>: <span style="color:#ae81ff">30</span>
</span></span></code></pre></div><p>这个设置与注册中心服务端的失效剔除配合使用</p>
<p>比如Eureka-server中设置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">#  每5秒钟剔除失效的服务</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">eviction-interval-timer-in-ms</span>: <span style="color:#ae81ff">5000</span>
</span></span></code></pre></div><p>在user-service中设置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 当前实例的配置</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务失效的时间，默认为90秒</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lease-expiration-duration-in-seconds</span>: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 服务续约任务的调用间隔时间，默认为30秒</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lease-renewal-interval-in-seconds</span>: <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><p>意思是服务提供端每10秒发送一次服务续约，服务的失效时间为15秒，即如果服务提供端下线，15秒后eureka server将其服务剔除。</p>
<blockquote>
<p>服务拉取</p>
</blockquote>
<p>启动服务消费者的时候，它会发送一个REST请求给服务注册中心，来获取上面注册的服务清单。为了性能考虑， Eureka Server会维护一份只读的服务清单来返回给客户端，同时该缓存清单会每隔30秒更新一次。
获取服务是服务消费者的基础，所以必须确保 <code>eureka.client.fetch-registry＝true</code>参数没有被修改成 false，该值默认为true。</p>
<p>若希望修改缓存清单的更新时间，可以通过 <code>eureka.client.registry-fetch-interval＝30</code>参数进行修改，该参数默认值为30，单位为秒。</p>
<p><strong>Eureka实例配置</strong></p>
<p>user-service默认注册时使用的是主机名或者域名，如果我们想用ip进行注册，可以在user-service的
application.yml添加配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 更倾向于使用ip，而不是host名</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>如果么有使用ip，可以看到提示如下：</p>
<p><img src="/post/springcloudalibaba/assets/image-20200708144930721.png"
	width="1345"
	height="477"
	srcset="/post/springcloudalibaba/assets/image-20200708144930721_hud2a56494ae0eae62a3a70a5fdfd729ea_50288_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200708144930721_hud2a56494ae0eae62a3a70a5fdfd729ea_50288_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200708144930721"
	
	
		class="gallery-image" 
		data-flex-grow="281"
		data-flex-basis="676px"
	
></p>
<p>改成ip后：</p>
<p><img src="/post/springcloudalibaba/assets/image-20200708145052817.png"
	width="1356"
	height="470"
	srcset="/post/springcloudalibaba/assets/image-20200708145052817_huf130d945d4f82ccbddd05259c64847c3_48211_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200708145052817_huf130d945d4f82ccbddd05259c64847c3_48211_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200708145052817"
	
	
		class="gallery-image" 
		data-flex-grow="288"
		data-flex-basis="692px"
	
></p>
<h2 id="55-搭建高可用的eureka-server集群">5.5 搭建高可用的Eureka Server集群</h2>
<p>Eureka Server即服务的注册中心，在刚才的案例中，我们只有一个Eureka Server，事实上
Eureka Server也可以是一个集群，形成高可用的Eureka中心。</p>
<h3 id="551-服务同步">5.5.1 服务同步</h3>
<p>多个Eureka Server之间也会互相注册为服务，当服务提供者注册到Eureka Server集群中的某个节点
时，该节点会把服务的信息同步给集群中的每个节点，从而实现高可用集群。因此，无论客户端访问到
Eureka Server集群中的任意一个节点，都可以获取到完整的服务列表信息。
而作为客户端，需要把信息注册到每个Eureka中：</p>
<p><img src="/post/springcloudalibaba/assets/image-20200731141015665.png"
	width="962"
	height="461"
	srcset="/post/springcloudalibaba/assets/image-20200731141015665_hu57f02aed64f163ddf42107e42c340000_42748_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200731141015665_hu57f02aed64f163ddf42107e42c340000_42748_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200731141015665"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="500px"
	
></p>
<p>如果有三个Eureka，则每一个Eureka Server都需要注册到其它几个Eureka服务中，例如：有三个分别
为1111、 1112、 1113，则：</p>
<ul>
<li>1111要注册到1112和1113上</li>
<li>1112要注册到1111和1113上</li>
<li>1113要注册到1111和1112上</li>
</ul>
<h3 id="552-搭建高可用的eureka-server">5.5.2 搭建高可用的Eureka Server</h3>
<p>​	所谓的高可用注册中心，其实就是把Eureka Server自己也作为一个服务，注册到其它Eureka Server上，这样多个Eureka Server之间就能互相发现对方，从而形成集群。因此我们做了以下修改：
把service-url的值改成了另外一台Eureka Server的地址，而不是自己</p>
<p>我们假设要搭建两台Eureka Server的集群，端口分别为： 1112和1113</p>
<p>1.添加配置文件application-p1.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">1111</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-server</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注册中心提供服务的地址</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://127.0.0.1:1112/eureka,http://127.0.0.1:1113/eureka</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 从其他的注册中心检索服务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fetch-registry</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 向其他注册中心注册自己</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">register-with-eureka</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>2.添加配置文件application-p2.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">1112</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-server</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注册中心提供服务的地址</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://127.0.0.1:1111/eureka,http://127.0.0.1:1113/eureka</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 从其他的注册中心检索服务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fetch-registry</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 向其他注册中心注册自己</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">register-with-eureka</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>3.添加配置文件application-p3.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">1113</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-server</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注册中心提供服务的地址</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://127.0.0.1:1111/eureka,http://127.0.0.1:1112/eureka</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 从其他的注册中心检索服务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fetch-registry</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 向其他注册中心注册自己</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">register-with-eureka</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><h3 id="554启动三台eureka-server">5.5.4.启动三台Eureka Server</h3>
<blockquote>
<p>在IDEA中启动</p>
</blockquote>
<p>编辑配置</p>
<p><img src="/post/springcloudalibaba/assets/image-20200910194702785.png"
	width="327"
	height="189"
	srcset="/post/springcloudalibaba/assets/image-20200910194702785_hu746c754968d74141e8aca9c79acdbf36_13494_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910194702785_hu746c754968d74141e8aca9c79acdbf36_13494_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910194702785"
	
	
		class="gallery-image" 
		data-flex-grow="173"
		data-flex-basis="415px"
	
></p>
<p>复制配置</p>
<p><img src="/post/springcloudalibaba/assets/image-20200910194824067.png"
	width="1349"
	height="1010"
	srcset="/post/springcloudalibaba/assets/image-20200910194824067_hu330eb1a0a39b36699e8624cfc94feca2_71817_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910194824067_hu330eb1a0a39b36699e8624cfc94feca2_71817_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910194824067"
	
	
		class="gallery-image" 
		data-flex-grow="133"
		data-flex-basis="320px"
	
></p>
<p>修改名称及Active profiles,配置完成后会弹出RunDashboard</p>
<p><img src="/post/springcloudalibaba/assets/image-20200731141530634.png"
	width="427"
	height="253"
	srcset="/post/springcloudalibaba/assets/image-20200731141530634_hu5e7029dd6399705239c805b254e85572_13402_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200731141530634_hu5e7029dd6399705239c805b254e85572_13402_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200731141530634"
	
	
		class="gallery-image" 
		data-flex-grow="168"
		data-flex-basis="405px"
	
></p>
<p>p2，p3节点也按此配置，然后启动即可。</p>
<p><img src="/post/springcloudalibaba/assets/image-20200708141150474.png"
	width="1669"
	height="576"
	srcset="/post/springcloudalibaba/assets/image-20200708141150474_hu270fb345897156a18a7736ae1acb03bb_70051_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200708141150474_hu270fb345897156a18a7736ae1acb03bb_70051_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200708141150474"
	
	
		class="gallery-image" 
		data-flex-grow="289"
		data-flex-basis="695px"
	
></p>
<p>在启动的过程中，可能会出现下面的错误信息</p>
<p><img src="/post/springcloudalibaba/assets/image-20200708141245153.png"
	width="1073"
	height="298"
	srcset="/post/springcloudalibaba/assets/image-20200708141245153_huabc15ac83500510c44c84349effb9c16_55665_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200708141245153_huabc15ac83500510c44c84349effb9c16_55665_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200708141245153"
	
	
		class="gallery-image" 
		data-flex-grow="360"
		data-flex-basis="864px"
	
></p>
<p>原因是其他的节点还没有启动，此时去注册就会出现连接超时，这个流程是正常的。</p>
<p>命令行启动将项目打包，需要添加打包插件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>   <span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;/build&gt;</span>
</span></span></code></pre></div><p>在IDEA右侧选择Maven Projects,双击package</p>
<p><img src="/post/springcloudalibaba/assets/image-20200524100514457.png"
	width="371"
	height="421"
	srcset="/post/springcloudalibaba/assets/image-20200524100514457_hu77ba9b61222ec483a9f72a93df03f69c_28425_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524100514457_hu77ba9b61222ec483a9f72a93df03f69c_28425_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524100514457"
	
	
		class="gallery-image" 
		data-flex-grow="88"
		data-flex-basis="211px"
	
></p>
<p>打包后的文件会生成在target目录</p>
<p><img src="/post/springcloudalibaba/assets/image-20200524100805815.png"
	width="354"
	height="482"
	srcset="/post/springcloudalibaba/assets/image-20200524100805815_hu34e6f948ca5f7c8bce9f91868ee8f996_25365_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524100805815_hu34e6f948ca5f7c8bce9f91868ee8f996_25365_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524100805815"
	
	
		class="gallery-image" 
		data-flex-grow="73"
		data-flex-basis="176px"
	
></p>
<p>找到目录执行<code>cmd</code>打开命令行窗口</p>
<p><img src="/post/springcloudalibaba/assets/image-20200524101049987.png"
	width="658"
	height="328"
	srcset="/post/springcloudalibaba/assets/image-20200524101049987_hu1ee5fbcc4d13fa9987d7f425bb12bc85_28291_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524101049987_hu1ee5fbcc4d13fa9987d7f425bb12bc85_28291_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524101049987"
	
	
		class="gallery-image" 
		data-flex-grow="200"
		data-flex-basis="481px"
	
></p>
<p>执行以下命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>java -jar eureka-server-0.0.1-SNAPSHOT.jar --spring.profiles.active<span style="color:#f92672">=</span>p1
</span></span></code></pre></div><p>再打开另外一个命令行窗口，执行命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>java -jar eureka-server-0.0.1-SNAPSHOT.jar --spring.profiles.active<span style="color:#f92672">=</span>p2
</span></span><span style="display:flex;"><span>java -jar eureka-server-0.0.1-SNAPSHOT.jar --spring.profiles.active<span style="color:#f92672">=</span>p3
</span></span></code></pre></div><ol>
<li>
<p>客户端注册服务到集群</p>
<p>修改user-service,因为Eureka Server不止一个，因此注册服务的时候， service-url参数需要变化：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://127.0.0.1:1111/eureka，http://127.0.0.1:1112/eureka,http://127.0.0.1:1113/eureka</span>
</span></span></code></pre></div></li>
</ol>
<p><img src="/post/springcloudalibaba/assets/image-20200910194231047.png"
	width="1495"
	height="341"
	srcset="/post/springcloudalibaba/assets/image-20200910194231047_hu0a029b13266f72e5b430d64af6656528_25146_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910194231047_hu0a029b13266f72e5b430d64af6656528_25146_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910194231047"
	
	
		class="gallery-image" 
		data-flex-grow="438"
		data-flex-basis="1052px"
	
></p>
<h1 id="负载均衡ribbon">负载均衡Ribbon</h1>
<p>Ribbon是一个客户端负载均衡工具.[负载均衡工具]</p>
<p>在刚才的案例中，我们启动了一个user-service，然后通过DiscoveryClient来获取服务实例信息，获取ip和端口来访问。
但是实际环境中，我们往往会开启很多个user-service的集群。此时我们获取的服务列表中就会有多个，到底该访问哪一个呢？
这种情况下我们就需要编写负载均衡算法，在多个实例列表中进行选择。</p>
<h2 id="61-启动两个服务实例">6.1 启动两个服务实例</h2>
<p>在user-service中添加打包插件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/build&gt;</span>
</span></span></code></pre></div><p>为了方便查看哪个服务被调用了，做如下改造</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${server.port}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String port<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getById</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span> Long id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        User user <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> User<span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;tom&#34;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34; from &#34;</span><span style="color:#f92672">+</span>port<span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>  
</span></span></code></pre></div><p>首先我们启动两个user-service实例，一个8001，一个8002。</p>
<p>在IDEA中可以通过如下配置来启动多个实例</p>
<p><img src="/post/springcloudalibaba/assets/image-20200910195802064.png"
	width="917"
	height="285"
	srcset="/post/springcloudalibaba/assets/image-20200910195802064_hub16b0f0c84c3b90c2a5acbcbe820367c_29530_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910195802064_hub16b0f0c84c3b90c2a5acbcbe820367c_29530_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910195802064"
	
	
		class="gallery-image" 
		data-flex-grow="321"
		data-flex-basis="772px"
	
></p>
<p>也可以通过控制台+参数来启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>java -jar user-service-0.0.1-SNAPSHOT.jar --server.port<span style="color:#f92672">=</span><span style="color:#ae81ff">8001</span>
</span></span><span style="display:flex;"><span>java -jar user-service-0.0.1-SNAPSHOT.jar --server.port<span style="color:#f92672">=</span><span style="color:#ae81ff">8002</span>
</span></span></code></pre></div><p>查看Eureka控制面板</p>
<p><img src="/post/springcloudalibaba/assets/image-20200910195845921.png"
	width="1490"
	height="298"
	srcset="/post/springcloudalibaba/assets/image-20200910195845921_hu2788a2e9ffe9b37a43927429c635f9cf_19433_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910195845921_hu2788a2e9ffe9b37a43927429c635f9cf_19433_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910195845921"
	
	
		class="gallery-image" 
		data-flex-grow="500"
		data-flex-basis="1200px"
	
></p>
<p>手动实现负载均衡：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 定义静态变量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> Integer index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserById</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span> Long id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 通过发现客户端获取服务的列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 参数是服务ID，也就是在user-service项目配置文件中定义的spring.application.name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    List<span style="color:#f92672">&lt;</span>ServiceInstance<span style="color:#f92672">&gt;</span> instances <span style="color:#f92672">=</span> discoveryClient<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstances</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user-service&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取实例的数量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> size <span style="color:#f92672">=</span> instances<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 手动实现负载均衡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 第一次进来index = 0 ,instances.get(index) 返回第一个服务实例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 第二次请求 index+1 = 1 ,instances.get(index) 返回第二个服务实例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 第三次请求 index+1 = 2，将index对服务实例总数做取模操作index = 2mod2 = 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    index <span style="color:#f92672">=</span> index <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    index <span style="color:#f92672">=</span> index <span style="color:#f92672">%</span> size<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取具体的实例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ServiceInstance instance <span style="color:#f92672">=</span> instances<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>index<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 通过实例获取访问地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    String host <span style="color:#f92672">=</span> instance<span style="color:#f92672">.</span><span style="color:#a6e22e">getHost</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> port <span style="color:#f92672">=</span> instance<span style="color:#f92672">.</span><span style="color:#a6e22e">getPort</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    String url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://&#34;</span><span style="color:#f92672">+</span>host<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;:&#34;</span><span style="color:#f92672">+</span>port<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/user/&#34;</span> <span style="color:#f92672">+</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用RestTemplate调用user-service的服务接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    User user <span style="color:#f92672">=</span> restTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">getForObject</span><span style="color:#f92672">(</span>url<span style="color:#f92672">,</span> User<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="62-开启负载均衡">6.2 开启负载均衡</h2>
<p>SpringCloud 中已经帮我们集成了负载均衡组件： Ribbon</p>
<p><img src="/post/springcloudalibaba/assets/image-20201024115559030.png"
	width="739"
	height="345"
	srcset="/post/springcloudalibaba/assets/image-20201024115559030_hu870666c7ae9c09800b83ce1bb6302f01_33471_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201024115559030_hu870666c7ae9c09800b83ce1bb6302f01_33471_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201024115559030"
	
	
		class="gallery-image" 
		data-flex-grow="214"
		data-flex-basis="514px"
	
></p>
<p>接下来，我们就来使用Ribbon实现负载均衡。</p>
<p>因为Eureka中已经集成了Ribbon，所以我们无需引入新的依赖。直接修改代码：
在RestTemplate的配置方法上添加 @LoadBalanced注解：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@LoadBalanced</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> RestTemplate <span style="color:#a6e22e">restTemplate</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RestTemplate<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>修改调用方式，不再手动获取ip和端口，而是直接通过服务名称调用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserById</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span> Long id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// String url = &#34;http://localhost:8001/user/&#34; + id;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// String url = &#34;http://&#34;+host+&#34;:&#34;+port+&#34;/user/&#34; + id;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 使用服务ID替换真实地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    String url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://user-service&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/user/&#34;</span> <span style="color:#f92672">+</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    User user <span style="color:#f92672">=</span> restTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">getForObject</span><span style="color:#f92672">(</span>url<span style="color:#f92672">,</span> User<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>访问页面，查看结果，多次刷新页面可以看到不同的返回。</p>
<p><img src="/ssets/image-20200910200316367.png"
	
	
	
	loading="lazy"
	
		alt="image-20200910200316367"
	
	
></p>
<p><img src="/post/springcloudalibaba/assets/image-20200910200329840.png"
	width="481"
	height="201"
	srcset="/post/springcloudalibaba/assets/image-20200910200329840_hub868ccde1afe44b0bcf984402c5f1b1a_7651_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200910200329840_hub868ccde1afe44b0bcf984402c5f1b1a_7651_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200910200329840"
	
	
		class="gallery-image" 
		data-flex-grow="239"
		data-flex-basis="574px"
	
></p>
<h2 id="63-负载均衡原理">6.3 负载均衡原理</h2>
<p>为什么我们只输入了service名称就可以访问了呢？</p>
<p>关键就在于<code>@LoadBalanced</code>注解，源码如下</p>
<p><img src="/post/springcloudalibaba/assets/image-20200524161026269.png"
	width="882"
	height="405"
	srcset="/post/springcloudalibaba/assets/image-20200524161026269_hu67c4effe917feaadbc4fd18c43761ecf_32518_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524161026269_hu67c4effe917feaadbc4fd18c43761ecf_32518_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524161026269"
	
	
		class="gallery-image" 
		data-flex-grow="217"
		data-flex-basis="522px"
	
></p>
<p>找到<code>LoadBalancerClient</code></p>
<p><img src="/post/springcloudalibaba/assets/image-20200524161506121.png"
	width="926"
	height="448"
	srcset="/post/springcloudalibaba/assets/image-20200524161506121_hu69db3ac1d4a57cefbf4a74bcbc670087_24087_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524161506121_hu69db3ac1d4a57cefbf4a74bcbc670087_24087_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524161506121"
	
	
		class="gallery-image" 
		data-flex-grow="206"
		data-flex-basis="496px"
	
></p>
<p>继承自<code>ServiceInstanceChooser</code></p>
<p><img src="/post/springcloudalibaba/assets/image-20200524161533852.png"
	width="836"
	height="309"
	srcset="/post/springcloudalibaba/assets/image-20200524161533852_hube87eca472632c04f57065b36c9871ac_23244_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524161533852_hube87eca472632c04f57065b36c9871ac_23244_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524161533852"
	
	
		class="gallery-image" 
		data-flex-grow="270"
		data-flex-basis="649px"
	
></p>
<p>在<code>LoadBalancerClient</code>所在的包中可以找到自动配置类<code>LoadBalancerAutoConfiguration</code></p>
<p><img src="/post/springcloudalibaba/assets/image-20200708153841700.png"
	width="802"
	height="234"
	srcset="/post/springcloudalibaba/assets/image-20200708153841700_hubb6b25a90f35be59379933334c038ea4_27141_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200708153841700_hubb6b25a90f35be59379933334c038ea4_27141_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200708153841700"
	
	
		class="gallery-image" 
		data-flex-grow="342"
		data-flex-basis="822px"
	
></p>
<p>在该自动化配置类中，主要做了下面三件事:</p>
<ul>
<li>创建了一个LoadBalancerInterceptor的Bean，用于实现对客户端发起请求时进行拦截，以实现客户端负载均衡。</li>
<li>创建了一个RestTemplateCustomizer的Ben，用于给 RestTemplate增加 LoadBalancerInterceptor拦截器。</li>
<li>维护了一个被 LoadBalanced注解修饰的 RestTemplate对象列表，并在这里进行初始化，通过调用RestTemplateCustomizer的实例来给需要客户端负载均衡的 RestTemplate增加 LoadBalancerInterceptor拦截器。</li>
</ul>
<p>接下来，我们看看LoadBalancerInterceptor拦截器是如何将一个普通的RestTemplate变成客户端负载均衡的:</p>
<p><img src="/post/springcloudalibaba/assets/image-20200524163546308.png"
	width="989"
	height="335"
	srcset="/post/springcloudalibaba/assets/image-20200524163546308_hu2a2e94c4ced4feff25d0317f19137029_34841_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524163546308_hu2a2e94c4ced4feff25d0317f19137029_34841_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524163546308"
	
	
		class="gallery-image" 
		data-flex-grow="295"
		data-flex-basis="708px"
	
></p>
<p>execute方法回到了LoadBalancerClient，查看实现类为<code>RibbonLoadBalancerClient</code></p>
<p><img src="/post/springcloudalibaba/assets/image-20200524163746450.png"
	width="919"
	height="416"
	srcset="/post/springcloudalibaba/assets/image-20200524163746450_hu176c5bdedd387d5ba70ac3c917048b94_31062_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524163746450_hu176c5bdedd387d5ba70ac3c917048b94_31062_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524163746450"
	
	
		class="gallery-image" 
		data-flex-grow="220"
		data-flex-basis="530px"
	
></p>
<p>继续跟进</p>
<p><img src="/post/springcloudalibaba/assets/image-20200524164104884.png"
	width="1042"
	height="515"
	srcset="/post/springcloudalibaba/assets/image-20200524164104884_hu4435e8d95f19369ff03a6424c56a0fe2_31620_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524164104884_hu4435e8d95f19369ff03a6424c56a0fe2_31620_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524164104884"
	
	
		class="gallery-image" 
		data-flex-grow="202"
		data-flex-basis="485px"
	
></p>
<p>这里的rule在上面定义，<code>RoundRobinRule</code>即为轮询的意思</p>
<p><img src="/post/springcloudalibaba/assets/image-20200524164159784.png"
	width="1009"
	height="285"
	srcset="/post/springcloudalibaba/assets/image-20200524164159784_hu11602964266c124f89cd3320e9695031_35033_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524164159784_hu11602964266c124f89cd3320e9695031_35033_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524164159784"
	
	
		class="gallery-image" 
		data-flex-grow="354"
		data-flex-basis="849px"
	
></p>
<p>查看实现</p>
<p><img src="/post/springcloudalibaba/assets/image-20200524164525099.png"
	width="843"
	height="664"
	srcset="/post/springcloudalibaba/assets/image-20200524164525099_hue2d7ce5c41022d7923d1cd0df945c0a5_41254_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524164525099_hue2d7ce5c41022d7923d1cd0df945c0a5_41254_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524164525099"
	
	
		class="gallery-image" 
		data-flex-grow="126"
		data-flex-basis="304px"
	
></p>
<p>可以看到这里的算法是使用了原子类，每次对这个原子类做+1后对服务器数量取模，再通过CAS设置原子类的最新值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> AtomicInteger nextServerCyclicCounter<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">RoundRobinRule</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    nextServerCyclicCounter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicInteger<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">incrementAndGetModulo</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> modulo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> current <span style="color:#f92672">=</span> nextServerCyclicCounter<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> next <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>current <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">%</span> modulo<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nextServerCyclicCounter<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span>current<span style="color:#f92672">,</span> next<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> next<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>CAS(V,E,N)，V指要更新的变量，E指要更新的期望值，N指更新后的值，当且仅当V的值等于E时，才将V更新成N。如果V的值不等于E，就表示这个变量已经被其他的任务更新过了，此次更新失败，进入循环继续执行。</p>
<p>CAS操作保证同一时刻只有一个任务能够更新成功，其他的进入循环继续尝试执行更新。</p>
<p>再看一下IRule的实现有下面这些：</p>
<p><img src="/post/springcloudalibaba/assets/image-20200524165008102.png"
	width="647"
	height="463"
	srcset="/post/springcloudalibaba/assets/image-20200524165008102_hu9264aafcc498236955c319af16d3c0ec_60312_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200524165008102_hu9264aafcc498236955c319af16d3c0ec_60312_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524165008102"
	
	
		class="gallery-image" 
		data-flex-grow="139"
		data-flex-basis="335px"
	
></p>
<p><strong>负载均衡原理总结</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span><span style="color:#66d9ef">1.</span> 在RestTemplate上添加了@LoadBalanced注解后，会使用LoadBalancerClient来配置RestTemplate
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">2.</span> Spring Cloud Ribbon 的自动配置类LoadBalancerAutoConfiguration中的@ConditionalOnBean(LoadBalancerClient.class)条件成立
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">3.</span> 自动配置中添加了LoadBalancerInterceptor，这个拦截器会拦截请求，通过服务ID获取服务的地址列表，然后通过负载均衡算法选出一个地址进行调用
</span></span></code></pre></div><p><img src="/post/springcloudalibaba/assets/image-20200708155757838.png"
	width="906"
	height="640"
	srcset="/post/springcloudalibaba/assets/image-20200708155757838_hu5fe62a14ee4846a71724906f9c4b3167_67898_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200708155757838_hu5fe62a14ee4846a71724906f9c4b3167_67898_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200708155757838"
	
	
		class="gallery-image" 
		data-flex-grow="141"
		data-flex-basis="339px"
	
></p>
<h2 id="64-切换负载均衡策略">6.4 切换负载均衡策略</h2>
<p>Spring Cloud 可以通过如下方式对RibbonClient做个性化配置：</p>
<p>全局配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">ribbon.{key}</span><span style="color:#f92672">=</span><span style="color:#e6db74">{value}</span>
</span></span></code></pre></div><p>指定服务配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">{服务名称}.ribbon.{key}</span><span style="color:#f92672">=</span><span style="color:#e6db74">{value}</span>
</span></span></code></pre></div><p>这里切换为随机</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">pay-service</span>: 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ribbon</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">NFLoadBalancerRuleClassName</span>: <span style="color:#ae81ff">com.netflix.loadbalancer.RandomRule</span>
</span></span></code></pre></div><p>再次测试，发现结果变成了随机访问 。</p>
<h2 id="65-ribbon的饥饿加载和懒加载">6.5 Ribbon的饥饿加载和懒加载</h2>
<p>Ribbon默认是采用<strong>懒加载</strong>，即第一次访问时才会去创建LoadBalanceClient，因为创建的过程中要去做服务拉取，所以请求时间会很长。</p>
<p>而<strong>饥饿加载</strong>则是在项目启动时创建，降低第一次访问的耗时。</p>
<ul>
<li>如图所示:</li>
<li>可以看到有一次userservice instantiated a loadBalancer–userservice初始化负载均衡器；
初始时服务列表为空，所以会做一次PollingServerListUpdater–拉取服务；
而拉取服务的过程中就会去创建：DynamicServerListLoadBalancer。
所以就会消耗很长的时间,这就是所谓的懒加载。</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/34b19298f57848a4b37d9c745e821050.png"
	width="1857"
	height="673"
	srcset="/post/springcloudalibaba/assets/34b19298f57848a4b37d9c745e821050_hu0d21a1a23d2d062f6fadcc7640f47b32_261683_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/34b19298f57848a4b37d9c745e821050_hu0d21a1a23d2d062f6fadcc7640f47b32_261683_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
		class="gallery-image" 
		data-flex-grow="275"
		data-flex-basis="662px"
	
></p>
<ul>
<li>通过下面配置开启饥饿加载</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ribbon:
</span></span><span style="display:flex;"><span>  eager<span style="color:#f92672">-</span>load<span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>    enabled<span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">开启饥饿加载</span>
</span></span><span style="display:flex;"><span>    clients<span style="color:#f92672">:</span>  <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">指定饥饿加载的服务名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> userservice
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> xxxxService
</span></span></code></pre></div><h1 id="nacos-注册中心">Nacos 注册中心</h1>
<h2 id="1nacos-概述">1.Nacos 概述</h2>
<p>Nacos 是阿里巴巴推出来的一个新<a class="link" href="https://so.csdn.net/so/search?q=%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE&amp;spm=1001.2101.3001.7020"  target="_blank" rel="noopener"
    >开源项目</a>，这是一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Nacos<span style="color:#960050;background-color:#1e0010">：注册中心</span> <span style="color:#f92672">+</span> <span style="color:#960050;background-color:#1e0010">配置中心的组件</span>
</span></span></code></pre></div><p>一句话概括就是<strong>Nacos = Spring Cloud Eureka 服务中心 + Spring Cloud Config配置中心。</strong>
• 官网：https://nacos.io/zh-cn/
• 下载地址： <a class="link" href="https://github.com/alibaba/nacos/releases"  target="_blank" rel="noopener"
    >https://github.com/alibaba/nacos/releases</a></p>
<h2 id="2nacosa安装">2.Nacosa安装</h2>
<p>Windows下启动 nacos-server</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>startup.cmd -m standalone
</span></span></code></pre></div><p><img src="/post/springcloudalibaba/assets/image-20201116174126354.png"
	width="360"
	height="285"
	srcset="/post/springcloudalibaba/assets/image-20201116174126354_hu270b202bb60c982a82d4ee718dd091fc_13422_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201116174126354_hu270b202bb60c982a82d4ee718dd091fc_13422_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201116174126354"
	
	
		class="gallery-image" 
		data-flex-grow="126"
		data-flex-basis="303px"
	
></p>
<p>启动成功效果：</p>
<p><img src="/post/springcloudalibaba/assets/image-20201116174149589.png"
	width="1223"
	height="639"
	srcset="/post/springcloudalibaba/assets/image-20201116174149589_hu8402b148133038fa429d83277f3ae476_75061_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201116174149589_hu8402b148133038fa429d83277f3ae476_75061_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201116174149589"
	
	
		class="gallery-image" 
		data-flex-grow="191"
		data-flex-basis="459px"
	
></p>
<p>控制台登录 http://localhost:8848/nacos</p>
<p>账号，密码：nacos</p>
<p><img src="/post/springcloudalibaba/assets/1587539128223.png"
	width="1916"
	height="1011"
	srcset="/post/springcloudalibaba/assets/1587539128223_huf558144894220a202fcf91076c6ef688_319815_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1587539128223_huf558144894220a202fcf91076c6ef688_319815_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1587539128223"
	
	
		class="gallery-image" 
		data-flex-grow="189"
		data-flex-basis="454px"
	
></p>
<p>控制台页面</p>
<p><img src="/post/springcloudalibaba/assets/1587539185231.png"
	width="1920"
	height="1024"
	srcset="/post/springcloudalibaba/assets/1587539185231_hu389d7215cb701a5b6a39f6b06367549d_235058_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1587539185231_hu389d7215cb701a5b6a39f6b06367549d_235058_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1587539185231"
	
	
		class="gallery-image" 
		data-flex-grow="187"
		data-flex-basis="450px"
	
></p>
<h2 id="3nacos-快速入门">3.Nacos 快速入门</h2>
<p>Spring Cloud 可以与Nacos进行无缝对接</p>
<p>Spring cloud Alibaba 组件 <a class="link" href="https://spring.io/projects/spring-cloud-alibaba"  target="_blank" rel="noopener"
    >https://spring.io/projects/spring-cloud-alibaba</a></p>
<p>在父工程中添加依赖管理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;com.alibaba.cloud&gt;</span>2.1.2.RELEASE<span style="color:#f92672">&lt;/com.alibaba.cloud&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-alibaba-dependencies<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>${com.alibaba.cloud}<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;type&gt;</span>pom<span style="color:#f92672">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;scope&gt;</span>import<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencyManagement&gt;</span>
</span></span></code></pre></div><p>在user-service 和 consumer-service中添加依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server-addr</span>:  <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">8848</span> <span style="color:#75715e"># 配置nacos 服务端地址</span>
</span></span></code></pre></div><p>控制台显示</p>
<p><img src="/post/springcloudalibaba/assets/image-20201116175857334.png"
	width="1378"
	height="482"
	srcset="/post/springcloudalibaba/assets/image-20201116175857334_hu068a83e7bbbbf612b796626fb4419598_32855_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201116175857334_hu068a83e7bbbbf612b796626fb4419598_32855_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201116175857334"
	
	
		class="gallery-image" 
		data-flex-grow="285"
		data-flex-basis="686px"
	
></p>
<h2 id="4nacos与eureka的区别">4.Nacos与Eureka的区别</h2>
<ul>
<li>
<p>常见的注册中心</p>
<p>Eureka
​	Eureka是Netflix公司开源的注册中心,后被整合到Spring Cloud中
Zookeeper
​	这个说起来有点意思的是官方并没有说他是一个注册中心，
​	但是国内Dubbo场景下很多都是使用Zookeeper来完成了注册中心的功能。
Consul（原生，GO语言开发）
​	Consul 是 HashiCorp 公司推出的开源工具，用于实现分布式系统的服务发现与配
​	置。Consul 使用 Go 语言编写，因此具有天然可移植性(支持Linux、windows和
​	Mac OS X)。
Nacos
​	相对于 Spring Cloud Eureka 来说，Nacos 更强大。
​	Nacos = Spring Cloud Eureka + Spring Cloud Config
​	Nacos 可以与 Spring, Spring Boot, Spring Cloud 集成，
​	并能代替 Spring Cloud Eureka, Spring Cloud Config。</p>
</li>
<li>
<p>Nacos和Eureka的区别</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ae81ff">1.</span><span style="color:#960050;background-color:#1e0010">部署方式不同</span>
</span></span><span style="display:flex;"><span>	euraka<span style="color:#960050;background-color:#1e0010">是需要创建</span>springboot<span style="color:#960050;background-color:#1e0010">项目，然后将</span>euraka<span style="color:#960050;background-color:#1e0010">服务端通过</span>gav<span style="color:#960050;background-color:#1e0010">的方式加载进来，然后部署项目。</span>
</span></span><span style="display:flex;"><span>	nacos<span style="color:#960050;background-color:#1e0010">是直接从阿里巴巴</span>nacos<span style="color:#960050;background-color:#1e0010">的官网下载</span>jar<span style="color:#960050;background-color:#1e0010">包，启动服务。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2.</span><span style="color:#960050;background-color:#1e0010">连接方式不同</span>
</span></span><span style="display:flex;"><span>	nacos<span style="color:#960050;background-color:#1e0010">使用的是</span>netty<span style="color:#960050;background-color:#1e0010">和服务直接进行连接</span><span style="color:#f92672">,</span><span style="color:#960050;background-color:#1e0010">属于长连接</span>
</span></span><span style="display:flex;"><span>	eureka<span style="color:#960050;background-color:#1e0010">是使用定时发送和服务进行联系</span><span style="color:#f92672">,</span><span style="color:#960050;background-color:#1e0010">属于短连接</span>	
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3.</span><span style="color:#960050;background-color:#1e0010">服务异常剔除策略不同</span>
</span></span><span style="display:flex;"><span>	eureka<span style="color:#f92672">:</span>Eureka<span style="color:#960050;background-color:#1e0010">中会定时向注册中心发送心跳，如果在规定时间内没有发送心跳</span> <span style="color:#ae81ff">30</span><span style="color:#960050;background-color:#1e0010">，则就会直接剔除。</span>  <span style="color:#ae81ff">90</span>
</span></span><span style="display:flex;"><span>	Nacos<span style="color:#f92672">:</span>nacos<span style="color:#960050;background-color:#1e0010">也会向注册中心发送心跳，但是它的频率要比</span>Eureka<span style="color:#960050;background-color:#1e0010">快。</span><span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">在</span>Nacos<span style="color:#960050;background-color:#1e0010">中又分为临时实例和非临时实例。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">如果是临时实例的话，短期内没有发送心跳，则会直接剔除。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">如果是非临时实例长时间宕机，不会直接剔除，并且注册中心会直接主动询问并且等待非临时实例。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4.</span><span style="color:#960050;background-color:#1e0010">消费者拉去数据方式不同</span>
</span></span><span style="display:flex;"><span>	Eureka<span style="color:#960050;background-color:#1e0010">会定时向注册中心定时拉去服务</span><span style="color:#f92672">,</span><span style="color:#960050;background-color:#1e0010">如果不主动拉去服务</span><span style="color:#f92672">,</span><span style="color:#960050;background-color:#1e0010">注册中心不会主动推送。</span>
</span></span><span style="display:flex;"><span>	Nacos<span style="color:#960050;background-color:#1e0010">中注册中心会定时向消费者主动推送信息</span><span style="color:#f92672">,</span><span style="color:#960050;background-color:#1e0010">这样就会保持数据的准时性。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5.</span><span style="color:#960050;background-color:#1e0010">自我保护机制不同</span>
</span></span><span style="display:flex;"><span>	Eureka<span style="color:#960050;background-color:#1e0010">保护方式：当在短时间内，统计续约失败的比例，如果达到一定阈值，则会触发自我保护的机制，在该机制下，</span>Eureka Server<span style="color:#960050;background-color:#1e0010">不会剔除任何的微服务，等到正常后，再退出自我保护机制。自我保护开关</span><span style="color:#f92672">(</span>eureka<span style="color:#f92672">.</span><span style="color:#a6e22e">server</span><span style="color:#f92672">.</span><span style="color:#a6e22e">enable</span><span style="color:#f92672">-</span>self<span style="color:#f92672">-</span>preservation<span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	Nacos<span style="color:#960050;background-color:#1e0010">保护方式：当域名健康实例</span> <span style="color:#f92672">(</span>Instance<span style="color:#f92672">)</span> <span style="color:#960050;background-color:#1e0010">占总服务实例</span><span style="color:#f92672">(</span>Instance<span style="color:#f92672">)</span> <span style="color:#960050;background-color:#1e0010">的比例小于阈值时，无论实例</span> <span style="color:#f92672">(</span>Instance<span style="color:#f92672">)</span> <span style="color:#960050;background-color:#1e0010">是否健康，都会将这个实例</span> <span style="color:#f92672">(</span>Instance<span style="color:#f92672">)</span> <span style="color:#960050;background-color:#1e0010">返回给客户端。这样做虽然损失了一部分流量，但是保证了集群的剩余健康实例</span> <span style="color:#f92672">(</span>Instance<span style="color:#f92672">)</span> <span style="color:#960050;background-color:#1e0010">能正常工作。</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6.</span>Nacos<span style="color:#960050;background-color:#1e0010">集群默认采用</span>AP<span style="color:#960050;background-color:#1e0010">方式也可以修改为采用</span>CP<span style="color:#960050;background-color:#1e0010">模式；</span>
</span></span><span style="display:flex;"><span>  Eureka<span style="color:#960050;background-color:#1e0010">采用</span>AP<span style="color:#960050;background-color:#1e0010">方式</span> 
</span></span><span style="display:flex;"><span>  C<span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">一致性</span><span style="color:#f92672">)</span>A<span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">高可用性</span><span style="color:#f92672">)</span>P<span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">分区容错性</span><span style="color:#f92672">)</span><span style="color:#960050;background-color:#1e0010">定理</span>
</span></span></code></pre></div><h2 id="5nacos多级服务存储模型">5.Nacos多级服务存储模型</h2>
<p><img src="/post/springcloudalibaba/assets/bb939bca375b4d71840a8cf015249156.png"
	width="1962"
	height="1008"
	srcset="/post/springcloudalibaba/assets/bb939bca375b4d71840a8cf015249156_hu3b832e3d5ed61d5c6df009c6c588e670_324563_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/bb939bca375b4d71840a8cf015249156_hu3b832e3d5ed61d5c6df009c6c588e670_324563_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="在这里插入图片描述"
	
	
		class="gallery-image" 
		data-flex-grow="194"
		data-flex-basis="467px"
	
></p>
<h3 id="1多级服务存储模型介绍">1.多级服务存储模型介绍</h3>
<p>为了提升整个系统的容灾性，Nacos 引入了地域 (Zone) 的概念，如上图中的北京、上海和杭州。把同一个服务的多个实例部署到不同地域的机房中(鸡蛋分开不同的篮子放) ；</p>
<p>又把在同一个地域的机房的多个服务实例称为集群 (Cluster) 。比如，杭州机房的 2 个用户服务 <code>user-service</code> 称为杭州 <code>user-service</code> 集群。</p>
<p>因此，在 Nacos 的服务分级模型中，</p>
<ul>
<li>
<p>第一级是微服务 (如订单服务) ；</p>
</li>
<li>
<p>第二级是集群 (如北京订单服务集群、上海订单服务集群等) ；</p>
</li>
<li>
<p>第三集是实例 (如杭州服务集群的 8081 端口实例、8082 端口实例等) 。</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>spring:
</span></span><span style="display:flex;"><span>  cloud<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    nacos<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	 discovery<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		server<span style="color:#f92672">-</span>addr<span style="color:#f92672">:</span> localhost<span style="color:#f92672">:</span><span style="color:#ae81ff">8848</span> <span style="color:#960050;background-color:#1e0010">#服务中心地址</span>
</span></span><span style="display:flex;"><span>        cluster<span style="color:#f92672">-</span>name<span style="color:#f92672">:</span> HZ <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">集群名称</span>
</span></span></code></pre></div></li>
</ul>
<p><img src="/post/springcloudalibaba/assets/1682943142439.png"
	width="956"
	height="521"
	srcset="/post/springcloudalibaba/assets/1682943142439_hu2e1dc475de573960f15063c75ea61777_147163_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1682943142439_hu2e1dc475de573960f15063c75ea61777_147163_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682943142439"
	
	
		class="gallery-image" 
		data-flex-grow="183"
		data-flex-basis="440px"
	
></p>
<h3 id="2集群优先负载均衡策略">2.集群优先负载均衡策略</h3>
<p>对于服务的调用，杭州的服务消费者调用哪个服务提供者的效率会更高?</p>
<p>肯定是调用杭州自身的服务肯定效率会比调用上海的更高，因此我们<code>对于同一集群下的服务应该优先调用</code>，从而降低网络延时，提高响应速度。</p>
<ul>
<li>因此Nacos中提供了一个<code>NacosRule</code>的实现，可以<code>优先从同集群中挑选实例</code>。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ae81ff">1.</span><span style="color:#960050;background-color:#1e0010">给服务消费者配置所在集群</span>
</span></span><span style="display:flex;"><span>spring:
</span></span><span style="display:flex;"><span>  cloud<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    nacos<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      server<span style="color:#f92672">-</span>addr<span style="color:#f92672">:</span> localhost<span style="color:#f92672">:</span><span style="color:#ae81ff">8848</span>
</span></span><span style="display:flex;"><span>      discovery<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        cluster<span style="color:#f92672">-</span>name<span style="color:#f92672">:</span> HZ <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">集群名称</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2.</span><span style="color:#960050;background-color:#1e0010">修改负载均衡规则</span>
</span></span><span style="display:flex;"><span>userservice:
</span></span><span style="display:flex;"><span>  ribbon<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    NFLoadBalancerRuleClassName<span style="color:#f92672">:</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">alibaba</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cloud</span><span style="color:#f92672">.</span><span style="color:#a6e22e">nacos</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ribbon</span><span style="color:#f92672">.</span><span style="color:#a6e22e">NacosRule</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">负载均衡规则</span>    
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3.</span><span style="color:#960050;background-color:#1e0010">重新启动消费者和提供者</span><span style="color:#f92672">,</span><span style="color:#960050;background-color:#1e0010">测试调用结果</span>    
</span></span></code></pre></div><h2 id="6服务实例的权重设置">6.服务实例的权重设置</h2>
<p>企业中我们部署项目的时候，可能会存在这么一种情况</p>
<ul>
<li>企业里服务器设备，有一些机器性能比较好，还有一些属于是祖传设备了，性能非常的差，这个时候呢，我们肯定是希望这些性能好的机器，它承担更多的用户请求，而那些性能差一点的，自然是承担少一点的请求，正所谓能者多劳嘛。</li>
<li>但是我们目前看来，NacosRule做到的是集群优先，而后做随机，当用户请求来了以后，它可不管你是性格好的还是差，这个身强力壮的还是老弱病残拉过来就一顿造，那这个时候那些性能差的肯定就会出问题。那么我们该怎样去控制不同服务它的一个请求量呢？于是,Nacos，给我们提供了一个权重的配置，通过修改服务实力的权重，可以控制访问频率，权重越大，访问到的频率就越高，那我们就可以把性能好的机器全都设得大一点，性能差一些呢，设置的小一点。</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/1682943818566.png"
	width="1152"
	height="618"
	srcset="/post/springcloudalibaba/assets/1682943818566_hu231b5e970fd37b9ad41697fa9c3ee23e_240716_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1682943818566_hu231b5e970fd37b9ad41697fa9c3ee23e_240716_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682943818566"
	
	
		class="gallery-image" 
		data-flex-grow="186"
		data-flex-basis="447px"
	
></p>
<p><strong>权重设置为0时</strong>，该实例就不会被访问了，也就是说权重调整0时，它压根儿就不会被访问。</p>
<h2 id="7nacos多环境隔离-namespace">7.Nacos多环境隔离-namespace</h2>
<ul>
<li>
<p>namespace理解</p>
<p>Nacos中服务存储和数据存储的最外层都是一个名为namespace的东西，用来做最外层隔离。</p>
</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/1682944914489.png"
	width="339"
	height="235"
	srcset="/post/springcloudalibaba/assets/1682944914489_hubd877c5ea8a8f52a697511682056528b_3428_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1682944914489_hubd877c5ea8a8f52a697511682056528b_3428_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682944914489"
	
	
		class="gallery-image" 
		data-flex-grow="144"
		data-flex-basis="346px"
	
></p>
<p>Namespace：命名空间，常用于生产环境、开发环境的区分。
Group：组，常用将业务相关程度较高的放同一个组（订单和支付）。</p>
<ul>
<li>创建命名空间</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/1682945006922.png"
	width="529"
	height="276"
	srcset="/post/springcloudalibaba/assets/1682945006922_hu789bdaf591b54e8086ccc133b750b807_22858_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1682945006922_hu789bdaf591b54e8086ccc133b750b807_22858_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682945006922"
	
	
		class="gallery-image" 
		data-flex-grow="191"
		data-flex-basis="460px"
	
></p>
<ul>
<li>
<p>在服务提供者的application.yml中添加：</p>
<p><img src="/post/springcloudalibaba/assets/1682945147536.png"
	width="737"
	height="253"
	srcset="/post/springcloudalibaba/assets/1682945147536_hu4b51c392e2f0845431b9e41103899984_43054_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1682945147536_hu4b51c392e2f0845431b9e41103899984_43054_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1682945147536"
	
	
		class="gallery-image" 
		data-flex-grow="291"
		data-flex-basis="699px"
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>cloud:
</span></span><span style="display:flex;"><span>    nacos<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        discovery<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            namespace<span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">命名空间</span>ID
</span></span></code></pre></div></li>
<li>
<p>作用</p>
<p>namespace用来做环境隔离。
每个namespace都有唯一id。
不同namespace下的服务不可见 。</p>
</li>
</ul>
<h1 id="nacos-配置中心">Nacos 配置中心</h1>
<h2 id="1快速入门">1.快速入门</h2>
<ul>
<li>Nacos配置中心依赖</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-config<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ul>
<li><strong>bootstrap.yml</strong> 配置文件中添加配置</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8001</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">config</span>: <span style="color:#75715e"># 配置中心配置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">localhost:8848</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">file-extension</span>: <span style="color:#ae81ff">yaml</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">discovery</span>: <span style="color:#75715e"># 注册中心配置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">localhost:8848</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service</span>
</span></span></code></pre></div><p>在配置中心添加配置</p>
<p><img src="/post/springcloudalibaba/assets/image-20201125195052675.png"
	width="1672"
	height="351"
	srcset="/post/springcloudalibaba/assets/image-20201125195052675_hu93df8c26d34f00c800682851672a010f_22167_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201125195052675_hu93df8c26d34f00c800682851672a010f_22167_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201125195052675"
	
	
		class="gallery-image" 
		data-flex-grow="476"
		data-flex-basis="1143px"
	
></p>
<p>配置如下</p>
<p><img src="/post/springcloudalibaba/assets/image-20201125195156864.png"
	width="1671"
	height="844"
	srcset="/post/springcloudalibaba/assets/image-20201125195156864_hu7a3eb07707565a19d3c938fb2354c07d_40498_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201125195156864_hu7a3eb07707565a19d3c938fb2354c07d_40498_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201125195156864"
	
	
		class="gallery-image" 
		data-flex-grow="197"
		data-flex-basis="475px"
	
></p>
<p><strong>Data ID默认规则是：</strong></p>
<ul>
<li>默认情况下，会加载Data ID以<code> ${spring.application.name}.${file-extension}</code>为前缀的配置信息</li>
<li>在bootstrap.yml中配置<code>spring.cloud.nacos.config.file-extension=yaml</code>，会读取Data ID 为<code>${spring.application.name}.yaml</code> 的配置信息</li>
</ul>
<p>启动user-service 服务,访问 http://localhost:8001/user/2</p>
<p><img src="/post/springcloudalibaba/assets/image-20201125195230068.png"
	width="480"
	height="196"
	srcset="/post/springcloudalibaba/assets/image-20201125195230068_hub762454b13f71390c8ec8b7ae167ce1b_7223_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201125195230068_hub762454b13f71390c8ec8b7ae167ce1b_7223_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201125195230068"
	
	
		class="gallery-image" 
		data-flex-grow="244"
		data-flex-basis="587px"
	
></p>
<h2 id="2配置动态刷新">2.配置动态刷新</h2>
<p>在nacos中修改配置,点击发布</p>
<p><img src="/post/springcloudalibaba/assets/image-20201125195316802.png"
	width="1666"
	height="851"
	srcset="/post/springcloudalibaba/assets/image-20201125195316802_hu2a5a84348b36101c2939ed46d48612a2_41643_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201125195316802_hu2a5a84348b36101c2939ed46d48612a2_41643_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201125195316802"
	
	
		class="gallery-image" 
		data-flex-grow="195"
		data-flex-basis="469px"
	
></p>
<p>会提示差别</p>
<p><img src="/post/springcloudalibaba/assets/image-20201125195329383.png"
	width="1516"
	height="651"
	srcset="/post/springcloudalibaba/assets/image-20201125195329383_hufba910a863fd4bf4f4d1b538adaa9b9e_11687_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201125195329383_hufba910a863fd4bf4f4d1b538adaa9b9e_11687_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201125195329383"
	
	
		class="gallery-image" 
		data-flex-grow="232"
		data-flex-basis="558px"
	
>点击发布后刷新页面,会看到最新的值</p>
<p><img src="/post/springcloudalibaba/assets/image-20201125195408894.png"
	width="466"
	height="198"
	srcset="/post/springcloudalibaba/assets/image-20201125195408894_hu0b7913a9e8f88ef263c1e3dcfebf4519_7365_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201125195408894_hu0b7913a9e8f88ef263c1e3dcfebf4519_7365_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201125195408894"
	
	
		class="gallery-image" 
		data-flex-grow="235"
		data-flex-basis="564px"
	
></p>
<h2 id="3多环境配置与共享">3.多环境配置与共享</h2>
<ul>
<li>微服务启动时会从nacos读取多个配置文件：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">、</span><span style="color:#f92672">[</span>spring<span style="color:#f92672">.</span><span style="color:#a6e22e">application</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span><span style="color:#f92672">]-[</span>spring<span style="color:#f92672">.</span><span style="color:#a6e22e">profiles</span><span style="color:#f92672">.</span><span style="color:#a6e22e">active</span><span style="color:#f92672">].</span><span style="color:#a6e22e">yaml</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">【服务名】</span><span style="color:#f92672">-</span><span style="color:#960050;background-color:#1e0010">【环境】</span><span style="color:#f92672">.</span><span style="color:#a6e22e">yaml</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如：</span>userservice<span style="color:#f92672">-</span>dev<span style="color:#f92672">.</span><span style="color:#a6e22e">yaml</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如：</span>userservice<span style="color:#f92672">-</span>test<span style="color:#f92672">.</span><span style="color:#a6e22e">yaml</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如：</span>userservice<span style="color:#f92672">-</span>pro<span style="color:#f92672">.</span><span style="color:#a6e22e">yaml</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">、</span> <span style="color:#f92672">[</span>spring<span style="color:#f92672">.</span><span style="color:#a6e22e">application</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span><span style="color:#f92672">].</span><span style="color:#a6e22e">yaml</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">【服务名】</span><span style="color:#f92672">.</span><span style="color:#a6e22e">yaml</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如：</span>userservice<span style="color:#f92672">.</span><span style="color:#a6e22e">yaml</span> 
</span></span></code></pre></div><p>无论profile（环境）如何变化，[spring.application.name].yaml 这个文件一定会被加载、一定会被读取，因此<strong>多环境共享的配置</strong>可以写入这个文件。</p>
<ul>
<li>
<p>配置实战</p>
<p>userservice.yaml  userservice-test/dev/pro.yaml</p>
</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/910808fcd4154c20aeaa24f4aca3155a.png"
	width="852"
	height="491"
	srcset="/post/springcloudalibaba/assets/910808fcd4154c20aeaa24f4aca3155a_hu90252f03ed2214854e5ed03a78d118f3_54360_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/910808fcd4154c20aeaa24f4aca3155a_hu90252f03ed2214854e5ed03a78d118f3_54360_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="173"
		data-flex-basis="416px"
	
></p>
<p>如图所示，我们在bootstrap.yml里面配置了 微服务名、Nacos地址、文件后缀名，由这三部分即可组成 userservice.yaml 文件配置名，也就是你在Nacos配置中心配置的名字，Nacos就是通过这种方式找到需要读取的配置文件的。</p>
<p>根据图片配置，可以得知 userservice-dev.yaml 配置文件也会被读取到，因为配置了dev开发环境,但是无论如何 userservice.yaml配置文件是一定会被读取的。</p>
<p><img src="/post/springcloudalibaba/assets/98b2e31f63554f6ead8876695fa16c97.png"
	width="1267"
	height="502"
	srcset="/post/springcloudalibaba/assets/98b2e31f63554f6ead8876695fa16c97_hubf28c091031e32c1afd456bc3d68a898_121702_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/98b2e31f63554f6ead8876695fa16c97_hubf28c091031e32c1afd456bc3d68a898_121702_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="252"
		data-flex-basis="605px"
	
></p>
<h1 id="nacos集群">Nacos集群</h1>
<h2 id="1nacos集群架构">1.Nacos集群架构</h2>
<p>Nacos集群的部署过程中,至少需要3台服务器部署节点集群</p>
<p>安装3个以上Nacos</p>
<p>​        我们可以复制之前已经解压好的nacos文件夹，分别命名为nacos,nacos1,nacos2</p>
<p><img src="/post/springcloudalibaba/assets/1683014894641.png"
	width="685"
	height="776"
	srcset="/post/springcloudalibaba/assets/1683014894641_hu9c55efbccb76ac0e8837187f21908249_56497_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1683014894641_hu9c55efbccb76ac0e8837187f21908249_56497_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1683014894641"
	
	
		class="gallery-image" 
		data-flex-grow="88"
		data-flex-basis="211px"
	
></p>
<h2 id="2nacos集群搭建步骤">2.Nacos集群搭建步骤</h2>
<h3 id="21-第一步设置集群">2.1 第一步设置集群</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>nacos<span style="color:#960050;background-color:#1e0010">中</span>bin<span style="color:#960050;background-color:#1e0010">目录下打开</span>startup<span style="color:#f92672">.</span><span style="color:#a6e22e">cmd</span><span style="color:#960050;background-color:#1e0010">设置集群</span>
</span></span></code></pre></div><p><img src="/post/springcloudalibaba/assets/1958425dd22a48cf9dfa9c32f2e46d4b.png"
	width="1044"
	height="449"
	srcset="/post/springcloudalibaba/assets/1958425dd22a48cf9dfa9c32f2e46d4b_hu877b2788becfaeaf42c69486ecf00c31_66495_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1958425dd22a48cf9dfa9c32f2e46d4b_hu877b2788becfaeaf42c69486ecf00c31_66495_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="232"
		data-flex-basis="558px"
	
></p>
<h3 id="22-第二步配置集群配置文件">2.2 第二步配置集群配置文件</h3>
<p>由于是单机演示，需要更改nacos/conf目录下application.peoperties中server.port,防止端口冲突,设置端口分别8848、8849、8850</p>
<p>如果服务器有多个ip也要指定具体的ip地址，如:nacos.inetutils.ip-address=x.x.x.x</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">例如</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> server<span style="color:#f92672">.</span><span style="color:#a6e22e">port</span><span style="color:#f92672">=</span><span style="color:#ae81ff">8850</span>
</span></span><span style="display:flex;"><span> nacos<span style="color:#f92672">.</span><span style="color:#a6e22e">inetutils</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ip</span><span style="color:#f92672">-</span>address<span style="color:#f92672">=</span><span style="color:#ae81ff">127.0.0.1</span>
</span></span></code></pre></div><p>在所有nacos目录下conf目录下，有文件cluster.conf.exqmple，将其命名cluster.conf,并将每行配置成为ip:port.(请配置3个或者3个以上节点)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>example
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">127.0.0.1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">8848</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">127.0.0.1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">8849</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">127.0.0.1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">8850</span>
</span></span></code></pre></div><h3 id="23-第三步初始化-nacos的数据库为mysql数据库">2.3 第三步初始化 nacos的数据库为mysql数据库</h3>
<ul>
<li>找到/nacos/conf下的nacos-mysql.sql脚本</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/1c9f5955ed7e949f242a41039edae2d9.png"
	width="554"
	height="172"
	srcset="/post/springcloudalibaba/assets/1c9f5955ed7e949f242a41039edae2d9_huf6b7723eb266f309ab6907bb6adf44f7_74816_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1c9f5955ed7e949f242a41039edae2d9_huf6b7723eb266f309ab6907bb6adf44f7_74816_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="322"
		data-flex-basis="773px"
	
></p>
<ul>
<li>
<p>在MySQL实例创建 nacos库并执行sql脚本</p>
<p>​	<img src="/post/springcloudalibaba/assets/307de645f39cc9bbedbc70d066cc57fd.png"
	width="511"
	height="253"
	srcset="/post/springcloudalibaba/assets/307de645f39cc9bbedbc70d066cc57fd_hub15affe7387cbd9d216745d88da4a826_68697_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/307de645f39cc9bbedbc70d066cc57fd_hub15affe7387cbd9d216745d88da4a826_68697_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="201"
		data-flex-basis="484px"
	
></p>
</li>
<li>
<p>修改 Nacos 配置文件，指向MySQL实例，替换其内嵌数据库</p>
<p><img src="/post/springcloudalibaba/assets/d57252ab11dacdbf42b545e62c83ff5c.png"
	width="554"
	height="149"
	srcset="/post/springcloudalibaba/assets/d57252ab11dacdbf42b545e62c83ff5c_hu350168bdf6790f3d7a0c4e67d5240eeb_69800_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/d57252ab11dacdbf42b545e62c83ff5c_hu350168bdf6790f3d7a0c4e67d5240eeb_69800_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="371"
		data-flex-basis="892px"
	
></p>
</li>
<li>
<p>在application.properties中找到如下配置，该配置默认为注释掉的，取消注释即可，修改数据库信息为实际的数据库信息后保存。其他nacos服务实例也需要做同样的修改</p>
<p><img src="/post/springcloudalibaba/assets/1683015673779.png"
	width="1175"
	height="455"
	srcset="/post/springcloudalibaba/assets/1683015673779_hu6e8d001e65a73dd365de9333c4f5c16f_32343_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1683015673779_hu6e8d001e65a73dd365de9333c4f5c16f_32343_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1683015673779"
	
	
		class="gallery-image" 
		data-flex-grow="258"
		data-flex-basis="619px"
	
></p>
</li>
<li>
<p>为了达到高可用，通常MySQL也需要集群，nacos的配置文件也需要指定每一个MySQL实例的信息</p>
<p><img src="/post/springcloudalibaba/assets/1683015794539.png"
	width="1104"
	height="460"
	srcset="/post/springcloudalibaba/assets/1683015794539_hu6fd9df7fa44c51106417c32f71a3e070_32493_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1683015794539_hu6fd9df7fa44c51106417c32f71a3e070_32493_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1683015794539"
	
	
		class="gallery-image" 
		data-flex-grow="240"
		data-flex-basis="576px"
	
></p>
</li>
</ul>
<h3 id="24-第四步集群模式部署启动">2.4 第四步集群模式部署启动</h3>
<p>分别执行nacos目录下的startup</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>startup -m cluster
</span></span></code></pre></div><p>如果启动失败可能的原因是:</p>
<p><strong>nacos配置文件application.properties中默认的数据库连接超时时间设置较短，如下图，因为网络延时等原因，MySQL可能会连接超时导致nacos启动报错，因此只需要将超时时间适当设置长一些即可</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>jdbc:mysql<span style="color:#f92672">:</span><span style="color:#75715e">//127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC
</span></span></span></code></pre></div><p><strong>虚拟机内存不足，由于在vmvare创建虚拟机时，只给每个虚拟分配了1G的内存，从nacos的启动脚本startup.sh中可知，nacos以集群模式启动时，默认分配的java堆内存空间为2G，因此可判断是由于虚拟机内存不足导致nacos启动报错，修改虚拟机内存为2G后可以正常启动。</strong></p>
<p><img src="/post/springcloudalibaba/assets/1683016453763.png"
	width="891"
	height="285"
	srcset="/post/springcloudalibaba/assets/1683016453763_hu7f8f1dd020e4bcf2991198f3279d4b1e_20382_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1683016453763_hu7f8f1dd020e4bcf2991198f3279d4b1e_20382_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1683016453763"
	
	
		class="gallery-image" 
		data-flex-grow="312"
		data-flex-basis="750px"
	
></p>
<h1 id="openfeign--声明式服务调用">OpenFeign  声明式服务调用</h1>
<p>在前面的学习中，我们使用了Ribbon的负载均衡功能，大大简化了远程调用时的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://user-service/user/&#34;</span> <span style="color:#f92672">+</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>User user <span style="color:#f92672">=</span> restTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">getForObject</span><span style="color:#f92672">(</span>url<span style="color:#f92672">,</span> User<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span></code></pre></div><p>如果就学到这里，你可能以后需要编写类似的大量重复代码，格式基本相同，无非参数不一样。有没有更优雅的方式，来对这些代码再次优化呢？
这就是我们接下来要学的OpenFeign的功能了。</p>
<h2 id="1-简介">1 简介</h2>
<p>OpenFeign可以把Rest的请求进行隐藏，伪装成类似Spring MVC的Controller一样。你不用再自己拼接url，拼接参数等等操作，一切都交给Feign去做。</p>
<h2 id="2-快速入门-重点">2 快速入门 (重点)</h2>
<p>步骤：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span><span style="color:#66d9ef">1.</span> 添加openfeign依赖
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">2.</span> 在启动类上添加EnableFeignClients的注解
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">3.</span> 自定义feignClient接口
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">4.</span> 通过feignClient调用接口
</span></span></code></pre></div><ol>
<li>在服务消费者导入依赖</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>在启动类上添加<code>@EnableFeignClients</code>注解</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SpringCloudApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableFeignClients</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumerApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ConsumerApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>OpenFeign中已经封装了RestTemplate并集成了Ribbon负载均衡，因此不需要自己定义<code>RestTemplate</code>了  ，可以注释所有使用<code>RestTemplate</code>的地方</p>
<ol start="3">
<li>编写Feign客户端[接口]</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@FeignClient</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;user-service&#34;</span><span style="color:#f92672">)</span>    <span style="color:#75715e">// 添加FeignClient，指定服务ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">UserClient</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    User <span style="color:#a6e22e">getById</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> Long id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>
<p>首先这是一个接口，Feign会通过动态代理，帮我们生成实现类。这点跟mybatis的mapper很像</p>
</li>
<li>
<p>@FeignClient ，声明这是一个Feign客户端，同时通过 value 属性指定服务名称</p>
</li>
<li>
<p>接口中的定义方法，完全采用SpringMVC的注解，Feign会根据注解帮我们生成URL，并访问获取结果</p>
</li>
</ul>
<ol start="4">
<li>改造controller中的调用逻辑，使用HelloClient访问：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Autowired</span>  <span style="color:#75715e">// 注入UserClient
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> UserClient userClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserById</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span> Long id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    User user <span style="color:#f92672">=</span> userClient<span style="color:#f92672">.</span><span style="color:#a6e22e">getById</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ol start="5">
<li>测试</li>
</ol>
<p>访问http://localhost:9001/consumer/user/2,可以看到成功返回数据</p>
<p><img src="/post/springcloudalibaba/assets/image-20200916101452222.png"
	width="496"
	height="206"
	srcset="/post/springcloudalibaba/assets/image-20200916101452222_hu283415f8c840265f1fb18db1c56be40d_7796_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20200916101452222_hu283415f8c840265f1fb18db1c56be40d_7796_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200916101452222"
	
	
		class="gallery-image" 
		data-flex-grow="240"
		data-flex-basis="577px"
	
></p>
<h2 id="3openfeign的自定义配置">3.OpenFeign的自定义配置</h2>
<h3 id="1超时控制">1.超时控制</h3>
<p>Feign客户端默认等待1s，若服务端处理需要超过1s，导致Feign客户端不想等了，直接返回报错。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${server.port}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String port<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getById</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> Long id<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span>port <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; 所在服务调用了getById...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span><span style="color:#ae81ff">2000</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        User user <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> User<span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;tom&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; from &#34;</span> <span style="color:#f92672">+</span> port<span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>yml文件配置OpenFeign超时控制</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>ribbon:
</span></span><span style="display:flex;"><span>  ReadTimeout: 5000 //建立连接后从服务器读取到可用资源所用的时间
</span></span><span style="display:flex;"><span>  ConnectTimeout: 5000 //建立连接所用的时间
</span></span></code></pre></div><h3 id="2日志配置">2.日志配置</h3>
<p><img src="/post/springcloudalibaba/assets/1683017944020.png"
	width="597"
	height="160"
	srcset="/post/springcloudalibaba/assets/1683017944020_hubc2305847ddfacb03700af0f256d83cb_14845_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1683017944020_hubc2305847ddfacb03700af0f256d83cb_14845_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1683017944020"
	
	
		class="gallery-image" 
		data-flex-grow="373"
		data-flex-basis="895px"
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//此处不用添加@Configuration,不然会被作为全局配置文件共享
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FeignConfig</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    Logger<span style="color:#f92672">.</span><span style="color:#a6e22e">Level</span> <span style="color:#a6e22e">feignLoggerLevel</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Logger<span style="color:#f92672">.</span><span style="color:#a6e22e">Level</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FULL</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>全局配置</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ae81ff">1.</span><span style="color:#960050;background-color:#1e0010">在</span>FeignConfig<span style="color:#960050;background-color:#1e0010">类上添加</span><span style="color:#a6e22e">@Configuration</span><span style="color:#960050;background-color:#1e0010">就成为全局配置</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2.</span><span style="color:#960050;background-color:#1e0010">或者在启动类的</span><span style="color:#a6e22e">@EnableFeignClients</span><span style="color:#960050;background-color:#1e0010">的</span>defaultConfiguration<span style="color:#960050;background-color:#1e0010">指定该配置类</span>
</span></span></code></pre></div><p><strong>局部配置</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//基于注解配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">@FeignClient</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;服务名&#34;</span><span style="color:#f92672">,</span>configuration <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">配置类</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">UserClient</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    User <span style="color:#a6e22e">getById</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> Long id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//基于yaml配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//#开启Feign的局部日志级别
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>feign:
</span></span><span style="display:flex;"><span>  client<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      feign<span style="color:#f92672">-</span>provider<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">-</span>level<span style="color:#f92672">:</span> FULL
</span></span></code></pre></div><p><strong>注意</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">必须调整</span>SpringBoot<span style="color:#960050;background-color:#1e0010">日志的输出级别为</span>Debug<span style="color:#f92672">,</span><span style="color:#960050;background-color:#1e0010">否则无法输出</span>OpenFeign<span style="color:#960050;background-color:#1e0010">的调用信息</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>logging:
</span></span><span style="display:flex;"><span>  level<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    com<span style="color:#f92672">.</span><span style="color:#a6e22e">zhyp</span><span style="color:#f92672">.</span><span style="color:#a6e22e">feign</span><span style="color:#f92672">:</span> debug
</span></span></code></pre></div><h2 id="4openfeign优化实战">4.OpenFeign优化实战</h2>
<h3 id="超时优化">超时优化</h3>
<p>我们介绍过OpenFeign 底层内置了 Ribbon 框架，并且使用了 Ribbon 的请求连接超时时间和请求处理超时时间作为其超时时间，而 Ribbon 默认的请求连接超时时间和请求处理超时时间都是 1s</p>
<ul>
<li>我们可以通过配置来修改：</li>
</ul>
<blockquote>
<p>全局配置  使用ribbon.<!-- raw HTML omitted -->=<!-- raw HTML omitted --></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">ribbon</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ReadTimeout</span>: <span style="color:#ae81ff">2500</span> <span style="color:#75715e"># 数据通信超时时长 默认为1000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ConnectTimeout</span>: <span style="color:#ae81ff">2500</span> <span style="color:#75715e"># 连接超时时长 默认为1000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#重试机制的优化</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">OkToRetryOnAllOperations</span>: <span style="color:#66d9ef">false</span> <span style="color:#75715e"># 对所有的操作请求都进行重试(对于查询和修改我们可以重试,对于增删重试操作是危险的)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">MaxAutoRetries</span>: <span style="color:#ae81ff">2</span> <span style="color:#75715e">#最大重试次数，当Eureka中可以找到服务，但是服务连不上时将会重试访问</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">MaxAutoRetriesNextServer</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 当前服务总是超时时,切换实例的次数</span>
</span></span></code></pre></div><blockquote>
<p>如果要指定某个服务,配置: <!-- raw HTML omitted -->.ribbon.<!-- raw HTML omitted --> = <!-- raw HTML omitted --></p>
</blockquote>
<ul>
<li>
<p>也可以通过直接修改feign的配置来实现</p>
<pre tabindex="0"><code>feign:
 client:
  config:
   default: # 设置的全局超时时间
     connectTimeout: 2000 # 请求连接的超时时间
     readTimeout: 5000 # 请求处理的超时时间
</code></pre></li>
</ul>
<h3 id="请求连接优化">请求连接优化</h3>
<ul>
<li>
<p>OpenFeign 底层通信组件默认使用 JDK 自带的 URLConnection 对象进行 HTTP 请求的，因为没有使用连接池，所以性能不是很好。</p>
</li>
<li>
<p>我们可以将 OpenFeign 的通讯组件，手动替换成像 Apache HttpClient 或 OKHttp 这样的专用通信组件，这些的专用通信组件自带连接池可以更好地对 HTTP 连接对象进行重用与管理，同时也能大大的提升 HTTP 请求的效率</p>
</li>
<li>
<p>引入依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- 添加 openfeign 框架依赖 --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- 添加 httpclient 框架依赖 --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>io.github.openfeign<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>feign-httpclient<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- 添加 okhttp 框架依赖 --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;groupId&gt;</span>io.github.openfeign<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;artifactId&gt;</span>feign-okhttp<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>开启</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>feign:
</span></span><span style="display:flex;"><span>  okhttp:
</span></span><span style="display:flex;"><span>    enabled: true
</span></span><span style="display:flex;"><span># 或者
</span></span><span style="display:flex;"><span>feign:
</span></span><span style="display:flex;"><span>  httpclient:
</span></span><span style="display:flex;"><span>    enabled: true
</span></span></code></pre></div></li>
</ul>
<h3 id="数据压缩优化">数据压缩优化</h3>
<ul>
<li>在 OpenFeign 中，默认并没有开启数据压缩功能。但如果你在服务间单次传递数据超过 1K 字节，强烈推荐开启数据压缩功能。</li>
<li>默认 OpenFeign 使用 Gzip 方式压缩数据，对于大文本通常压缩后尺寸只相当于原始数据的 10%~30%，这会极大提高带宽利用率。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>feign:
</span></span><span style="display:flex;"><span>  compression:
</span></span><span style="display:flex;"><span>    request:
</span></span><span style="display:flex;"><span>      enabled: true  # 开启请求数据的压缩功能
</span></span><span style="display:flex;"><span>      mime-types: text/xml,application/xml, application/json  # 压缩类型
</span></span><span style="display:flex;"><span>      min-request-size: 1024  # 最小压缩值标准，当数据大于 1024 才会进行压缩
</span></span><span style="display:flex;"><span>    response:
</span></span><span style="display:flex;"><span>      enabled: true  # 开启响应数据压缩功能
</span></span></code></pre></div><p><strong>注意:</strong> 优化并不是套路,如果是OpenFeign中就自己默认给优化了,我们需要结合项目</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>如果应用属于计算密集型，CPU 负载长期超过 70%，因数据压缩、解压缩都需要 CPU 运算，开启数据压缩功能反而会给 CPU 增加额外负担，导致系统性能降低，这是不可取的。这种情况 建议不要开启数据的压缩功能
</span></span></code></pre></div><h3 id="负载均衡优化">负载均衡优化</h3>
<ul>
<li>
<p>OpenFeign 使用时默认引用 Ribbon 实现客户端负载均衡，它默认的负载均衡策略是轮询策略。那如何设置 Ribbon 默认的负载均衡策略呢？</p>
</li>
<li>
<p>只需在 application.yml 中调整微服务通信时使用的负载均衡类即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>xxx<span style="color:#f92672">-</span>service<span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">#服务提供者的微服务</span>ID
</span></span><span style="display:flex;"><span>  ribbon<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#设置对应的负载均衡类</span>
</span></span><span style="display:flex;"><span>    NFLoadBalancerRuleClassName<span style="color:#f92672">:</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">netflix</span><span style="color:#f92672">.</span><span style="color:#a6e22e">loadbalancer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RandomRule</span>
</span></span></code></pre></div><p><img src="/post/springcloudalibaba/assets/1683020760909.png"
	width="1331"
	height="789"
	srcset="/post/springcloudalibaba/assets/1683020760909_hu347ec8f44dd8bb18c859251efc821997_590747_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1683020760909_hu347ec8f44dd8bb18c859251efc821997_590747_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1683020760909"
	
	
		class="gallery-image" 
		data-flex-grow="168"
		data-flex-basis="404px"
	
></p>
</li>
</ul>
<h3 id="日志级别优化">日志级别优化</h3>
<p><strong>OpenFeign 提供了日志增强功能，它的日志级别有以下几个：</strong></p>
<ul>
<li><strong>NONE：</strong>  默认的，不显示任何日志。</li>
<li><strong>BASIC：</strong>  仅记录请求方法、URL、响应状态码及执行时间。</li>
<li><strong>HEADERS：</strong>  除了 BASIC 中定义的信息之外，还有请求和响应的头信息。</li>
<li><strong>FULL：</strong>  除了 HEADERS 中定义的信息之外，还有请求和响应的正文及元数据。</li>
</ul>
<p>全局配置+指定服务配置</p>
<p>注意: springboot默认输出info级别的信息,OpenFeign输出的信息是debug级别</p>
<p>于是需要设置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>#properties配置文件
</span></span><span style="display:flex;"><span>logging.level.包名=debug
</span></span><span style="display:flex;"><span>#yaml配置文件
</span></span><span style="display:flex;"><span>logging: 
</span></span><span style="display:flex;"><span>	level: 
</span></span><span style="display:flex;"><span>		包名: debug
</span></span></code></pre></div><h1 id="网关gateway">网关Gateway</h1>
<h2 id="1-gateway网关-概述">1 Gateway网关-概述</h2>
<ul>
<li>
<p>网关旨在为微服务架构提供一种简单而有效的统一的API管理和路由方式。</p>
</li>
<li>
<p>在微服务架构中，不同的微服务可以有不同的网络地址，各个微服务之间通过互相调用完成用户请求，客户端可能通过调用N个微服务的接口完成一个用户请求。</p>
</li>
<li>
<p>存在的问题：</p>
</li>
</ul>
<pre tabindex="0"><code>1.客户端多次请求不同的微服务，增加客户端的复杂性
2.认证复杂，每个服务都要进行认证
3.http请求不同服务次数增加，性能不高
</code></pre><ul>
<li>网关就是系统的入口，封装了应用程序的内部结构，为客户端提供统一服务，一些与业务本身功能无关的公共逻辑可以在这里实现，诸如认证、鉴权、监控、缓存、负载均衡、流量管控、路由转发等</li>
<li>在目前的网关解决方案里，有Nginx+ Lua、Netflix Zuul 、Spring Cloud Gateway等等</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/1587544847831.png"
	width="756"
	height="366"
	srcset="/post/springcloudalibaba/assets/1587544847831_hub66fce5b7e1b0e0c5ccafa40ee395425_39033_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1587544847831_hub66fce5b7e1b0e0c5ccafa40ee395425_39033_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1587544847831"
	
	
		class="gallery-image" 
		data-flex-grow="206"
		data-flex-basis="495px"
	
></p>
<h2 id="2-gateway-快速入门">2 Gateway-快速入门</h2>
<ol>
<li>
<p>搭建网关模块</p>
<p>创建api-gateway模块</p>
</li>
<li>
<p>引入依赖：starter-gateway</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!--网关也需要从注册中心中拉去所有服务信息,因为他要负责路由--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">&lt;!--网关的jar--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>注意: 这里不需要spring-boot-starter-web 因为gateway自带了
</span></span></code></pre></div></li>
<li>
<p>编写启动类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.itheima.gateway<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApiGatewayApp</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ApiGatewayApp<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>编写配置文件</p>
<p>application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8888</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">api-gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 网关配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gateway</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># 路由配置：转发规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">routes</span>: <span style="color:#75715e">#集合。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># id: 唯一标识。默认是一个UUID</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># uri: 转发路径</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># predicates: 条件,用于请求网关路径的匹配规则</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">http://localhost:8001/ </span> <span style="color:#75715e">#lb://微服务id</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">predicates</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">Path=/user/**</span>
</span></span></code></pre></div></li>
<li>
<p>启动测试 , 访问 http://localhost:8888/user/3</p>
<p><img src="/post/springcloudalibaba/assets/image-20201124201738925.png"
	width="544"
	height="210"
	srcset="/post/springcloudalibaba/assets/image-20201124201738925_hu1ec5474c02c6f00761f253b5c1cd0115_7432_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201124201738925_hu1ec5474c02c6f00761f253b5c1cd0115_7432_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201124201738925"
	
	
		class="gallery-image" 
		data-flex-grow="259"
		data-flex-basis="621px"
	
></p>
</li>
</ol>
<h2 id="3路由断言工厂predicatefactory">3.路由断言工厂PredicateFactory</h2>
<p>路由是网关的基本模块。它由ID、目标URI、Predicate集合和Filter集合定义。如果聚合Predicate为真，则匹配路由。</p>
<p>接下来详细介绍断言，如我们刚刚的配置的predicates中的每一个配置官方都称之为路由断言工厂。它的作用就是：当请求gateway的时候，使用断言对请求进行匹配，如果匹配成功就路由转发，如果匹配失败就返回404</p>
<ul>
<li>
<p>Path 路由断言工厂</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>我们快速入门案例中使用的，也支持通配符，如果有多个path中间使用逗号分隔
</span></span><span style="display:flex;"><span>	例如: - Path=/user/**,/order/{oid}
</span></span></code></pre></div></li>
<li>
<p>Date路由断言工厂</p>
<p>有After/Before/Between三种与时间相关的路由断言工厂</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Before<span style="color:#960050;background-color:#1e0010">路由断言工厂接受一个日期时间。此断言匹配在该日期时间之前发生的请求。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如</span><span style="color:#f92672">:-</span> Before<span style="color:#f92672">=</span><span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">17</span>T19<span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">+</span><span style="color:#ae81ff">08</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">[</span>Asia<span style="color:#f92672">/</span>Shanghai<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>After<span style="color:#960050;background-color:#1e0010">路由断言工厂接受一个日期时间，该断言匹配该日期时间之后的请求。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如</span><span style="color:#f92672">:-</span> After<span style="color:#f92672">=</span><span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">17</span>T19<span style="color:#f92672">:</span><span style="color:#ae81ff">38</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00.129</span><span style="color:#f92672">+</span><span style="color:#ae81ff">08</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">[</span>Asia<span style="color:#f92672">/</span>Shanghai<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Between<span style="color:#960050;background-color:#1e0010">路由断言工厂接受两个日期时间。此断言匹配发生两个日期之间的请求。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如</span><span style="color:#f92672">:-</span> Between<span style="color:#f92672">=</span><span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">17</span>T19<span style="color:#f92672">:</span><span style="color:#ae81ff">38</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00.129</span><span style="color:#f92672">+</span><span style="color:#ae81ff">08</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">[</span>Asia<span style="color:#f92672">/</span>Shanghai<span style="color:#f92672">],</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">17</span>T19<span style="color:#f92672">:</span><span style="color:#ae81ff">42</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00.129</span><span style="color:#f92672">+</span><span style="color:#ae81ff">08</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">[</span>Asia<span style="color:#f92672">/</span>Shanghai<span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
<li>
<p>Cookie路由断言工厂</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Cookie<span style="color:#960050;background-color:#1e0010">路由断言工厂接受两个参数，即</span>Cookie<span style="color:#960050;background-color:#1e0010">名称和配置值的正则表达式。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如</span><span style="color:#f92672">:-</span> Cookie<span style="color:#f92672">=</span>java<span style="color:#f92672">,.*</span>version<span style="color:#f92672">.*</span>
</span></span></code></pre></div></li>
<li>
<p>Header路由断言工厂</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Header<span style="color:#960050;background-color:#1e0010">路由断言工厂接受两个参数，</span>Header<span style="color:#960050;background-color:#1e0010">名称和配置值的正则表达式。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如</span><span style="color:#f92672">:-</span> Header<span style="color:#f92672">=</span>address<span style="color:#f92672">,.*</span>ok<span style="color:#f92672">.*</span>
</span></span></code></pre></div></li>
<li>
<p>Method路由断言工厂</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Method<span style="color:#960050;background-color:#1e0010">路由断言工厂接受一个或者多个参数：要匹配的</span>HTTP<span style="color:#960050;background-color:#1e0010">请求方式。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如</span><span style="color:#f92672">:-</span> Method<span style="color:#f92672">=</span>GET<span style="color:#f92672">,</span>POST
</span></span></code></pre></div></li>
<li>
<p>Query路由断言工厂</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Query<span style="color:#960050;background-color:#1e0010">路由断言工厂接受两个参数：必需的</span>param<span style="color:#960050;background-color:#1e0010">和可选的</span>regexp<span style="color:#960050;background-color:#1e0010">。匹配当前请求的参数中是否匹配该路由</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如</span><span style="color:#f92672">:-</span> Query<span style="color:#f92672">=</span>green <span style="color:#960050;background-color:#1e0010">如果请求包含</span>green<span style="color:#960050;background-color:#1e0010">查询参数，则路由匹配。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">例如</span><span style="color:#f92672">:-</span> Query<span style="color:#f92672">=</span>foo<span style="color:#f92672">,</span> ba<span style="color:#f92672">.</span> <span style="color:#960050;background-color:#1e0010">如果请求包含</span>foo<span style="color:#960050;background-color:#1e0010">查询参数</span><span style="color:#f92672">,</span><span style="color:#960050;background-color:#1e0010">且值为</span>ba<span style="color:#960050;background-color:#1e0010">开头的三个字母，则路由匹配</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="4过滤器工厂filter-factory">4.过滤器工厂Filter Factory</h2>
<p>gateway 里面的过滤器和 Servlet 里面的过滤器，功能差不多，路由过滤器可以用于修改进入Http 请求和返回 Http 响应</p>
<h3 id="41-过滤器-概述">4.1 过滤器-概述</h3>
<ul>
<li>
<p>Gateway 支持过滤器功能，对请求或响应进行拦截，完成一些通用操作。</p>
</li>
<li>
<p>Gateway 提供两种过滤器方式：“pre”和“post”</p>
<p>​      <strong>pre 过滤器</strong>，在转发之前执行，可以做参数校验、权限校验、流量监控、日志输出、协议转换等。
​      <strong>post 过滤器</strong>，在后端微服务响应之后并且给前端响应之前执行，可以做响应内容、响应头的修改，日志的输出，流量监控等。</p>
</li>
<li>
<p>Gateway 还提供了两种类型过滤器
​    <strong>GatewayFilter</strong>：局部过滤器，针对单个路由
​    <strong>GlobalFilter</strong> ：全局过滤器，针对所有路由</p>
</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/1587546321584.png"
	width="1749"
	height="873"
	srcset="/post/springcloudalibaba/assets/1587546321584_hue558233e729fd154cdd7329f606202ab_144613_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1587546321584_hue558233e729fd154cdd7329f606202ab_144613_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1587546321584"
	
	
		class="gallery-image" 
		data-flex-grow="200"
		data-flex-basis="480px"
	
></p>
<h3 id="42-局部过滤器gatewayfilter">4.2-局部过滤器GatewayFilter</h3>
<ul>
<li>GatewayFilter 局部过滤器，是针对单个路由的过滤器。</li>
<li>在Spring Cloud Gateway 组件中提供了大量内置的局部过滤器，对请求和响应做过滤操作。</li>
<li>遵循约定大于配置的思想，只需要在配置文件配置局部过滤器名称，并为其指定对应的值，就可以让其生效。</li>
</ul>
<p>修改配置 application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8888</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">api-gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 网关配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gateway</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># 路由配置：转发规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">routes</span>: <span style="color:#75715e">#集合。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># id: 唯一标识。默认是一个UUID</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># uri: 转发路径</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># predicates: 条件,用于请求网关路径的匹配规则</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">lb://user-service</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">predicates</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">Path=/user/**</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">filters</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">AddRequestParameter=name,admin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">localhost:8848</span>
</span></span></code></pre></div><p>在user-service模块的UserController中添加方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/name&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUser</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    User user <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> User<span style="color:#f92672">(</span><span style="color:#ae81ff">1L</span><span style="color:#f92672">,</span> name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; from &#34;</span> <span style="color:#f92672">+</span> port<span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>访问http://localhost:8001/user/name</p>
<p><img src="/post/springcloudalibaba/assets/image-20201124204113931.png"
	width="489"
	height="206"
	srcset="/post/springcloudalibaba/assets/image-20201124204113931_hu835d858b73d7cf9b6aae9b25975490e6_7372_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201124204113931_hu835d858b73d7cf9b6aae9b25975490e6_7372_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201124204113931"
	
	
		class="gallery-image" 
		data-flex-grow="237"
		data-flex-basis="569px"
	
></p>
<p>通过网关访问http://localhost:8888/user/name</p>
<p><img src="/post/springcloudalibaba/assets/image-20201124204135300.png"
	width="493"
	height="199"
	srcset="/post/springcloudalibaba/assets/image-20201124204135300_hu164153421b21820001d55f5f0eb93c5b_7466_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201124204135300_hu164153421b21820001d55f5f0eb93c5b_7466_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201124204135300"
	
	
		class="gallery-image" 
		data-flex-grow="247"
		data-flex-basis="594px"
	
></p>
<ul>
<li>
<p>官方列出的31个局部过滤器</p>
<p><a class="link" href="https://docs.spring.io/spring-cloud-gateway/docs/2.2.5.RELEASE/reference/html/#gatewayfilter-factories"  target="_blank" rel="noopener"
    >https://docs.spring.io/spring-cloud-gateway/docs/2.2.5.RELEASE/reference/html/#gatewayfilter-factories</a></p>
</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/1683029414852.png"
	width="935"
	height="697"
	srcset="/post/springcloudalibaba/assets/1683029414852_hu4cfe002396f969143d4fe35774648cfc_79447_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1683029414852_hu4cfe002396f969143d4fe35774648cfc_79447_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1683029414852"
	
	
		class="gallery-image" 
		data-flex-grow="134"
		data-flex-basis="321px"
	
></p>
<p><img src="/post/springcloudalibaba/assets/1683029448410.png"
	width="928"
	height="747"
	srcset="/post/springcloudalibaba/assets/1683029448410_hufe34b641e9d6ea2b0db934930e27f530_80334_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1683029448410_hufe34b641e9d6ea2b0db934930e27f530_80334_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1683029448410"
	
	
		class="gallery-image" 
		data-flex-grow="124"
		data-flex-basis="298px"
	
></p>
<p><img src="/post/springcloudalibaba/assets/1683029487803.png"
	width="929"
	height="140"
	srcset="/post/springcloudalibaba/assets/1683029487803_huf7452b6094f8abcfe48b348d71f756ee_16378_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1683029487803_huf7452b6094f8abcfe48b348d71f756ee_16378_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1683029487803"
	
	
		class="gallery-image" 
		data-flex-grow="663"
		data-flex-basis="1592px"
	
></p>
<h3 id="43-全局过滤器globalfilter">4.3-全局过滤器GlobalFilter</h3>
<ul>
<li>GlobalFilter 全局过滤器，不需要在配置文件中配置，系统初始化时加载，并作用在每个路由上。</li>
<li>Spring Cloud Gateway 核心的功能也是通过内置的全局过滤器来完成。</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/1587546455139.png"
	width="1449"
	height="882"
	srcset="/post/springcloudalibaba/assets/1587546455139_hu133ff802be3e32e82b4317f4e08a1014_112528_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1587546455139_hu133ff802be3e32e82b4317f4e08a1014_112528_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1587546455139"
	
	
		class="gallery-image" 
		data-flex-grow="164"
		data-flex-basis="394px"
	
></p>
<h3 id="44-全局过滤器案例">4.4 全局过滤器案例</h3>
<p>统计请求次数 限流  token  的校验  ip  黑名单拦截 跨域(filter)  我们可以自定义全局过滤</p>
<p><strong>自定义全局过滤器步骤：</strong></p>
<ol>
<li>定义类实现 GlobalFilter 和 Ordered接口</li>
<li>复写方法</li>
<li>完成逻辑处理</li>
</ol>
<p>==需求: 自定义全局过滤,要求访问的请求中要包含token字段,否则不允许访问==</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.heima.gateway.filter<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.gateway.filter.GlobalFilter<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.core.Ordered<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.http.HttpStatus<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.http.server.reactive.ServerHttpRequest<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.http.server.reactive.ServerHttpResponse<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.stereotype.Service<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.util.StringUtils<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.server.ServerWebExchange<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyFilter</span> <span style="color:#66d9ef">implements</span> GlobalFilter<span style="color:#f92672">,</span> Ordered <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Mono<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">filter</span><span style="color:#f92672">(</span>ServerWebExchange exchange<span style="color:#f92672">,</span> GatewayFilterChain chain<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 需求 如果请求头中带有token,则放行,否则提示未授权状态(401)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;自定义全局过滤器执行了~~~&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 获取请求对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ServerHttpRequest request <span style="color:#f92672">=</span> exchange<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        String token <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getHeaders</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getFirst</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;token&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>token<span style="color:#f92672">)){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 获取响应对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            ServerHttpResponse response <span style="color:#f92672">=</span> exchange<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 返回响应码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            response<span style="color:#f92672">.</span><span style="color:#a6e22e">setStatusCode</span><span style="color:#f92672">(</span>HttpStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">UNAUTHORIZED</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 完成响应
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">setComplete</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> chain<span style="color:#f92672">.</span><span style="color:#a6e22e">filter</span><span style="color:#f92672">(</span>exchange<span style="color:#f92672">);</span><span style="color:#75715e">//放行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 过滤器排序
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return 数值越小 越先执行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getOrder</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>启动测试 , 使用postman来请求 ,访问 http://localhost:8888/user/3</p>
<p><img src="/post/springcloudalibaba/assets/image-20201124204812200.png"
	width="1528"
	height="491"
	srcset="/post/springcloudalibaba/assets/image-20201124204812200_hu472fb80e39a8cf172ae7bcf329417d64_49380_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201124204812200_hu472fb80e39a8cf172ae7bcf329417d64_49380_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201124204812200"
	
	
		class="gallery-image" 
		data-flex-grow="311"
		data-flex-basis="746px"
	
></p>
<p>在header中添加token</p>
<p><img src="/post/springcloudalibaba/assets/image-20201124204857395.png"
	width="1404"
	height="604"
	srcset="/post/springcloudalibaba/assets/image-20201124204857395_hu2f0e4b9e3cfb99e6214a2a0e281b3d36_62883_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20201124204857395_hu2f0e4b9e3cfb99e6214a2a0e281b3d36_62883_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20201124204857395"
	
	
		class="gallery-image" 
		data-flex-grow="232"
		data-flex-basis="557px"
	
></p>
<h2 id="5过滤器-限流实战">5.过滤器-限流实战</h2>
<h3 id="51-限流介绍">5.1 限流介绍</h3>
<ul>
<li>
<p><strong>限流:</strong></p>
<p>是通过对并发访问/请求进行限速或者对一个时间窗口内的请求进行限速来保护系统，一旦达到限制速率则可由拒绝服务，就是定向到错误页或友好的展示页，排队或等待</p>
<p>在高并发的系统中，往往需要在系统中做限流，一方面是为了防止大量的请求使服务器过载，导致服务不可用，另一方面是为了防止网络攻击。</p>
</li>
<li>
<p><strong>常见的限流算法</strong></p>
<p>==计数器算法==</p>
<p>计数器算法采用计数器实现限流有点简单粗暴，一般我们会限制一秒钟的能够通过的请求数，比如限流qps为100，算法的实现思路就是从第一个请求进来开始计时，在接下去的1s内，每来一个请求，就把计数加1，如果累加的数字达到了100，那么后续的请求就会被全部拒绝。等到1s结束后，把计数恢复成0，重新开始计数。具体的实现可以是这样的：对于每次服务调用，可以通过AtomicLong#incrementAndGet()方法来给计数器加1并返回最新值，通过这个最新值和阈值进行比较。这种实现方式，相信大家都知道有一个弊端：如果我在单位时间1s内的前10ms，已经通过了100个请求，那后面的990ms，只能眼巴巴的把请求拒绝，我们把这种现象称为“突刺现象”</p>
<p>==漏桶算法==</p>
<p>漏桶算法为了消除&quot;突刺现象&quot;，可以采用漏桶算法实现限流，漏桶算法这个名字就很形象，算法内部有一个容器，类似生活用到的漏斗，当请求进来时，相当于水倒入漏斗，然后从下端小口慢慢匀速的流出。不管上面流量多大，下面流出的速度始终保持不变。不管服务调用方多么不稳定，通过漏桶算法进行限流，每10毫秒处理一次请求。因为处理的速度是固定的，请求进来的速度是未知的，可能突然进来很多请求，没来得及处理的请求就先放在桶里，既然是个桶，肯定是有容量上限，如果桶满了，那么新进来的请求就丢弃。</p>
<p><img src="/post/springcloudalibaba/assets/616619ee3a43a061b1f048aa2d4385e7.png"
	width="443"
	height="299"
	srcset="/post/springcloudalibaba/assets/616619ee3a43a061b1f048aa2d4385e7_hud9b593fc40685850670af62b4d56a6e2_13766_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/616619ee3a43a061b1f048aa2d4385e7_hud9b593fc40685850670af62b4d56a6e2_13766_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="148"
		data-flex-basis="355px"
	
></p>
<p>在算法实现方面，可以准备一个队列，用来保存请求，另外通过一个线程池(ScheduledExecutorService)来定期从队列中获取请求并执行，可以一次性获取多个并发执行。</p>
<p>这种算法，在使用过后也存在弊端：无法应对短时间的突发流量。</p>
<p>==令牌桶算法==</p>
<p>从某种意义上讲，令牌桶算法是对漏桶算法的一种改进，漏桶算法能够限制请求调用的速率，而令牌桶算法能够在限制调用的平均速率的同时还允许一定程度的突发调用。在令牌桶算法中，存在一个桶，用来存放固定数量的令牌。算法中存在一种机制，以一定的速率往桶中放令牌。每次请求调用需要先获取令牌，只有拿到令牌，才有机会继续执行，否则选择选择等待可用的令牌、或者直接拒绝。放令牌这个动作是持续不断的进行，如果桶中令牌数达到上限，就丢弃令牌，所以就存在这种情况，桶中一直有大量的可用令牌，这时进来的请求就可以直接拿到令牌执行，比如设置qps为100，那么限流器初始化完成一秒后，桶中就已经有100个令牌了，这时服务还没完全启动好，等启动完成对外提供服务时，该限流器可以抵挡瞬时的100个请求。所以，只有桶中没有令牌时，请求才会进行等待，最后相当于以一定的速率执行。</p>
<p><img src="/post/springcloudalibaba/assets/ad621771af0b43d9434d4d3b493fceca.png"
	width="700"
	height="779"
	srcset="/post/springcloudalibaba/assets/ad621771af0b43d9434d4d3b493fceca_hu7e28a67b66d8b0e34592c54e4724a37b_30991_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/ad621771af0b43d9434d4d3b493fceca_hu7e28a67b66d8b0e34592c54e4724a37b_30991_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="89"
		data-flex-basis="215px"
	
></p>
</li>
</ul>
<p>实现思路：可以准备一个队列，用来保存令牌，另外通过一个线程池定期生成令牌放到队列中，每来一个请求，就从队列中获取一个令牌，并继续执行。</p>
<h3 id="52-gateway限流和自定义限流">5.2 Gateway限流和自定义限流</h3>
<p>在Spring Cloud Gateway中，有Filter过滤器，因此可以在“pre”类型的Filter中自行实现上述三种过滤器。限流作为网关最基本的功能，Spring Cloud Gateway官方就提供了<strong>RequestRateLimiterGatewayFilterFactory</strong>这个类，基于<strong>Redis和Lua</strong>脚本实现了<strong>令牌桶</strong>的方式限流。</p>
<ul>
<li>
<p>由于基于Redis实现的,所以需要引入Redis依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>配置Redis和限流规则</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>spring:
</span></span><span style="display:flex;"><span>  redis<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    host<span style="color:#f92672">:</span> <span style="color:#ae81ff">127.0.0.1</span>
</span></span><span style="display:flex;"><span>    port<span style="color:#f92672">:</span> <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>  cloud<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    gateway<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      routes<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">-</span> id<span style="color:#f92672">:</span> after_route
</span></span><span style="display:flex;"><span>          uri<span style="color:#f92672">:</span> http<span style="color:#f92672">:</span><span style="color:#75715e">//localhost:8001/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          predicates<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">-</span> Path<span style="color:#f92672">=/</span>user<span style="color:#f92672">/**</span>
</span></span><span style="display:flex;"><span>          filters<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">-</span> name<span style="color:#f92672">:</span> RequestRateLimiter
</span></span><span style="display:flex;"><span>              args<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">令牌桶每秒填充平均速率</span>
</span></span><span style="display:flex;"><span>                redis<span style="color:#f92672">-</span>rate<span style="color:#f92672">-</span>limiter<span style="color:#f92672">.</span><span style="color:#a6e22e">replenishRate</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">令牌桶的上限</span>
</span></span><span style="display:flex;"><span>                redis<span style="color:#f92672">-</span>rate<span style="color:#f92672">-</span>limiter<span style="color:#f92672">.</span><span style="color:#a6e22e">burstCapacity</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">使用</span>SpEL<span style="color:#960050;background-color:#1e0010">表达式从</span>Spring<span style="color:#960050;background-color:#1e0010">容器中获取</span>Bean<span style="color:#960050;background-color:#1e0010">对象</span>
</span></span><span style="display:flex;"><span>                key<span style="color:#f92672">-</span>resolver<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;#{@pathKeyResolver}&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>自定义限流键</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyKeyResolver</span> <span style="color:#66d9ef">implements</span> KeyResolver <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 返回值Mono&lt;String&gt;中的泛型表示令牌与根据哪个值进行绑定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 比如:  如果是常量值  那么表示全局限流
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 比如:	如果是用户ip 那么表示对每个用户限流
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 比如:  如果是接口路径 那么表示对当前接口限流
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Mono<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">resolve</span><span style="color:#f92672">(</span>ServerWebExchange exchange<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        String path <span style="color:#f92672">=</span> exchange<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getURI</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getPath</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//根据ip限流
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        String hostAddress <span style="color:#f92672">=</span> exchange<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getRemoteAddress</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAddress</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getHostAddress</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>hostAddress<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>其他限流方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 通过IP限流
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> KeyResolver <span style="color:#a6e22e">ipKeyResolver</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> KeyResolver<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> Mono<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">resolve</span><span style="color:#f92672">(</span>ServerWebExchange exchange<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>exchange<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getRemoteAddress</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getHostName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 通过用户限流
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 请求路径中必须要包含用户的唯一表示，userId参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> KeyResolver <span style="color:#a6e22e">userKeyResolver</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> exchange <span style="color:#f92672">-&gt;</span> Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>exchange<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getQueryParams</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getFirst</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;userId&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 通过接口限流
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 请求地址的uri作为限流的key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> KeyResolver <span style="color:#a6e22e">apiKeyResolver</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> exchange <span style="color:#f92672">-&gt;</span> Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>exchange<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getPath</span><span style="color:#f92672">().</span><span style="color:#a6e22e">value</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="6gateway跨域配置">6.GateWay跨域配置</h2>
<h3 id="61-跨域理解">6.1 跨域理解</h3>
<p>我们经常会在一个(A服务器)页面中发起一个请求(ajax,axios),当一个请求url的<strong>协议、域名、端口</strong>三者任意一个与当前页面url不同即为跨域。</p>
<p>简单的说就是发起请求的那个页面的地址 和 请求的接口地址 不在同一个域中。</p>
<p><code>浏览器不能执行其他网站的脚本，从一个域名的网页去请求另一个域名的资源时，域名、端口、协议任一不同，都是跨域。跨域是由浏览器的同源策略造成的，是浏览器施加的安全限制。a网站页面想获取b网站的资源，如果a、b的协议、域名、端口、不同，所进行的访问行动都是跨域的。</code></p>
<p><img src="/post/springcloudalibaba/assets/1683079850244.png"
	width="1257"
	height="307"
	srcset="/post/springcloudalibaba/assets/1683079850244_hu8e58ee1d5ebed86b5868bf03d9cd88cc_51219_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1683079850244_hu8e58ee1d5ebed86b5868bf03d9cd88cc_51219_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1683079850244"
	
	
		class="gallery-image" 
		data-flex-grow="409"
		data-flex-basis="982px"
	
></p>
<p><strong>跨域的本质</strong></p>
<p>跨域本质是浏览器基于<strong>同源策略</strong>的一种安全手段,非同源的请求可以发出,服务器也可以返回结果,但是浏览器基于同源策略不会接收返回的结果</p>
<p><strong>所以跨域并不是请求发不出去，请求能发出去，服务端能收到请求并正常返回结果，只是结果被浏览器拦截了</strong>。</p>
<h3 id="62-gateway的跨域配置">6.2 GateWay的跨域配置</h3>
<p>我们了解了跨域的概念和原因,解决跨域的方式就很简单了,只需要在服务器返回的response中添加几个头信息,通知浏览器允许接收跨域信息即可.</p>
<p>如果每个请求的response都去写,那么就太麻烦了,我们可以考虑一个全局的过滤器,当请求执行后在response响应给浏览器之前添加允许跨域的头信息即可.</p>
<p>Spring Cloud Gateway已经解决跨域问题,只需要使用一个CorsWebFilter过滤器即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CorsConfig</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> CorsWebFilter <span style="color:#a6e22e">corsFilter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        CorsConfiguration config <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CorsConfiguration<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        config<span style="color:#f92672">.</span><span style="color:#a6e22e">addAllowedMethod</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;*&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        config<span style="color:#f92672">.</span><span style="color:#a6e22e">addAllowedOrigin</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;*&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        config<span style="color:#f92672">.</span><span style="color:#a6e22e">addAllowedHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;*&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        UrlBasedCorsConfigurationSource source <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> UrlBasedCorsConfigurationSource<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PathPatternParser<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        source<span style="color:#f92672">.</span><span style="color:#a6e22e">registerCorsConfiguration</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/**&#34;</span><span style="color:#f92672">,</span> config<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> CorsWebFilter<span style="color:#f92672">(</span>source<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>spring:
</span></span><span style="display:flex;"><span>  cloud<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    gateway<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      globalcors<span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">全局的跨域处理</span>
</span></span><span style="display:flex;"><span>        add<span style="color:#f92672">-</span>to<span style="color:#f92672">-</span>simple<span style="color:#f92672">-</span>url<span style="color:#f92672">-</span>handler<span style="color:#f92672">-</span>mapping<span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">解决</span>options<span style="color:#960050;background-color:#1e0010">请求被拦截问题</span>
</span></span><span style="display:flex;"><span>        corsConfigurations<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">[/**]</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            allowedOrigins<span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">允许哪些网站的跨域请求</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;http://localhost:8090&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;http://www.leyou.com&#34;</span>
</span></span><span style="display:flex;"><span>            allowedMethods<span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">允许的跨域</span>ajax<span style="color:#960050;background-color:#1e0010">的请求方式</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;GET&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;POST&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;DELETE&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;PUT&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;OPTIONS&#34;</span>
</span></span><span style="display:flex;"><span>            allowedHeaders<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;*&#34;</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">允许在请求中携带的头信息</span>
</span></span><span style="display:flex;"><span>            allowCredentials<span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">是否允许携带</span>cookie
</span></span><span style="display:flex;"><span>            maxAge<span style="color:#f92672">:</span> <span style="color:#ae81ff">360000</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">这次跨域检测的有效期</span>
</span></span></code></pre></div><h2 id="7-gateway-静态路由">7. Gateway-静态路由</h2>
<p>application.yml  中的uri是写死的，就是静态路由</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8888</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">api-gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 网关配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gateway</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># 路由配置：转发规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">routes</span>: <span style="color:#75715e">#集合。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># id: 唯一标识。默认是一个UUID</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># uri: 转发路径</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># predicates: 条件,用于请求网关路径的匹配规则</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">http://localhost:8001/  </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#要路由的微服务地址 静态地址  静态路由  就算微服务只有一台 也不建议这么写</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">predicates</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">Path=/user/**</span>
</span></span></code></pre></div><h2 id="8-gateway-动态路由">8. Gateway-动态路由</h2>
<p>添加注册中心</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!--&lt;dependency&gt;--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--&lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!--&lt;/dependency&gt;--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>启动类添加<code>@EnableDiscoveryClient</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApiGatewayApp</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ApiGatewayApp<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>application.yml  中添加注册中心地址及修改uri属性：uri: lb://服务名称</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8888</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">api-gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 网关配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gateway</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># 路由配置：转发规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">routes</span>: <span style="color:#75715e">#集合。</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># id: 唯一标识。默认是一个UUID</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># uri: 转发路径</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># predicates: 条件,用于请求网关路径的匹配规则</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">lb://user-service  </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#lb开头表示负载均衡,后面还是微服务的id,必须和nacos或者eureka注册中心的名字一模一样(大小写也)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">predicates</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">Path=/user/**</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">localhost:8848</span>
</span></span></code></pre></div><h1 id="sentinel微服务保护">Sentinel微服务保护</h1>
<h1 id="1初识sentinel">1.初识Sentinel</h1>
<h2 id="11雪崩问题及解决方案">1.1.雪崩问题及解决方案</h2>
<h3 id="111雪崩问题">1.1.1.雪崩问题</h3>
<p>微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。</p>
<p><img src="/post/springcloudalibaba/assets/1533829099748.png"
	width="663"
	height="578"
	srcset="/post/springcloudalibaba/assets/1533829099748_huc2157f4b79db6cf00383441a6f2ec486_115498_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1533829099748_huc2157f4b79db6cf00383441a6f2ec486_115498_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1533829099748"
	
	
		class="gallery-image" 
		data-flex-grow="114"
		data-flex-basis="275px"
	
></p>
<p>如图，如果服务提供者I发生了故障，当前的应用的部分业务因为依赖于服务I，因此也会被阻塞。此时，其它不依赖于服务I的业务似乎不受影响。</p>
<p><img src="/post/springcloudalibaba/assets/1533829198240.png"
	width="658"
	height="567"
	srcset="/post/springcloudalibaba/assets/1533829198240_hu7267be5c00597a9e15129b5e416788be_124768_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/1533829198240_hu7267be5c00597a9e15129b5e416788be_124768_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1533829198240"
	
	
		class="gallery-image" 
		data-flex-grow="116"
		data-flex-basis="278px"
	
></p>
<p>但是，依赖服务I的业务请求被阻塞，用户不会得到响应，则tomcat的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞</p>
<p>服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，那么当前服务也就不可用了。</p>
<p>那么，依赖于当前服务的其它服务随着时间的推移，最终也都会变的不可用，形成级联失败，雪崩就发生了：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715172710340.png"
	width="792"
	height="481"
	srcset="/post/springcloudalibaba/assets/image-20210715172710340_hud448b14951a469ee4b8b04f125487fb6_53170_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715172710340_hud448b14951a469ee4b8b04f125487fb6_53170_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715172710340"
	
	
		class="gallery-image" 
		data-flex-grow="164"
		data-flex-basis="395px"
	
></p>
<h3 id="112超时处理">1.1.2.超时处理</h3>
<p>解决雪崩问题的常见方式有四种：</p>
<p>•超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715172820438.png"
	width="785"
	height="420"
	srcset="/post/springcloudalibaba/assets/image-20210715172820438_hu0de880134388112307db6780fbc6541a_17879_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715172820438_hu0de880134388112307db6780fbc6541a_17879_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715172820438"
	
	
		class="gallery-image" 
		data-flex-grow="186"
		data-flex-basis="448px"
	
></p>
<h3 id="113仓壁模式">1.1.3.仓壁模式</h3>
<p>方案2：仓壁模式</p>
<p>仓壁模式来源于船舱的设计：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715172946352.png"
	width="500"
	height="179"
	srcset="/post/springcloudalibaba/assets/image-20210715172946352_hua971b277d633e9dd27b1679b4816e7c9_38744_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715172946352_hua971b277d633e9dd27b1679b4816e7c9_38744_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715172946352"
	
	
		class="gallery-image" 
		data-flex-grow="279"
		data-flex-basis="670px"
	
></p>
<p>船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。</p>
<p>于此类似，我们可以限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，因此也叫线程隔离。</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715173215243.png"
	width="765"
	height="419"
	srcset="/post/springcloudalibaba/assets/image-20210715173215243_hua8e5f7fd9833218583c4b8f208f9e6fd_25086_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715173215243_hua8e5f7fd9833218583c4b8f208f9e6fd_25086_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715173215243"
	
	
		class="gallery-image" 
		data-flex-grow="182"
		data-flex-basis="438px"
	
></p>
<h3 id="114断路器">1.1.4.断路器</h3>
<p>断路器模式：由<strong>断路器</strong>统计业务执行的异常比例，如果超出阈值则会<strong>熔断</strong>该业务，拦截访问该业务的一切请求。</p>
<p>断路器会统计访问某个服务的请求数量，异常比例：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715173327075.png"
	width="615"
	height="468"
	srcset="/post/springcloudalibaba/assets/image-20210715173327075_hu9f27a5f576432a44a7828638d5669ff5_19287_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715173327075_hu9f27a5f576432a44a7828638d5669ff5_19287_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715173327075"
	
	
		class="gallery-image" 
		data-flex-grow="131"
		data-flex-basis="315px"
	
></p>
<p>当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715173428073.png"
	width="585"
	height="463"
	srcset="/post/springcloudalibaba/assets/image-20210715173428073_hu71eec2b1ffa67c5490e49f031c4d83f3_23263_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715173428073_hu71eec2b1ffa67c5490e49f031c4d83f3_23263_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715173428073"
	
	
		class="gallery-image" 
		data-flex-grow="126"
		data-flex-basis="303px"
	
></p>
<h3 id="115限流">1.1.5.限流</h3>
<p><strong>流量控制</strong>：限制业务访问的QPS，避免服务因流量的突增而故障。</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715173555158.png"
	width="1346"
	height="359"
	srcset="/post/springcloudalibaba/assets/image-20210715173555158_hu865e4579af429416a5368f6feae08438_86844_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715173555158_hu865e4579af429416a5368f6feae08438_86844_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715173555158"
	
	
		class="gallery-image" 
		data-flex-grow="374"
		data-flex-basis="899px"
	
></p>
<h3 id="116总结">1.1.6.总结</h3>
<p>什么是雪崩问题？</p>
<ul>
<li>微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。</li>
</ul>
<p>可以认为：</p>
<p><strong>限流</strong>是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种<strong>预防</strong>措施。</p>
<p><strong>超时处理、线程隔离、降级熔断</strong>是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种<strong>补救</strong>措施。</p>
<h2 id="12服务保护技术对比">1.2.服务保护技术对比</h2>
<p>在SpringCloud当中支持多种服务保护技术：</p>
<ul>
<li><a class="link" href="https://github.com/Netflix/Hystrix"  target="_blank" rel="noopener"
    >Netfix Hystrix</a></li>
<li><a class="link" href="https://github.com/alibaba/Sentinel"  target="_blank" rel="noopener"
    >Sentinel</a></li>
<li><a class="link" href="https://github.com/resilience4j/resilience4j"  target="_blank" rel="noopener"
    >Resilience4J</a></li>
</ul>
<p>早期比较流行的是Hystrix框架，但目前国内实用最广泛的还是阿里巴巴的Sentinel框架，这里我们做下对比：</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th><strong>Sentinel</strong></th>
<th><strong>Hystrix</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>熔断降级策略</td>
<td>基于慢调用比例或异常比例</td>
<td>基于失败比率</td>
</tr>
<tr>
<td>实时指标实现</td>
<td>滑动窗口</td>
<td>滑动窗口（基于 RxJava）</td>
</tr>
<tr>
<td>规则配置</td>
<td>支持多种数据源</td>
<td>支持多种数据源</td>
</tr>
<tr>
<td>扩展性</td>
<td>多个扩展点</td>
<td>插件的形式</td>
</tr>
<tr>
<td>基于注解的支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>限流</td>
<td>基于 QPS，支持基于调用关系的限流</td>
<td>有限的支持</td>
</tr>
<tr>
<td>流量整形</td>
<td>支持慢启动、匀速排队模式</td>
<td>不支持</td>
</tr>
<tr>
<td>系统自适应保护</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>控制台</td>
<td>开箱即用，可配置规则、查看秒级监控、机器发现等</td>
<td>不完善</td>
</tr>
<tr>
<td>隔离策略</td>
<td>信号量隔离</td>
<td>线程池隔离/信号量隔离</td>
</tr>
<tr>
<td>常见框架的适配</td>
<td>Servlet、Spring Cloud、Dubbo、gRPC  等</td>
<td>Servlet、Spring Cloud Netflix</td>
</tr>
</tbody>
</table></div>
<h2 id="13sentinel介绍和安装">1.3.Sentinel介绍和安装</h2>
<h3 id="131初识sentinel">1.3.1.初识Sentinel</h3>
<p>Sentinel是阿里巴巴开源的一款微服务流量控制组件。官网地址：https://sentinelguard.io/zh-cn/index.html</p>
<p>Sentinel 具有以下特征:</p>
<p>•<strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</p>
<p>•<strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</p>
<p>•<strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</p>
<p>•<strong>完善的</strong> <strong>SPI</strong> <strong>扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</p>
<h3 id="132安装sentinel">1.3.2.安装Sentinel</h3>
<p>1）下载</p>
<p>sentinel官方提供了UI控制台，方便我们对系统做限流设置。大家可以在<a class="link" href="https://github.com/alibaba/Sentinel/releases"  target="_blank" rel="noopener"
    >GitHub</a>下载。</p>
<p>课前资料也提供了下载好的jar包：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715174252531.png"
	width="889"
	height="51"
	srcset="/post/springcloudalibaba/assets/image-20210715174252531_hu76b8fedaee493a2ed8e1b73d3e207e36_17274_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715174252531_hu76b8fedaee493a2ed8e1b73d3e207e36_17274_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715174252531"
	
	
		class="gallery-image" 
		data-flex-grow="1743"
		data-flex-basis="4183px"
	
></p>
<p>2）运行</p>
<p>将jar包放到任意非中文目录，执行命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>java -jar sentinel-dashboard-1.8.1.jar
</span></span></code></pre></div><p>如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th><strong>配置项</strong></th>
<th><strong>默认值</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>server.port</td>
<td>8080</td>
<td>服务端口</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.username</td>
<td>sentinel</td>
<td>默认用户名</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.password</td>
<td>sentinel</td>
<td>默认密码</td>
</tr>
</tbody>
</table></div>
<p>例如，修改端口：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>java -Dserver.port<span style="color:#f92672">=</span><span style="color:#ae81ff">8090</span> -jar sentinel-dashboard-1.8.1.jar
</span></span></code></pre></div><p>3）访问</p>
<p>访问http://localhost:8080页面，就可以看到sentinel的控制台了：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715190827846.png"
	width="518"
	height="259"
	srcset="/post/springcloudalibaba/assets/image-20210715190827846_hu56a8059f54764c6000c20538243961a9_23173_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715190827846_hu56a8059f54764c6000c20538243961a9_23173_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715190827846"
	
	
		class="gallery-image" 
		data-flex-grow="200"
		data-flex-basis="480px"
	
></p>
<p>需要输入账号和密码，默认都是：sentinel</p>
<p>登录后，发现一片空白，什么都没有：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715191134448.png"
	width="1016"
	height="375"
	srcset="/post/springcloudalibaba/assets/image-20210715191134448_hu3d855f6322cf26efa1ded3574a31d027_69769_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715191134448_hu3d855f6322cf26efa1ded3574a31d027_69769_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715191134448"
	
	
		class="gallery-image" 
		data-flex-grow="270"
		data-flex-basis="650px"
	
></p>
<p>这是因为我们还没有与微服务整合。</p>
<h2 id="14微服务整合sentinel">1.4.微服务整合Sentinel</h2>
<p>我们在sentinel-order-service中整合sentinel，并连接sentinel的控制台，步骤如下：</p>
<p>1）引入sentinel依赖</p>
<p><strong>如果出现版本问题,不要直接去修改sentinel的版本,而是父pom中spring-cloud-alibaba-dependencies的版本</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!--sentinel--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-sentinel<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2）配置控制台</p>
<p>修改application.yaml文件，添加下面内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8088</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sentinel</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">transport</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">dashboard</span>: <span style="color:#ae81ff">localhost:8080</span>
</span></span></code></pre></div><p>3）访问order-service的任意端点</p>
<p>打开浏览器，访问http://localhost:8088/order/101，这样才能触发sentinel的监控。</p>
<p>然后再访问sentinel的控制台，查看效果：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715191241799.png"
	width="1854"
	height="871"
	srcset="/post/springcloudalibaba/assets/image-20210715191241799_hu4ff05437a8530416067703490ceb437f_245108_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715191241799_hu4ff05437a8530416067703490ceb437f_245108_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715191241799"
	
	
		class="gallery-image" 
		data-flex-grow="212"
		data-flex-basis="510px"
	
></p>
<h1 id="2流量控制">2.流量控制</h1>
<p>雪崩问题虽然有四种方案，但是限流是<strong>避免</strong>服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。</p>
<h2 id="21簇点链路">2.1.簇点链路</h2>
<p>当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做<strong>簇点链路</strong>。簇点链路中被监控的每一个接口就是一个<strong>资源</strong>。</p>
<p><strong>默认情况</strong>下sentinel会监控SpringMVC的每一个端点（Endpoint，也就是controller中的方法），因此SpringMVC的每一个端点（Endpoint）就是调用链路中的一个资源。</p>
<p>例如，我们刚才访问的order-service中的OrderController中的端点：/order/{orderId}</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715191757319.png"
	width="1365"
	height="455"
	srcset="/post/springcloudalibaba/assets/image-20210715191757319_hu3723d82b1f4e7db3e7c67d7a709d5756_135823_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715191757319_hu3723d82b1f4e7db3e7c67d7a709d5756_135823_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715191757319"
	
	
		class="gallery-image" 
		data-flex-grow="300"
		data-flex-basis="720px"
	
></p>
<p>流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：</p>
<ul>
<li>流控：流量控制</li>
<li>降级：降级熔断</li>
<li>热点：热点参数限流，是限流的一种</li>
<li>授权：请求的权限控制</li>
</ul>
<h2 id="21快速入门">2.1.快速入门</h2>
<h3 id="211示例">2.1.1.示例</h3>
<p>点击资源/order/{orderId}后面的流控按钮，就可以弹出表单。</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715191757319.png"
	width="1365"
	height="455"
	srcset="/post/springcloudalibaba/assets/image-20210715191757319_hu3723d82b1f4e7db3e7c67d7a709d5756_135823_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715191757319_hu3723d82b1f4e7db3e7c67d7a709d5756_135823_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715191757319"
	
	
		class="gallery-image" 
		data-flex-grow="300"
		data-flex-basis="720px"
	
></p>
<p>表单中可以填写限流规则，如下：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715192010657.png"
	width="744"
	height="430"
	srcset="/post/springcloudalibaba/assets/image-20210715192010657_hu23b5f5ca15fad2e373ddfffa6b9de3c8_44629_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715192010657_hu23b5f5ca15fad2e373ddfffa6b9de3c8_44629_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715192010657"
	
	
		class="gallery-image" 
		data-flex-grow="173"
		data-flex-basis="415px"
	
></p>
<p>其含义是限制 /order/{orderId}这个资源的单机QPS为1，即每秒只允许1次请求，超出的请求会被拦截并报错。</p>
<h3 id="212练习">2.1.2.练习：</h3>
<p>需求：给 /order/{orderId}这个资源设置流控规则，QPS不能超过 5，然后测试。</p>
<p>1）首先在sentinel控制台添加限流规则</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715192455429.png"
	width="696"
	height="176"
	srcset="/post/springcloudalibaba/assets/image-20210715192455429_hu937baf8848ac60e83865208a73ac1757_23813_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715192455429_hu937baf8848ac60e83865208a73ac1757_23813_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715192455429"
	
	
		class="gallery-image" 
		data-flex-grow="395"
		data-flex-basis="949px"
	
></p>
<p>2）利用jmeter测试</p>
<p>如果没有用过jmeter，可以参考课前资料提供的文档《Jmeter快速入门.md》</p>
<p>课前资料提供了编写好的Jmeter测试样例：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715200431615.png"
	width="389"
	height="287"
	srcset="/post/springcloudalibaba/assets/image-20210715200431615_huca462d6c95d69e156fa7d30e26b64367_17219_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715200431615_huca462d6c95d69e156fa7d30e26b64367_17219_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715200431615"
	
	
		class="gallery-image" 
		data-flex-grow="135"
		data-flex-basis="325px"
	
></p>
<p>打开jmeter，导入课前资料提供的测试样例：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715200537171.png"
	width="305"
	height="186"
	srcset="/post/springcloudalibaba/assets/image-20210715200537171_hu8915a0768480b3748f9e5e08d7ed9ae7_9922_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715200537171_hu8915a0768480b3748f9e5e08d7ed9ae7_9922_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715200537171"
	
	
		class="gallery-image" 
		data-flex-grow="163"
		data-flex-basis="393px"
	
></p>
<p>选择：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715200635414.png"
	width="991"
	height="439"
	srcset="/post/springcloudalibaba/assets/image-20210715200635414_hu3b08b0aee91f2df05784f20ad7008ab3_79323_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715200635414_hu3b08b0aee91f2df05784f20ad7008ab3_79323_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715200635414"
	
	
		class="gallery-image" 
		data-flex-grow="225"
		data-flex-basis="541px"
	
></p>
<p>20个用户，2秒内运行完，QPS是10，超过了5.</p>
<p>选中<code>流控入门，QPS&lt;5</code>右键运行：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715200804594.png"
	width="536"
	height="293"
	srcset="/post/springcloudalibaba/assets/image-20210715200804594_hu16b9f4d2a7665d6768d2c42beb97635c_42345_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715200804594_hu16b9f4d2a7665d6768d2c42beb97635c_42345_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715200804594"
	
	
		class="gallery-image" 
		data-flex-grow="182"
		data-flex-basis="439px"
	
></p>
<blockquote>
<p>注意，不要点击菜单中的执行按钮来运行。</p>
</blockquote>
<p>结果：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715200853671.png"
	width="221"
	height="375"
	srcset="/post/springcloudalibaba/assets/image-20210715200853671_hu83f7b255f3445cc012f764ae7d945712_51149_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715200853671_hu83f7b255f3445cc012f764ae7d945712_51149_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715200853671"
	
	
		class="gallery-image" 
		data-flex-grow="58"
		data-flex-basis="141px"
	
></p>
<p>可以看到，成功的请求每次只有5个</p>
<h2 id="22流控模式">2.2.流控模式</h2>
<p>在添加限流规则时，点击高级选项，可以选择三种<strong>流控模式</strong>：</p>
<ul>
<li>直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式</li>
<li>关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</li>
<li>链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流</li>
</ul>
<p><img src="/post/springcloudalibaba/assets/image-20210715201827886.png"
	width="696"
	height="267"
	srcset="/post/springcloudalibaba/assets/image-20210715201827886_hu4395297a45cabd4e01a0c6422ee893a8_36714_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715201827886_hu4395297a45cabd4e01a0c6422ee893a8_36714_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715201827886"
	
	
		class="gallery-image" 
		data-flex-grow="260"
		data-flex-basis="625px"
	
></p>
<p>快速入门测试的就是直接模式。</p>
<h3 id="221关联模式">2.2.1.关联模式</h3>
<p><strong>关联模式</strong>：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</p>
<p><strong>配置规则</strong>：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715202540786.png"
	width="673"
	height="350"
	srcset="/post/springcloudalibaba/assets/image-20210715202540786_hu79b9ada449eff1049e4796cf734f1389_46751_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715202540786_hu79b9ada449eff1049e4796cf734f1389_46751_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715202540786"
	
	
		class="gallery-image" 
		data-flex-grow="192"
		data-flex-basis="461px"
	
></p>
<p><strong>语法说明</strong>：当/write资源访问量触发阈值时，就会对/read资源限流，避免影响/write资源。</p>
<p><strong>使用场景</strong>：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。</p>
<p><strong>需求说明</strong>：</p>
<ul>
<li>在OrderController新建两个端点：/order/query和/order/update，无需实现业务</li>
<li>配置流控规则，当/order/ update资源被访问的QPS超过5时，对/order/query请求限流</li>
</ul>
<p>1）定义/order/query端点，模拟订单查询</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/query&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">queryOrder</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;查询订单成功&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>2）定义/order/update端点，模拟订单更新</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/update&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">updateOrder</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;更新订单成功&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>重启服务，查看sentinel控制台的簇点链路：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716101805951.png"
	width="747"
	height="514"
	srcset="/post/springcloudalibaba/assets/image-20210716101805951_huf8db6242aca8f0e638bef89217c75d38_45288_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716101805951_huf8db6242aca8f0e638bef89217c75d38_45288_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716101805951"
	
	
		class="gallery-image" 
		data-flex-grow="145"
		data-flex-basis="348px"
	
></p>
<p>3）配置流控规则</p>
<p>对哪个端点限流，就点击哪个端点后面的按钮。我们是对订单查询/order/query限流，因此点击它后面的按钮：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716101934499.png"
	width="1321"
	height="117"
	srcset="/post/springcloudalibaba/assets/image-20210716101934499_hud02a325f9b24141663196545d870bd87_20232_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716101934499_hud02a325f9b24141663196545d870bd87_20232_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716101934499"
	
	
		class="gallery-image" 
		data-flex-grow="1129"
		data-flex-basis="2709px"
	
></p>
<p>在表单中填写流控规则：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716102103814.png"
	width="921"
	height="730"
	srcset="/post/springcloudalibaba/assets/image-20210716102103814_huccea18308c4c7d8566d514aa6d809a8f_114286_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716102103814_huccea18308c4c7d8566d514aa6d809a8f_114286_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716102103814"
	
	
		class="gallery-image" 
		data-flex-grow="126"
		data-flex-basis="302px"
	
></p>
<p>4）在Jmeter测试</p>
<p>选择《流控模式-关联》：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716102416266.png"
	width="905"
	height="314"
	srcset="/post/springcloudalibaba/assets/image-20210716102416266_hu9f9172559b9e03b5101f747835541f6c_27947_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716102416266_hu9f9172559b9e03b5101f747835541f6c_27947_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716102416266"
	
	
		class="gallery-image" 
		data-flex-grow="288"
		data-flex-basis="691px"
	
></p>
<p>可以看到1000个用户，100秒，因此QPS为10，超过了我们设定的阈值：5</p>
<p>查看http请求：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716102532554.png"
	width="1011"
	height="237"
	srcset="/post/springcloudalibaba/assets/image-20210716102532554_hue1342e730bc7de7f216161d8b5060040_24217_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716102532554_hue1342e730bc7de7f216161d8b5060040_24217_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716102532554"
	
	
		class="gallery-image" 
		data-flex-grow="426"
		data-flex-basis="1023px"
	
></p>
<p>请求的目标是/order/update，这样这个断点就会触发阈值。</p>
<p>但限流的目标是/order/query，我们在浏览器访问，可以发现：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716102636030.png"
	width="654"
	height="147"
	srcset="/post/springcloudalibaba/assets/image-20210716102636030_hu53824900baaec1db24aadb21f43d1c16_37578_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716102636030_hu53824900baaec1db24aadb21f43d1c16_37578_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716102636030"
	
	
		class="gallery-image" 
		data-flex-grow="444"
		data-flex-basis="1067px"
	
></p>
<p>确实被限流了。</p>
<p>5）总结</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716103143002.png"
	width="1183"
	height="231"
	srcset="/post/springcloudalibaba/assets/image-20210716103143002_hu3a03bedcec31602d2b899b91368a5554_23275_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716103143002_hu3a03bedcec31602d2b899b91368a5554_23275_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716103143002"
	
	
		class="gallery-image" 
		data-flex-grow="512"
		data-flex-basis="1229px"
	
></p>
<h3 id="222链路模式">2.2.2.链路模式</h3>
<p><strong>链路模式</strong>：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。</p>
<p><strong>配置示例</strong>：</p>
<p>例如有两条请求链路：</p>
<ul>
<li>/test1 &ndash;&gt; /common</li>
<li>/test2 &ndash;&gt; /common</li>
</ul>
<p>如果只希望统计从/test2进入到/common的请求，则可以这样配置：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716103536346.png"
	width="582"
	height="276"
	srcset="/post/springcloudalibaba/assets/image-20210716103536346_huc27e006aca9a9d76eff77b2f83b28e18_33407_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716103536346_huc27e006aca9a9d76eff77b2f83b28e18_33407_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716103536346"
	
	
		class="gallery-image" 
		data-flex-grow="210"
		data-flex-basis="506px"
	
></p>
<p><strong>实战案例</strong></p>
<p>需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。</p>
<p>步骤：</p>
<ol>
<li>在OrderService中添加一个queryGoods方法，不用实现业务</li>
<li>在OrderController中，改造/order/query端点，调用OrderService中的queryGoods方法</li>
<li>在OrderController中添加一个/order/save的端点，调用OrderService的queryGoods方法</li>
<li>给queryGoods设置限流规则，从/order/query进入queryGoods的方法限制QPS必须小于2</li>
</ol>
<p>实现：</p>
<h4 id="1添加查询商品方法">1）添加查询商品方法</h4>
<p>在order-service服务中，给OrderService类添加一个queryGoods方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">queryGoods</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;查询商品&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="2查询订单时查询商品">2）查询订单时，查询商品</h4>
<p>在order-service的OrderController中，修改/order/query端点的业务逻辑：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/query&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">queryOrder</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 查询商品
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    orderService<span style="color:#f92672">.</span><span style="color:#a6e22e">queryGoods</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 查询订单
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;查询订单&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;查询订单成功&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="3新增订单查询商品">3）新增订单，查询商品</h4>
<p>在order-service的OrderController中，修改/order/save端点，模拟新增订单：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/save&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">saveOrder</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 查询商品
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    orderService<span style="color:#f92672">.</span><span style="color:#a6e22e">queryGoods</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 查询订单
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;新增订单&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;新增订单成功&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="4给查询商品添加资源标记">4）给查询商品添加资源标记</h4>
<p>默认情况下，OrderService中的方法是不被Sentinel监控的，需要我们自己通过注解来标记要监控的方法。</p>
<p>给OrderService的queryGoods方法添加@SentinelResource注解：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SentinelResource</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;goods&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">queryGoods</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;查询商品&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。</p>
<p>我们需要关闭这种对SpringMVC的资源聚合，修改order-service服务的application.yml文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sentinel</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">web-context-unify</span>: <span style="color:#66d9ef">false</span> <span style="color:#75715e"># 关闭context整合</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">这个配置必须是sentinel-2.1.3版本或者以上</span>
</span></span></code></pre></div><p>重启服务，访问/order/query和/order/save，可以查看到sentinel的簇点链路规则中，出现了新的资源：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716105227163.png"
	width="835"
	height="585"
	srcset="/post/springcloudalibaba/assets/image-20210716105227163_hu1a9d1bc06427e2477aa84f6f5499b758_49307_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716105227163_hu1a9d1bc06427e2477aa84f6f5499b758_49307_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716105227163"
	
	
		class="gallery-image" 
		data-flex-grow="142"
		data-flex-basis="342px"
	
></p>
<h4 id="5添加流控规则">5）添加流控规则</h4>
<p>点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716105408723.png"
	width="826"
	height="663"
	srcset="/post/springcloudalibaba/assets/image-20210716105408723_hu35b34bf5e01685ffe626021256601bb7_98586_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716105408723_hu35b34bf5e01685ffe626021256601bb7_98586_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716105408723"
	
	
		class="gallery-image" 
		data-flex-grow="124"
		data-flex-basis="299px"
	
></p>
<p>只统计从/order/query进入/goods的资源，QPS阈值为2，超出则被限流。</p>
<h4 id="6jmeter测试">6）Jmeter测试</h4>
<p>选择《流控模式-链路》：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716105612312.png"
	width="904"
	height="253"
	srcset="/post/springcloudalibaba/assets/image-20210716105612312_hu6b58a1eafe7fd26d771ef5a0be1c00f3_23952_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716105612312_hu6b58a1eafe7fd26d771ef5a0be1c00f3_23952_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716105612312"
	
	
		class="gallery-image" 
		data-flex-grow="357"
		data-flex-basis="857px"
	
></p>
<p>可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2</p>
<p>一个http请求是访问/order/save：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716105812789.png"
	width="921"
	height="194"
	srcset="/post/springcloudalibaba/assets/image-20210716105812789_hu8e3c92dbe05b0b6f2d8b2532b9f695e9_20956_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716105812789_hu8e3c92dbe05b0b6f2d8b2532b9f695e9_20956_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716105812789"
	
	
		class="gallery-image" 
		data-flex-grow="474"
		data-flex-basis="1139px"
	
></p>
<p>运行的结果：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716110027064.png"
	width="642"
	height="338"
	srcset="/post/springcloudalibaba/assets/image-20210716110027064_huc9942db8a56ad594e5cd4810b23ec3fd_78452_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716110027064_huc9942db8a56ad594e5cd4810b23ec3fd_78452_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716110027064"
	
	
		class="gallery-image" 
		data-flex-grow="189"
		data-flex-basis="455px"
	
></p>
<p>完全不受影响。</p>
<p>另一个是访问/order/query：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716105855951.png"
	width="975"
	height="195"
	srcset="/post/springcloudalibaba/assets/image-20210716105855951_hu1d6fd457fce4c8ae25072c002afa50d0_21154_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716105855951_hu1d6fd457fce4c8ae25072c002afa50d0_21154_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716105855951"
	
	
		class="gallery-image" 
		data-flex-grow="500"
		data-flex-basis="1200px"
	
></p>
<p>运行结果：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716105956401.png"
	width="711"
	height="431"
	srcset="/post/springcloudalibaba/assets/image-20210716105956401_hu4210fc9104c9e94d2237d02942c41e12_92739_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716105956401_hu4210fc9104c9e94d2237d02942c41e12_92739_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716105956401"
	
	
		class="gallery-image" 
		data-flex-grow="164"
		data-flex-basis="395px"
	
></p>
<p>每次只有2个通过。</p>
<h3 id="223总结">2.2.3.总结</h3>
<p>流控模式有哪些？</p>
<p>•直接：对当前资源限流</p>
<p>•关联：高优先级资源触发阈值，对低优先级资源限流。</p>
<p>•链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流</p>
<h2 id="23流控效果">2.3.流控效果</h2>
<p>在流控的高级选项中，还有一个流控效果选项：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716110225104.png"
	width="660"
	height="175"
	srcset="/post/springcloudalibaba/assets/image-20210716110225104_hud678374fce5efeb2b1fa32c7d02f16ac_27319_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716110225104_hud678374fce5efeb2b1fa32c7d02f16ac_27319_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716110225104"
	
	
		class="gallery-image" 
		data-flex-grow="377"
		data-flex-basis="905px"
	
></p>
<p>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：</p>
<ul>
<li>快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。</li>
<li>warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。</li>
<li>排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长</li>
</ul>
<h3 id="231warm-up">2.3.1.warm up</h3>
<p>阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（<strong>冷启动</strong>），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。</p>
<p>warm up也叫<strong>预热模式</strong>，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。而coldFactor的默认值是3.</p>
<p>例如，我设置QPS的maxThreshold为9，预热时间为3秒，那么初始阈值就是 10 / 3 ，也就是3，然后在3秒后逐渐增长到9.</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716110629796.png"
	width="1046"
	height="462"
	srcset="/post/springcloudalibaba/assets/image-20210716110629796_hue387d41d6178c59c24be7fb6203cf54e_40465_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716110629796_hue387d41d6178c59c24be7fb6203cf54e_40465_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716110629796"
	
	
		class="gallery-image" 
		data-flex-grow="226"
		data-flex-basis="543px"
	
></p>
<p><strong>案例</strong></p>
<p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒</p>
<h4 id="1配置流控规则">1）配置流控规则：</h4>
<p><img src="/post/springcloudalibaba/assets/image-20210716111012387.png"
	width="833"
	height="644"
	srcset="/post/springcloudalibaba/assets/image-20210716111012387_hud00d22ca83cc95c4abb37727ca9eecab_93666_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716111012387_hud00d22ca83cc95c4abb37727ca9eecab_93666_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716111012387"
	
	
		class="gallery-image" 
		data-flex-grow="129"
		data-flex-basis="310px"
	
></p>
<h4 id="2jmeter测试">2）Jmeter测试</h4>
<p>选择《流控效果，warm up》：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716111136699.png"
	width="986"
	height="339"
	srcset="/post/springcloudalibaba/assets/image-20210716111136699_huee89a0d7529365957e2fd459c24f1431_30200_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716111136699_huee89a0d7529365957e2fd459c24f1431_30200_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716111136699"
	
	
		class="gallery-image" 
		data-flex-grow="290"
		data-flex-basis="698px"
	
></p>
<p>QPS为10.</p>
<p>刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716111303701.png"
	width="661"
	height="439"
	srcset="/post/springcloudalibaba/assets/image-20210716111303701_huf9a22e55b38c224162d4defb5540f8a7_87539_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716111303701_huf9a22e55b38c224162d4defb5540f8a7_87539_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716111303701"
	
	
		class="gallery-image" 
		data-flex-grow="150"
		data-flex-basis="361px"
	
></p>
<p>随着时间推移，成功比例越来越高：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716111404717.png"
	width="603"
	height="557"
	srcset="/post/springcloudalibaba/assets/image-20210716111404717_hu7cb95dff88cafe7cdde1dd1151d69923_103710_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716111404717_hu7cb95dff88cafe7cdde1dd1151d69923_103710_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716111404717"
	
	
		class="gallery-image" 
		data-flex-grow="108"
		data-flex-basis="259px"
	
></p>
<p>到Sentinel控制台查看实时监控：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716111526480.png"
	width="747"
	height="439"
	srcset="/post/springcloudalibaba/assets/image-20210716111526480_hu613b9a51b64295d91a671635d04f8275_45310_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716111526480_hu613b9a51b64295d91a671635d04f8275_45310_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716111526480"
	
	
		class="gallery-image" 
		data-flex-grow="170"
		data-flex-basis="408px"
	
></p>
<p>一段时间后：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716111658541.png"
	width="745"
	height="423"
	srcset="/post/springcloudalibaba/assets/image-20210716111658541_hu8943b9eb9e075e35b82f084eff2a32c1_43531_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716111658541_hu8943b9eb9e075e35b82f084eff2a32c1_43531_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716111658541"
	
	
		class="gallery-image" 
		data-flex-grow="176"
		data-flex-basis="422px"
	
></p>
<h3 id="232排队等待">2.3.2.排队等待</h3>
<p>当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。</p>
<p>而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。</p>
<p>工作原理</p>
<p>例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着<strong>预期等待时长</strong>超过2000ms的请求会被拒绝并抛出异常。</p>
<p>那什么叫做预期等待时长呢？</p>
<p>比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：</p>
<ul>
<li>第6个请求的<strong>预期等待时长</strong> =  200 * （6 - 1） = 1000ms  1200m  1400ms</li>
<li>第12个请求的预期等待时长 = 200 * （12-1） = 2200ms</li>
</ul>
<p>现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716113147176.png"
	width="766"
	height="360"
	srcset="/post/springcloudalibaba/assets/image-20210716113147176_hu9b6ada2f6f1b1089ce04f2b1925a2c55_5254_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716113147176_hu9b6ada2f6f1b1089ce04f2b1925a2c55_5254_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716113147176"
	
	
		class="gallery-image" 
		data-flex-grow="212"
		data-flex-basis="510px"
	
></p>
<p>如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716113426524.png"
	width="715"
	height="350"
	srcset="/post/springcloudalibaba/assets/image-20210716113426524_hu1b776448fe57cc6e36c12a780ddec7c1_3814_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716113426524_hu1b776448fe57cc6e36c12a780ddec7c1_3814_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716113426524"
	
	
		class="gallery-image" 
		data-flex-grow="204"
		data-flex-basis="490px"
	
></p>
<p>平滑的QPS曲线，对于服务器来说是更友好的。</p>
<p><strong>案例</strong></p>
<p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s</p>
<h4 id="1添加流控规则">1）添加流控规则</h4>
<p><img src="/post/springcloudalibaba/assets/image-20210716114048918.png"
	width="829"
	height="638"
	srcset="/post/springcloudalibaba/assets/image-20210716114048918_huc58fcff686991b5438700498c154fc40_90102_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716114048918_huc58fcff686991b5438700498c154fc40_90102_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716114048918"
	
	
		class="gallery-image" 
		data-flex-grow="129"
		data-flex-basis="311px"
	
></p>
<h4 id="2jmeter测试-1">2）Jmeter测试</h4>
<p>选择《流控效果，队列》：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716114243558.png"
	width="981"
	height="308"
	srcset="/post/springcloudalibaba/assets/image-20210716114243558_huf2b985f51fce1e3b55c1bb74264f2efd_28083_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716114243558_huf2b985f51fce1e3b55c1bb74264f2efd_28083_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716114243558"
	
	
		class="gallery-image" 
		data-flex-grow="318"
		data-flex-basis="764px"
	
></p>
<p>QPS为15，已经超过了我们设定的10。</p>
<p>如果是之前的 快速失败、warmup模式，超出的请求应该会直接报错。</p>
<p>但是我们看看队列模式的运行结果：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716114429361.png"
	width="671"
	height="489"
	srcset="/post/springcloudalibaba/assets/image-20210716114429361_huc7a01143c7125c17e9212795c9e9dd71_99286_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716114429361_huc7a01143c7125c17e9212795c9e9dd71_99286_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716114429361"
	
	
		class="gallery-image" 
		data-flex-grow="137"
		data-flex-basis="329px"
	
></p>
<p>全部都通过了。</p>
<p>再去sentinel查看实时监控的QPS曲线：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716114522935.png"
	width="1490"
	height="427"
	srcset="/post/springcloudalibaba/assets/image-20210716114522935_hu83e0bff4d7025aeef8b82b7c14565e8a_77852_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716114522935_hu83e0bff4d7025aeef8b82b7c14565e8a_77852_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716114522935"
	
	
		class="gallery-image" 
		data-flex-grow="348"
		data-flex-basis="837px"
	
></p>
<p>QPS非常平滑，一致保持在10，但是超出的请求没有被拒绝，而是放入队列。因此<strong>响应时间</strong>（等待时间）会越来越长。</p>
<p>当队列满了以后，才会有部分请求失败：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716114651137.png"
	width="1516"
	height="453"
	srcset="/post/springcloudalibaba/assets/image-20210716114651137_hu73580cdc40468736194ed4e677fb6b2d_79149_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716114651137_hu73580cdc40468736194ed4e677fb6b2d_79149_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716114651137"
	
	
		class="gallery-image" 
		data-flex-grow="334"
		data-flex-basis="803px"
	
></p>
<h3 id="233总结">2.3.3.总结</h3>
<p>流控效果有哪些？</p>
<ul>
<li>快速失败：QPS超过阈值时，拒绝新的请求</li>
<li>warm up： QPS超过阈值时，拒绝新的请求；QPS阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。</li>
<li>排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝</li>
</ul>
<h2 id="24热点参数限流">2.4.热点参数限流</h2>
<p>之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是<strong>分别统计参数值相同的请求</strong>，判断是否超过QPS阈值。</p>
<h3 id="241全局参数限流">2.4.1.全局参数限流</h3>
<p>例如，一个根据id查询商品的接口：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716115014663.png"
	width="721"
	height="281"
	srcset="/post/springcloudalibaba/assets/image-20210716115014663_hu00eb799e75f327019efd83195cd335ed_18087_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716115014663_hu00eb799e75f327019efd83195cd335ed_18087_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716115014663"
	
	
		class="gallery-image" 
		data-flex-grow="256"
		data-flex-basis="615px"
	
></p>
<p>访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716115131463.png"
	width="1212"
	height="312"
	srcset="/post/springcloudalibaba/assets/image-20210716115131463_hu3207ac9614294004ffc4cd4059edee60_25697_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716115131463_hu3207ac9614294004ffc4cd4059edee60_25697_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716115131463"
	
	
		class="gallery-image" 
		data-flex-grow="388"
		data-flex-basis="932px"
	
></p>
<p>当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。</p>
<p>配置示例：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716115232426.png"
	width="571"
	height="183"
	srcset="/post/springcloudalibaba/assets/image-20210716115232426_hu8c78119369e063a1427aedf20f13cb96_18482_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716115232426_hu8c78119369e063a1427aedf20f13cb96_18482_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716115232426"
	
	
		class="gallery-image" 
		data-flex-grow="312"
		data-flex-basis="748px"
	
></p>
<p>代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒<strong>相同参数值</strong>的请求数不能超过5</p>
<h3 id="242热点参数限流">2.4.2.热点参数限流</h3>
<p>刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.</p>
<p>而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716115717523.png"
	width="704"
	height="312"
	srcset="/post/springcloudalibaba/assets/image-20210716115717523_hube81ec5c201db6cf8257d19ca18d0c20_45550_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716115717523_hube81ec5c201db6cf8257d19ca18d0c20_45550_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716115717523"
	
	
		class="gallery-image" 
		data-flex-grow="225"
		data-flex-basis="541px"
	
></p>
<p>结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：</p>
<p>•如果参数值是100，则每1秒允许的QPS为10</p>
<p>•如果参数值是101，则每1秒允许的QPS为15</p>
<h3 id="244案例">2.4.4.案例</h3>
<p><strong>案例需求</strong>：给/order/{orderId}这个资源添加热点参数限流，规则如下：</p>
<p>•默认的热点参数规则是每1秒请求量不超过2</p>
<p>•给102这个参数设置例外：每1秒请求量不超过4</p>
<p>•给103这个参数设置例外：每1秒请求量不超过10</p>
<p><strong>注意事项</strong>：热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源</p>
<h4 id="1标记资源">1）标记资源</h4>
<p>给order-service中的OrderController中的/order/{orderId}资源添加注解：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716120033572.png"
	width="1113"
	height="449"
	srcset="/post/springcloudalibaba/assets/image-20210716120033572_hu837edbeb31e526e972da2bbba8b581b7_104429_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716120033572_hu837edbeb31e526e972da2bbba8b581b7_104429_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716120033572"
	
	
		class="gallery-image" 
		data-flex-grow="247"
		data-flex-basis="594px"
	
></p>
<h4 id="2热点参数限流规则">2）热点参数限流规则</h4>
<p>访问该接口，可以看到我们标记的hot资源出现了：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716120208509.png"
	width="830"
	height="210"
	srcset="/post/springcloudalibaba/assets/image-20210716120208509_hu8f5c2855b94b98d52418f2051541329f_14668_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716120208509_hu8f5c2855b94b98d52418f2051541329f_14668_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716120208509"
	
	
		class="gallery-image" 
		data-flex-grow="395"
		data-flex-basis="948px"
	
></p>
<p>这里不要点击hot后面的按钮，页面有BUG</p>
<p>点击左侧菜单中<strong>热点规则</strong>菜单：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716120319009.png"
	width="1914"
	height="645"
	srcset="/post/springcloudalibaba/assets/image-20210716120319009_hu0469d8a57c0e8d30b8c22d83c506979b_156894_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716120319009_hu0469d8a57c0e8d30b8c22d83c506979b_156894_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716120319009"
	
	
		class="gallery-image" 
		data-flex-grow="296"
		data-flex-basis="712px"
	
></p>
<p>点击新增，填写表单：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716120536714.png"
	width="833"
	height="864"
	srcset="/post/springcloudalibaba/assets/image-20210716120536714_hu4ecc3ee1a5cbffe9c7df5617d39ac916_132928_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716120536714_hu4ecc3ee1a5cbffe9c7df5617d39ac916_132928_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716120536714"
	
	
		class="gallery-image" 
		data-flex-grow="96"
		data-flex-basis="231px"
	
></p>
<h4 id="3jmeter测试">3）Jmeter测试</h4>
<p>选择《热点参数限流 QPS1》：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716120754527.png"
	width="900"
	height="308"
	srcset="/post/springcloudalibaba/assets/image-20210716120754527_hue58afdc47fd7d4274acb40037f65b2a0_33038_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716120754527_hue58afdc47fd7d4274acb40037f65b2a0_33038_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716120754527"
	
	
		class="gallery-image" 
		data-flex-grow="292"
		data-flex-basis="701px"
	
></p>
<p>这里发起请求的QPS为5.</p>
<p>包含3个http请求：</p>
<p>普通参数，QPS阈值为2</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716120840501.png"
	width="893"
	height="135"
	srcset="/post/springcloudalibaba/assets/image-20210716120840501_hue0f4e6fb3f998a0749dfd90137a04597_14230_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716120840501_hue0f4e6fb3f998a0749dfd90137a04597_14230_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716120840501"
	
	
		class="gallery-image" 
		data-flex-grow="661"
		data-flex-basis="1587px"
	
></p>
<p>运行结果：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716121105567.png"
	width="639"
	height="462"
	srcset="/post/springcloudalibaba/assets/image-20210716121105567_hub54d8c30fe333380fabd124c4a3a07c0_102744_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716121105567_hub54d8c30fe333380fabd124c4a3a07c0_102744_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716121105567"
	
	
		class="gallery-image" 
		data-flex-grow="138"
		data-flex-basis="331px"
	
></p>
<p>例外项，QPS阈值为4</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716120900365.png"
	width="913"
	height="147"
	srcset="/post/springcloudalibaba/assets/image-20210716120900365_huc8a925eca2b55652f41ec002412141b2_17017_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716120900365_huc8a925eca2b55652f41ec002412141b2_17017_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716120900365"
	
	
		class="gallery-image" 
		data-flex-grow="621"
		data-flex-basis="1490px"
	
></p>
<p>运行结果：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716121201630.png"
	width="686"
	height="331"
	srcset="/post/springcloudalibaba/assets/image-20210716121201630_hu35c68dfbf4e775c866683298f83d54d0_83319_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716121201630_hu35c68dfbf4e775c866683298f83d54d0_83319_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716121201630"
	
	
		class="gallery-image" 
		data-flex-grow="207"
		data-flex-basis="497px"
	
></p>
<p>例外项，QPS阈值为10</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716120919131.png"
	width="800"
	height="148"
	srcset="/post/springcloudalibaba/assets/image-20210716120919131_hu014d7420b65a811f5267db213f5766db_17037_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716120919131_hu014d7420b65a811f5267db213f5766db_17037_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716120919131"
	
	
		class="gallery-image" 
		data-flex-grow="540"
		data-flex-basis="1297px"
	
></p>
<p>运行结果：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716121220305.png"
	width="640"
	height="339"
	srcset="/post/springcloudalibaba/assets/image-20210716121220305_hua66c33754ce3d68c6f9bb324658e391f_81680_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716121220305_hua66c33754ce3d68c6f9bb324658e391f_81680_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716121220305"
	
	
		class="gallery-image" 
		data-flex-grow="188"
		data-flex-basis="453px"
	
></p>
<h1 id="3隔离和降级">3.隔离和降级</h1>
<p>限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。</p>
<p>而要将这些故障控制在一定范围，避免雪崩，就要靠<strong>线程隔离</strong>（舱壁模式）和<strong>熔断降级</strong>手段了。</p>
<p><strong>线程隔离</strong>之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715173215243.png"
	width="765"
	height="419"
	srcset="/post/springcloudalibaba/assets/image-20210715173215243_hua8e5f7fd9833218583c4b8f208f9e6fd_25086_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715173215243_hua8e5f7fd9833218583c4b8f208f9e6fd_25086_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715173215243"
	
	
		class="gallery-image" 
		data-flex-grow="182"
		data-flex-basis="438px"
	
></p>
<p><strong>熔断降级</strong>：是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。</p>
<p><img src="/post/springcloudalibaba/assets/image-20210715173428073.png"
	width="585"
	height="463"
	srcset="/post/springcloudalibaba/assets/image-20210715173428073_hu71eec2b1ffa67c5490e49f031c4d83f3_23263_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210715173428073_hu71eec2b1ffa67c5490e49f031c4d83f3_23263_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210715173428073"
	
	
		class="gallery-image" 
		data-flex-grow="126"
		data-flex-basis="303px"
	
></p>
<p>可以看到，不管是线程隔离还是熔断降级，都是对<strong>客户端</strong>（调用方）的保护。需要在<strong>调用方</strong> 发起远程调用时做线程隔离、或者服务熔断。</p>
<p>而我们的微服务远程调用都是基于Feign来完成的，因此我们需要将Feign与Sentinel整合，在Feign里面实现线程隔离和服务熔断。</p>
<h2 id="31feignclient整合sentinel">3.1.FeignClient整合Sentinel</h2>
<p>SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。</p>
<p>注意: OpenFeign和Sentinel都要使用父POM中spring-cloud-alibaba-dependecies规定好的版本,如果没有锁定版本,那么我们写和spring-cloud-alibaba-dependecies一致版本即可</p>
<h3 id="311修改配置开启sentinel功能">3.1.1.修改配置，开启sentinel功能</h3>
<p>修改OrderService的application.yml文件，开启Feign的Sentinel功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">feign</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sentinel</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 开启feign对sentinel的支持</span>
</span></span></code></pre></div><h3 id="312编写失败降级逻辑">3.1.2.编写失败降级逻辑</h3>
<p>业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。</p>
<p>给FeignClient编写失败后的降级逻辑</p>
<p>①方式一：FallbackClass，无法对远程调用的异常做处理</p>
<p>②方式二：FallbackFactory，可以对远程调用的异常做处理，我们选择这种</p>
<p>这里我们演示方式二的失败降级处理。</p>
<p><strong>步骤一</strong>：在feing-api项目中定义类，实现FallbackFactory：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716122403502.png"
	width="539"
	height="405"
	srcset="/post/springcloudalibaba/assets/image-20210716122403502_hufd715cbeb8b09317c682d8e393b3e2ab_34977_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716122403502_hufd715cbeb8b09317c682d8e393b3e2ab_34977_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716122403502"
	
	
		class="gallery-image" 
		data-flex-grow="133"
		data-flex-basis="319px"
	
></p>
<p>代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> cn.itcast.feign.clients.fallback<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cn.itcast.feign.clients.UserClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cn.itcast.feign.pojo.User<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> feign.hystrix.FallbackFactory<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> lombok.extern.slf4j.Slf4j<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserClientFallbackFactory</span> <span style="color:#66d9ef">implements</span> FallbackFactory<span style="color:#f92672">&lt;</span>UserClient<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> UserClient <span style="color:#a6e22e">create</span><span style="color:#f92672">(</span>Throwable throwable<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> UserClient<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">findById</span><span style="color:#f92672">(</span>Long id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                log<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;查询用户异常&#34;</span><span style="color:#f92672">,</span> throwable<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> User<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>步骤二</strong>：在feing-api项目中的DefaultFeignConfiguration类中将UserClientFallbackFactory注册为一个Bean：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> UserClientFallbackFactory <span style="color:#a6e22e">userClientFallbackFactory</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> UserClientFallbackFactory<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>步骤三</strong>：在feing-api项目中的UserClient接口中使用UserClientFallbackFactory：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> cn.itcast.feign.clients.fallback.UserClientFallbackFactory<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cn.itcast.feign.pojo.User<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.openfeign.FeignClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.PathVariable<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@FeignClient</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;userservice&#34;</span><span style="color:#f92672">,</span> fallbackFactory <span style="color:#f92672">=</span> UserClientFallbackFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">UserClient</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    User <span style="color:#a6e22e">findById</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> Long id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>重启后，访问一次订单查询业务，然后查看sentinel控制台，可以看到新的簇点链路：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716123705780.png"
	width="1036"
	height="392"
	srcset="/post/springcloudalibaba/assets/image-20210716123705780_hud1f6717ed47fdce353bdbe71ea089ca5_86638_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716123705780_hud1f6717ed47fdce353bdbe71ea089ca5_86638_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716123705780"
	
	
		class="gallery-image" 
		data-flex-grow="264"
		data-flex-basis="634px"
	
></p>
<h3 id="313总结">3.1.3.总结</h3>
<p>Sentinel支持的雪崩解决方案：</p>
<ul>
<li>线程隔离（仓壁模式）</li>
<li>降级熔断</li>
</ul>
<p>Feign整合Sentinel的步骤：</p>
<ul>
<li>在application.yml中配置：feign.sentienl.enable=true</li>
<li>给FeignClient编写FallbackFactory并注册为Bean</li>
<li>将FallbackFactory配置到FeignClient</li>
</ul>
<h2 id="32线程隔离舱壁模式">3.2.线程隔离（舱壁模式）</h2>
<h3 id="321线程隔离的实现方式">3.2.1.线程隔离的实现方式</h3>
<p>线程隔离有两种方式实现：</p>
<ul>
<li>线程池隔离</li>
<li>信号量隔离（Sentinel默认采用）</li>
</ul>
<p>如图：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716123036937.png"
	width="929"
	height="776"
	srcset="/post/springcloudalibaba/assets/image-20210716123036937_hud5b13e1c25afd351a30d2dc6f5c0f698_78624_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716123036937_hud5b13e1c25afd351a30d2dc6f5c0f698_78624_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716123036937"
	
	
		class="gallery-image" 
		data-flex-grow="119"
		data-flex-basis="287px"
	
></p>
<p><strong>线程池隔离</strong>：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果</p>
<p><strong>信号量隔离</strong>：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。</p>
<p>两者的优缺点：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716123240518.png"
	width="1425"
	height="710"
	srcset="/post/springcloudalibaba/assets/image-20210716123240518_hu53a8ad44802477bb609dd783aad66433_137013_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716123240518_hu53a8ad44802477bb609dd783aad66433_137013_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716123240518"
	
	
		class="gallery-image" 
		data-flex-grow="200"
		data-flex-basis="481px"
	
></p>
<h3 id="322sentinel的线程隔离">3.2.2.sentinel的线程隔离</h3>
<p><strong>用法说明</strong>：</p>
<p>在添加限流规则时，可以选择两种阈值类型：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716123411217.png"
	width="702"
	height="218"
	srcset="/post/springcloudalibaba/assets/image-20210716123411217_hu90bd96cd92badd679af68469c937d995_27906_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716123411217_hu90bd96cd92badd679af68469c937d995_27906_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716123411217"
	
	
		class="gallery-image" 
		data-flex-grow="322"
		data-flex-basis="772px"
	
></p>
<ul>
<li>QPS：就是每秒的请求数，在快速入门中已经演示过</li>
<li>线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现<strong>线程隔离</strong>（舱壁模式）。</li>
</ul>
<p><strong>案例需求</strong>：给 order-service服务中的UserClient的查询用户接口设置流控规则，线程数不能超过 2。然后利用jemeter测试。</p>
<h4 id="1配置隔离规则">1）配置隔离规则</h4>
<p>选择feign接口后面的流控按钮：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716123831992.png"
	width="1364"
	height="204"
	srcset="/post/springcloudalibaba/assets/image-20210716123831992_hu0dd8bfcbe00f09278d44702c71b9f404_38683_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716123831992_hu0dd8bfcbe00f09278d44702c71b9f404_38683_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716123831992"
	
	
		class="gallery-image" 
		data-flex-grow="668"
		data-flex-basis="1604px"
	
></p>
<p>填写表单：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716123936844.png"
	width="838"
	height="487"
	srcset="/post/springcloudalibaba/assets/image-20210716123936844_hu9313880292953fcb4630224b423a5a44_69160_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716123936844_hu9313880292953fcb4630224b423a5a44_69160_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716123936844"
	
	
		class="gallery-image" 
		data-flex-grow="172"
		data-flex-basis="412px"
	
></p>
<h4 id="2jmeter测试-2">2）Jmeter测试</h4>
<p>选择《阈值类型-线程数&lt;2》：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716124229894.png"
	width="981"
	height="307"
	srcset="/post/springcloudalibaba/assets/image-20210716124229894_hua69cc7f02a92028f48b81c2b236f0343_33305_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716124229894_hua69cc7f02a92028f48b81c2b236f0343_33305_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716124229894"
	
	
		class="gallery-image" 
		data-flex-grow="319"
		data-flex-basis="766px"
	
></p>
<p>一次发生10个请求，有较大概率并发线程数超过2，而超出的请求会走之前定义的失败降级逻辑。</p>
<p>查看运行结果：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716124147820.png"
	width="1059"
	height="369"
	srcset="/post/springcloudalibaba/assets/image-20210716124147820_hua4825203170a038de306072cebf58249_127421_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716124147820_hua4825203170a038de306072cebf58249_127421_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716124147820"
	
	
		class="gallery-image" 
		data-flex-grow="286"
		data-flex-basis="688px"
	
></p>
<p>发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的null信息。</p>
<h3 id="323总结">3.2.3.总结</h3>
<p>线程隔离的两种手段是？</p>
<ul>
<li>信号量隔离</li>
<li>线程池隔离</li>
</ul>
<p>信号量隔离的特点是？</p>
<ul>
<li>基于计数器模式，简单，开销小</li>
</ul>
<p>线程池隔离的特点是？</p>
<ul>
<li>基于线程池模式，有额外开销，但隔离控制更强</li>
</ul>
<h2 id="33熔断降级">3.3.熔断降级</h2>
<p>熔断降级是解决雪崩问题的重要手段。其思路是由<strong>断路器</strong>统计服务调用的异常比例、慢请求比例，如果超出阈值则会<strong>熔断</strong>该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。</p>
<p>断路器控制熔断和放行是通过状态机来完成的：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716130958518.png"
	width="1421"
	height="474"
	srcset="/post/springcloudalibaba/assets/image-20210716130958518_hu051ee21e2da3e5c7edb0ecb816caba45_44379_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716130958518_hu051ee21e2da3e5c7edb0ecb816caba45_44379_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716130958518"
	
	
		class="gallery-image" 
		data-flex-grow="299"
		data-flex-basis="719px"
	
></p>
<p>状态机包括三个状态：</p>
<ul>
<li>closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态</li>
<li>open：打开状态，服务调用被<strong>熔断</strong>，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态</li>
<li>half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。
<ul>
<li>请求成功：则切换到closed状态</li>
<li>请求失败：则切换到open状态</li>
</ul>
</li>
</ul>
<p>断路器熔断策略有三种：慢调用、异常比例、异常数</p>
<h3 id="331慢调用">3.3.1.慢调用</h3>
<p><strong>慢调用</strong>：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。</p>
<p>例如：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716145934347.png"
	width="673"
	height="284"
	srcset="/post/springcloudalibaba/assets/image-20210716145934347_huc34eb2d44bf6ee0418ad4d80a1c35d4d_43132_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716145934347_huc34eb2d44bf6ee0418ad4d80a1c35d4d_43132_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716145934347"
	
	
		class="gallery-image" 
		data-flex-grow="236"
		data-flex-basis="568px"
	
></p>
<p>解读：RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。</p>
<p><strong>案例</strong></p>
<p>需求：给 UserClient的查询用户接口设置降级规则，慢调用的RT阈值为50ms，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5</p>
<h4 id="1设置慢调用">1）设置慢调用</h4>
<p>修改user-service中的/user/{id}这个接口的业务。通过休眠模拟一个延迟时间：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716150234787.png"
	width="925"
	height="353"
	srcset="/post/springcloudalibaba/assets/image-20210716150234787_hu904d744a9e99d79881aae455f5dcf96a_111177_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716150234787_hu904d744a9e99d79881aae455f5dcf96a_111177_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716150234787"
	
	
		class="gallery-image" 
		data-flex-grow="262"
		data-flex-basis="628px"
	
></p>
<p>此时，orderId=101的订单，关联的是id为1的用户，调用时长为60ms：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716150510956.png"
	width="1677"
	height="894"
	srcset="/post/springcloudalibaba/assets/image-20210716150510956_hu39ed10b4e71934df416c976d60fc35ec_199096_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716150510956_hu39ed10b4e71934df416c976d60fc35ec_199096_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716150510956"
	
	
		class="gallery-image" 
		data-flex-grow="187"
		data-flex-basis="450px"
	
></p>
<p>orderId=102的订单，关联的是id为2的用户，调用时长为非常短；</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716150605208.png"
	width="1695"
	height="901"
	srcset="/post/springcloudalibaba/assets/image-20210716150605208_hu4b65fa7fd79bd290d219a8715809280b_216179_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716150605208_hu4b65fa7fd79bd290d219a8715809280b_216179_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716150605208"
	
	
		class="gallery-image" 
		data-flex-grow="188"
		data-flex-basis="451px"
	
></p>
<h4 id="2设置熔断规则">2）设置熔断规则</h4>
<p>下面，给feign接口设置降级规则：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716150654094.png"
	width="1542"
	height="122"
	srcset="/post/springcloudalibaba/assets/image-20210716150654094_hu29d54801e160f5b553b2934cddd7d637_33658_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716150654094_hu29d54801e160f5b553b2934cddd7d637_33658_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716150654094"
	
	
		class="gallery-image" 
		data-flex-grow="1263"
		data-flex-basis="3033px"
	
></p>
<p>规则：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716150740434.png"
	width="833"
	height="422"
	srcset="/post/springcloudalibaba/assets/image-20210716150740434_hu2b2c2933dd33cc3f39f6d5d49cd3a444_66187_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716150740434_hu2b2c2933dd33cc3f39f6d5d49cd3a444_66187_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716150740434"
	
	
		class="gallery-image" 
		data-flex-grow="197"
		data-flex-basis="473px"
	
></p>
<p>超过50ms的请求都会被认为是慢请求</p>
<h4 id="3测试">3）测试</h4>
<p>在浏览器访问：http://localhost:8088/order/101，快速刷新5次，可以发现：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716150911004.png"
	width="1715"
	height="888"
	srcset="/post/springcloudalibaba/assets/image-20210716150911004_hu230e24068babafc01541b46336f9e303_203407_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716150911004_hu230e24068babafc01541b46336f9e303_203407_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716150911004"
	
	
		class="gallery-image" 
		data-flex-grow="193"
		data-flex-basis="463px"
	
></p>
<p>触发了熔断，请求时长缩短至5ms，快速失败了，并且走降级逻辑，返回的null</p>
<p>在浏览器访问：http://localhost:8088/order/102，竟然也被熔断了：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716151107785.png"
	width="1685"
	height="841"
	srcset="/post/springcloudalibaba/assets/image-20210716151107785_hu9e046f8e4e609276a235f70f0913cc88_193483_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716151107785_hu9e046f8e4e609276a235f70f0913cc88_193483_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716151107785"
	
	
		class="gallery-image" 
		data-flex-grow="200"
		data-flex-basis="480px"
	
></p>
<h3 id="332异常比例异常数">3.3.2.异常比例、异常数</h3>
<p><strong>异常比例或异常数</strong>：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。</p>
<p>例如，一个异常比例设置：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716131430682.png"
	width="511"
	height="247"
	srcset="/post/springcloudalibaba/assets/image-20210716131430682_hue5ddb60fb6d7d56e7a4d305717ce4e5c_29522_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716131430682_hue5ddb60fb6d7d56e7a4d305717ce4e5c_29522_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716131430682"
	
	
		class="gallery-image" 
		data-flex-grow="206"
		data-flex-basis="496px"
	
></p>
<p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。</p>
<p>一个异常数设置：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716131522912.png"
	width="521"
	height="247"
	srcset="/post/springcloudalibaba/assets/image-20210716131522912_hu845c2d28b94861479b029c9316118fbf_28787_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716131522912_hu845c2d28b94861479b029c9316118fbf_28787_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716131522912"
	
	
		class="gallery-image" 
		data-flex-grow="210"
		data-flex-basis="506px"
	
></p>
<p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于2次，则触发熔断。</p>
<p><strong>案例</strong></p>
<p>需求：给 UserClient的查询用户接口设置降级规则，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5s</p>
<h4 id="1设置异常请求">1）设置异常请求</h4>
<p>首先，修改user-service中的/user/{id}这个接口的业务。手动抛出异常，以触发异常比例的熔断：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716151348183.png"
	width="926"
	height="330"
	srcset="/post/springcloudalibaba/assets/image-20210716151348183_hucb5797d91aa04452585450b7b078e881_128469_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716151348183_hucb5797d91aa04452585450b7b078e881_128469_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716151348183"
	
	
		class="gallery-image" 
		data-flex-grow="280"
		data-flex-basis="673px"
	
></p>
<p>也就是说，id 为 2时，就会触发异常</p>
<h4 id="2设置熔断规则-1">2）设置熔断规则</h4>
<p>下面，给feign接口设置降级规则：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716150654094.png"
	width="1542"
	height="122"
	srcset="/post/springcloudalibaba/assets/image-20210716150654094_hu29d54801e160f5b553b2934cddd7d637_33658_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716150654094_hu29d54801e160f5b553b2934cddd7d637_33658_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716150654094"
	
	
		class="gallery-image" 
		data-flex-grow="1263"
		data-flex-basis="3033px"
	
></p>
<p>规则：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716151538785.png"
	width="835"
	height="484"
	srcset="/post/springcloudalibaba/assets/image-20210716151538785_huef9f7524952156e3010e7e6a82573849_70047_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716151538785_huef9f7524952156e3010e7e6a82573849_70047_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716151538785"
	
	
		class="gallery-image" 
		data-flex-grow="172"
		data-flex-basis="414px"
	
></p>
<p>在5次请求中，只要异常比例超过0.4，也就是有2次以上的异常，就会触发熔断。</p>
<h4 id="3测试-1">3）测试</h4>
<p>在浏览器快速访问：http://localhost:8088/order/102，快速刷新5次，触发熔断：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716151722916.png"
	width="1647"
	height="845"
	srcset="/post/springcloudalibaba/assets/image-20210716151722916_hu55c19ca03eae7d4515331aa41ba69e40_179980_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716151722916_hu55c19ca03eae7d4515331aa41ba69e40_179980_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716151722916"
	
	
		class="gallery-image" 
		data-flex-grow="194"
		data-flex-basis="467px"
	
></p>
<p>此时，我们去访问本来应该正常的103：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716151844817.png"
	width="1692"
	height="776"
	srcset="/post/springcloudalibaba/assets/image-20210716151844817_hu9967256f8ea1b0e9973e4c70fe677bb9_197884_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716151844817_hu9967256f8ea1b0e9973e4c70fe677bb9_197884_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716151844817"
	
	
		class="gallery-image" 
		data-flex-grow="218"
		data-flex-basis="523px"
	
></p>
<h1 id="4授权规则">4.授权规则</h1>
<p>授权规则可以对请求方来源做判断和控制。</p>
<h2 id="41授权规则">4.1.授权规则</h2>
<h3 id="411基本规则">4.1.1.基本规则</h3>
<p>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。</p>
<ul>
<li>白名单：来源（origin）在白名单内的调用者允许访问</li>
<li>黑名单：来源（origin）在黑名单内的调用者不允许访问</li>
</ul>
<p>点击左侧菜单的授权，可以看到授权规则：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716152010750.png"
	width="672"
	height="171"
	srcset="/post/springcloudalibaba/assets/image-20210716152010750_hu141f8f117ad316ecf7ea2db50c61f5c2_26953_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716152010750_hu141f8f117ad316ecf7ea2db50c61f5c2_26953_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716152010750"
	
	
		class="gallery-image" 
		data-flex-grow="392"
		data-flex-basis="943px"
	
></p>
<ul>
<li>资源名：就是受保护的资源，例如/order/{orderId}</li>
<li>流控应用：是来源者的名单，
<ul>
<li>如果是勾选白名单，则名单中的来源被许可访问。</li>
<li>如果是勾选黑名单，则名单中的来源被禁止访问。</li>
</ul>
</li>
</ul>
<p>比如：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716152349191.png"
	width="901"
	height="244"
	srcset="/post/springcloudalibaba/assets/image-20210716152349191_hue2615d099a6f05c918957fbae9c5c93d_23686_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716152349191_hue2615d099a6f05c918957fbae9c5c93d_23686_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716152349191"
	
	
		class="gallery-image" 
		data-flex-grow="369"
		data-flex-basis="886px"
	
></p>
<p>我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写<strong>网关的来源名称（origin）</strong>。</p>
<h3 id="412如何获取origin">4.1.2.如何获取origin</h3>
<p>Sentinel是通过RequestOriginParser这个接口的parseOrigin来获取请求的来源的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">RequestOriginParser</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 从请求request对象中获取origin，获取方式自定义
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    String <span style="color:#a6e22e">parseOrigin</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>这个方法的作用就是从request对象中，获取请求者的origin值并返回。</p>
<p>默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。</p>
<p>因此，我们需要自定义这个接口的实现，让<strong>不同的请求，返回不同的origin</strong>。</p>
<p>例如order-service服务中，我们定义一个RequestOriginParser的实现类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> cn.itcast.order.sentinel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.stereotype.Component<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.util.StringUtils<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.servlet.http.HttpServletRequest<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HeaderOriginParser</span> <span style="color:#66d9ef">implements</span> RequestOriginParser <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">parseOrigin</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1.获取请求头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        String origin <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;origin&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2.非空判断
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>origin<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            origin <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blank&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> origin<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>我们会尝试从request-header中获取origin值。</p>
<h3 id="413给网关添加请求头">4.1.3.给网关添加请求头</h3>
<p>既然获取请求origin的方式是从reques-header中获取origin值，我们必须让<strong>所有从gateway路由到微服务的请求都带上origin头</strong>。</p>
<p>这个需要利用之前学习的一个GatewayFilter来实现，AddRequestHeaderGatewayFilter。</p>
<p>修改gateway服务中的application.yml，添加一个defaultFilter：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gateway</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">default-filters</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">AddRequestHeader=origin,gateway</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#75715e"># ...略</span>
</span></span></code></pre></div><p>这样，从gateway路由的所有请求都会带上origin头，值为gateway。而从其它地方到达微服务的请求则没有这个头。</p>
<h3 id="414配置授权规则">4.1.4.配置授权规则</h3>
<p>接下来，我们添加一个授权规则，放行origin值为gateway的请求。</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716153250134.png"
	width="1570"
	height="155"
	srcset="/post/springcloudalibaba/assets/image-20210716153250134_hu3a770f43c416c28e7cd8cece4ca81e84_54747_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716153250134_hu3a770f43c416c28e7cd8cece4ca81e84_54747_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716153250134"
	
	
		class="gallery-image" 
		data-flex-grow="1012"
		data-flex-basis="2430px"
	
></p>
<p>配置如下：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716153301069.png"
	width="698"
	height="172"
	srcset="/post/springcloudalibaba/assets/image-20210716153301069_hu7b28629acdd89b5d839adcc52e4f07f8_20763_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716153301069_hu7b28629acdd89b5d839adcc52e4f07f8_20763_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716153301069"
	
	
		class="gallery-image" 
		data-flex-grow="405"
		data-flex-basis="973px"
	
></p>
<p>现在，我们直接跳过网关，访问order-service服务：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716153348396.png"
	width="724"
	height="155"
	srcset="/post/springcloudalibaba/assets/image-20210716153348396_hu7b5321fdc4956a1c66dc059fa57d7ff4_41332_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716153348396_hu7b5321fdc4956a1c66dc059fa57d7ff4_41332_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716153348396"
	
	
		class="gallery-image" 
		data-flex-grow="467"
		data-flex-basis="1121px"
	
></p>
<p>通过网关访问：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716153434095.png"
	width="857"
	height="458"
	srcset="/post/springcloudalibaba/assets/image-20210716153434095_huebc9b5f8edfab3213b221dfaef028b2c_95857_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716153434095_huebc9b5f8edfab3213b221dfaef028b2c_95857_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716153434095"
	
	
		class="gallery-image" 
		data-flex-grow="187"
		data-flex-basis="449px"
	
></p>
<h2 id="42自定义异常结果">4.2.自定义异常结果</h2>
<p>默认情况下，发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是flow limmiting（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。</p>
<h3 id="421异常类型">4.2.1.异常类型</h3>
<p>而如果要自定义异常时的返回结果，需要实现BlockExceptionHandler接口：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">BlockExceptionHandler</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> HttpServletResponse response<span style="color:#f92672">,</span> BlockException e<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>这个方法有三个参数：</p>
<ul>
<li>HttpServletRequest request：request对象</li>
<li>HttpServletResponse response：response对象</li>
<li>BlockException e：被sentinel拦截时抛出的异常</li>
</ul>
<p>这里的BlockException包含多个不同的子类：</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th><strong>异常</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>FlowException</td>
<td>限流异常</td>
</tr>
<tr>
<td>ParamFlowException</td>
<td>热点参数限流的异常</td>
</tr>
<tr>
<td>DegradeException</td>
<td>降级异常</td>
</tr>
<tr>
<td>AuthorityException</td>
<td>授权规则异常</td>
</tr>
<tr>
<td>SystemBlockException</td>
<td>系统规则异常</td>
</tr>
</tbody>
</table></div>
<h3 id="422自定义异常处理">4.2.2.自定义异常处理</h3>
<p>下面，我们就在order-service定义一个自定义异常处理类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SentinelExceptionHandler</span> <span style="color:#66d9ef">implements</span> BlockExceptionHandler <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> HttpServletResponse response<span style="color:#f92672">,</span> BlockException e<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        String msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;未知异常&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> status <span style="color:#f92672">=</span> <span style="color:#ae81ff">429</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>e <span style="color:#66d9ef">instanceof</span> FlowException<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;请求被限流了&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>e <span style="color:#66d9ef">instanceof</span> ParamFlowException<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;请求被热点参数限流&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>e <span style="color:#66d9ef">instanceof</span> DegradeException<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;请求被降级了&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>e <span style="color:#66d9ef">instanceof</span> AuthorityException<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;没有权限访问&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            status <span style="color:#f92672">=</span> <span style="color:#ae81ff">401</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">setContentType</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;application/json;charset=utf-8&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">setStatus</span><span style="color:#f92672">(</span>status<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;{\&#34;msg\&#34;: &#34;</span> <span style="color:#f92672">+</span> msg <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, \&#34;status\&#34;: &#34;</span> <span style="color:#f92672">+</span> status <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;}&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>重启测试，在不同场景下，会返回不同的异常消息.</p>
<p>限流：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716153938887.png"
	width="556"
	height="167"
	srcset="/post/springcloudalibaba/assets/image-20210716153938887_hu7e41aa86c9e1f26dc227485feab761e4_29456_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716153938887_hu7e41aa86c9e1f26dc227485feab761e4_29456_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716153938887"
	
	
		class="gallery-image" 
		data-flex-grow="332"
		data-flex-basis="799px"
	
></p>
<p>授权拦截时：</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716154012736.png"
	width="601"
	height="153"
	srcset="/post/springcloudalibaba/assets/image-20210716154012736_hu9cdc9126e800c68174efc3bccd715f5e_32765_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716154012736_hu9cdc9126e800c68174efc3bccd715f5e_32765_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716154012736"
	
	
		class="gallery-image" 
		data-flex-grow="392"
		data-flex-basis="942px"
	
></p>
<h1 id="5规则持久化">5.规则持久化</h1>
<p>现在，sentinel的所有规则都是内存存储，重启后所有规则都会丢失。在生产环境下，我们必须确保这些规则的持久化，避免丢失。</p>
<h2 id="51规则管理模式">5.1.规则管理模式</h2>
<p>规则是否能持久化，取决于规则管理模式，sentinel支持三种规则管理模式：</p>
<ul>
<li>原始模式：Sentinel的默认模式，将规则保存在内存，重启服务会丢失。</li>
<li>pull模式</li>
<li>push模式</li>
</ul>
<h3 id="511pull模式">5.1.1.pull模式</h3>
<p>pull模式：控制台将配置的规则推送到Sentinel客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716154155238.png"
	width="932"
	height="276"
	srcset="/post/springcloudalibaba/assets/image-20210716154155238_hu6696237cfb1e3162682b10ae6c8abd00_45511_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716154155238_hu6696237cfb1e3162682b10ae6c8abd00_45511_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716154155238"
	
	
		class="gallery-image" 
		data-flex-grow="337"
		data-flex-basis="810px"
	
></p>
<h3 id="512push模式">5.1.2.push模式</h3>
<p>push模式：控制台将配置规则推送到远程配置中心，例如Nacos。Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置更新。</p>
<p><img src="/post/springcloudalibaba/assets/image-20210716154215456.png"
	width="754"
	height="441"
	srcset="/post/springcloudalibaba/assets/image-20210716154215456_hu1d36d9d7ceae178286568795434b184b_57459_480x0_resize_box_3.png 480w, /post/springcloudalibaba/assets/image-20210716154215456_hu1d36d9d7ceae178286568795434b184b_57459_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210716154215456"
	
	
		class="gallery-image" 
		data-flex-grow="170"
		data-flex-basis="410px"
	
></p>
<h2 id="52实现push模式">5.2.实现push模式</h2>
<p>详细步骤可以参考课后资料的《sentinel规则持久化》</p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

     
    
        
    <div class="disqus-container">
    
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2023 Cheney Site
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.17.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/ribbon.min.js"
    integrity="sha384-UEK8ZiP3VgFNP8KnKMKDmd4pAUAOJ59Y2Jo3ED2Z5qKQf6HLHovMxq7Beb9CLPUe"
    crossorigin="anonymous"
    size="300"
    alpha="0.6"
    zindex="-1"
    defer
></script>

<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/nprogress.min.js"
    integrity="sha384-bHDlAEUFxsRI7JfULv3DTpL2IXbbgn4JHQJibgo5iiXSK6Iu8muwqHANhun74Cqg"
    crossorigin="anonymous"
></script>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/css/nprogress.css"
    integrity="sha384-KJyhr2syt5+4M9Pz5dipCvTrtvOmLk/olWVdfhAp858UCa64Ia5GFpTN7+G4BWpE"
    crossorigin="anonymous"
/>
<script>
    NProgress.start();
    document.addEventListener("readystatechange", () => {
        if (document.readyState === "interactive") NProgress.inc(0.8);
        if (document.readyState === "complete") NProgress.done();
    });
</script>
    </body>
</html>
